<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MedWorkLog Ver.4.5.1</title>
    
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/js/all.min.js"></script>
    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; }
        .btn-press { transition: transform 0.1s; }
        .btn-press:active { transform: scale(0.95); }
        .card { background: white; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 50; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 2% auto; padding: 20px; border: 1px solid #888; width: 95%; max-width: 900px; border-radius: 10px; max-height: 95vh; overflow-y: auto; }
        
        /* Helpers */
        .blink-red { animation: blinker 2s linear infinite; color: red; font-weight: bold; }
        @keyframes blinker { 50% { opacity: 0.5; } }
        .disabled-area { opacity: 0.4; pointer-events: none; }
        .rate-badge { font-size: 0.7em; padding: 1px 3px; border-radius: 3px; background: #fee2e2; color: #991b1b; border: 1px solid #f87171; margin-left: 4px; }
        
        /* Activity Selection Highlight */
        .activity-selected { background-color: #3b82f6 !important; color: white !important; font-weight: bold; border-color: #2563eb !important; }
        
        /* Log List Items */
        .log-item { position: relative; }
        .log-item:hover .edit-btns { display: flex; }
        .edit-btns { display: none; }
        
        /* Print */
        @media print {
            body { background: white; color: black; }
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            .modal { position: static; background: none; width: 100%; height: auto; overflow: visible; }
            .modal-content { width: 100%; max-width: 100%; margin: 0; padding: 0; border: none; box-shadow: none; max-height: none; }
            table { width: 100%; border-collapse: collapse; font-size: 10px; }
            th, td { border: 1px solid #000; padding: 4px; }
            .report-summary-box { border: 2px solid #000; padding: 10px; margin-bottom: 10px; }
        }
        .print-only { display: none; }
        .report-table { width: 100%; border-collapse: collapse; font-size: 11px; }
        .report-table th, .report-table td { border: 1px solid #ccc; padding: 4px; text-align: center; }
        .report-table th { background-color: #f0f0f0; font-weight: bold; }
        .report-table td.text-left { text-align: left; }
        .report-table td.text-right { text-align: right; }
        .report-table tr.holiday-row { background-color: #fff0f0; }
        .report-summary { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .report-box { border: 1px solid #ccc; padding: 10px; border-radius: 4px; background: #fff; }
        
        /* Mobile Work Indicator */
        .mobile-work-active { background-color: #fffbeb; border-color: #f59e0b; }
    </style>
</head>
<body class="pb-24">

    <header class="bg-indigo-900 text-white p-4 sticky top-0 z-30 shadow-md flex justify-between items-center no-print">
        <div onclick="initGeoLocation()" class="cursor-pointer">
            <h1 class="text-lg font-bold"><i class="fas fa-user-md mr-2"></i>勤務実態記録 v4.5</h1>
            <div class="flex items-center gap-2">
                <p class="text-xs opacity-80" id="current-status-text">タップしてGPS再開</p>
                <div id="gps-debug-info" class="text-[10px] bg-indigo-800 px-1 rounded hidden"></div>
            </div>
        </div>
        <div class="flex gap-2">
            <button onclick="openPastWork()" class="bg-indigo-800 text-white p-2 rounded hover:bg-indigo-700" title="過去勤務"><i class="fas fa-calendar-plus fa-lg"></i></button>
            <button onclick="openManualLog()" class="bg-indigo-800 text-white p-2 rounded hover:bg-indigo-700" title="手動ログ"><i class="fas fa-plus-circle fa-lg"></i></button>
            <button onclick="openReport()" class="bg-red-600 text-white p-2 rounded hover:bg-red-700 shadow-lg font-bold" title="レポート"><i class="fas fa-file-invoice-dollar fa-lg"></i></button>
            <button onclick="openSettings()" class="bg-indigo-800 text-white p-2 rounded hover:bg-indigo-700" title="設定"><i class="fas fa-cog fa-lg"></i></button>
        </div>
    </header>

    <main class="p-4 space-y-4">

        <div class="card p-4 border-l-4 border-gray-400" id="status-card">
            <div class="flex justify-between items-start">
                <div>
                    <h2 class="text-sm text-gray-500 font-bold">現在地・勤務状況</h2>
                    <div class="text-2xl font-bold mt-1" id="location-status">院外 / OFF</div>
                    <div class="text-sm text-gray-600 mt-1 font-mono" id="clock-display">--:--:--</div>
                    <div class="text-xs text-gray-400 mt-1" id="session-info">現在セッション: なし</div>
                </div>
                <div class="text-right">
                    <button onclick="manualToggleEntry()" id="manual-entry-btn" class="bg-green-600 text-white px-4 py-2 rounded shadow btn-press font-bold text-xs">
                        手動入館
                    </button>
                </div>
            </div>
            <div class="mt-3 pt-3 border-t border-gray-100">
                <label class="text-xs text-gray-500 block mb-1 font-bold">本日のシフト</label>
                <select id="daily-shift-select" onchange="updateShiftSelection()" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded focus:ring-blue-500 focus:border-blue-500 block p-2">
                    <option value="day">日勤 (8:30-17:15)</option>
                    <option value="semi">準夜 (13:15-22:00)</option>
                    <option value="night">夜勤 (17:15-翌09:45)</option>
                    <option value="holiday">休日出勤 (シフトなし)</option>
                </select>
            </div>
        </div>

        <div class="card p-4 border-l-4 border-indigo-600">
            <h2 class="text-sm text-indigo-900 font-bold mb-3 border-b pb-2"><i class="fas fa-balance-scale mr-2"></i>今月の待遇損益 (管理職 vs 一般職)</h2>
            <div class="grid grid-cols-2 gap-4 text-center mb-4">
                <div class="bg-gray-50 p-2 rounded">
                    <div class="text-xs text-gray-500">A. 現状の支給予定</div>
                    <div class="text-lg font-bold text-blue-600" id="month-actual-pay">¥0</div>
                    <div class="text-[10px] text-gray-400">管理職手当+固定手当</div>
                </div>
                <div class="bg-gray-50 p-2 rounded">
                    <div class="text-xs text-gray-500">B. 本来の残業代</div>
                    <div class="text-lg font-bold text-green-600" id="month-legal-pay">¥0</div>
                    <div class="text-[10px] text-gray-400">法廷割増(60h超対応)</div>
                </div>
            </div>
            <div class="bg-indigo-50 border border-indigo-100 p-3 rounded text-center">
                <div class="text-xs font-bold text-indigo-800 mb-1">差額判定 (A - B)</div>
                <div class="text-3xl font-extrabold" id="month-balance">¥0</div>
                <div class="text-xs mt-1" id="month-balance-text">計算中...</div>
            </div>
        </div>

        <div class="card p-4 border-l-4 border-red-500">
            <div class="flex justify-between items-center mb-2">
                <h2 class="text-sm text-gray-500 font-bold"><i class="fas fa-calculator mr-2"></i>本日の詳細</h2>
                <button onclick="openDetailModal()" class="text-xs bg-gray-100 text-gray-600 border px-3 py-1 rounded hover:bg-gray-200 shadow-sm">
                    <i class="fas fa-copy mr-1"></i>詳細・コピー
                </button>
            </div>
            <div class="grid grid-cols-2 gap-4 mb-3">
                <div class="border rounded p-2 bg-gray-50">
                    <div class="text-xs text-gray-500">実働 / 残業</div>
                    <div class="text-lg font-bold"><span id="today-work-hours">0.0h</span> / <span id="today-ot-hours" class="text-red-600">0.0h</span></div>
                </div>
                <div class="border rounded p-2 bg-blue-50">
                    <div class="text-xs text-blue-600">固定手当(本日)</div>
                    <div class="text-lg font-bold text-blue-600" id="today-fixed-allowance">¥0</div>
                </div>
            </div>
            <div class="mt-2 text-xs text-gray-400 text-right" id="calc-breakdown">データ待機中...</div>
        </div>

        <div class="card p-4">
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-sm text-gray-500 font-bold">残業分析グラフ</h2>
                <div class="flex bg-gray-200 rounded p-0.5 mb-2 w-fit">
                    <button onclick="updateChartRange('7d')" class="text-[10px] px-2 py-1 rounded bg-white shadow-sm" id="btn-7d">7日</button>
                    <button onclick="updateChartRange('1m')" class="text-[10px] px-2 py-1 rounded text-gray-500" id="btn-1m">1ヶ月</button>
                    <button onclick="updateChartRange('3m')" class="text-[10px] px-2 py-1 rounded text-gray-500" id="btn-3m">3ヶ月</button>
                </div>
            </div>
            
            <div class="mb-6">
                <h3 class="text-xs font-bold text-gray-600 mb-1"><i class="fas fa-clock mr-1"></i>時間外・区分別積上げ (時間)</h3>
                <div class="relative w-full h-48">
                    <canvas id="hoursChart"></canvas>
                </div>
            </div>
            
            <div>
                <h3 class="text-xs font-bold text-gray-600 mb-1"><i class="fas fa-yen-sign mr-1"></i>給与・積算 (円)</h3>
                <div class="relative w-full h-48">
                    <canvas id="payChart"></canvas>
                </div>
            </div>
        </div>

        <div class="card p-4">
            <div class="flex justify-between items-center mb-2">
                <h2 class="text-sm text-gray-500 font-bold">直近ログ</h2>
                <div class="flex gap-2">
                    <button onclick="viewDailyDetail()" class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded hover:bg-blue-200"><i class="fas fa-calendar-day mr-1"></i>詳細</button>
                    <button onclick="exportCSV()" class="text-xs bg-gray-200 px-2 py-1 rounded hover:bg-gray-300"><i class="fas fa-file-csv mr-1"></i>CSV</button>
                </div>
            </div>
            <div id="log-container" class="text-xs space-y-2 max-h-60 overflow-y-auto font-mono"></div>
        </div>

    </main>

    <div id="pastWorkModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <h2 class="text-lg font-bold mb-4"><i class="fas fa-calendar-plus mr-2"></i>過去の記録入力</h2>
            <div class="space-y-3">
                <div><label class="block text-sm font-bold">日付</label><input type="date" id="past-date" class="w-full border p-2 rounded"></div>
                <div><label class="block text-sm font-bold">シフト種別</label>
                    <select id="past-shift" class="w-full border p-2 rounded" onchange="updatePastWorkPreview()">
                        <option value="day">日勤 (8:30-17:15)</option>
                        <option value="semi">準夜 (13:15-22:00)</option>
                        <option value="night">夜勤 (17:15-翌09:45)</option>
                        <option value="holiday">休日出勤</option>
                        <option value="off" class="text-green-600 font-bold">完全休日 (勤務なし)</option>
                    </select>
                </div>
                <div id="past-work-inputs">
                    <div class="grid grid-cols-2 gap-2">
                        <div><label class="block text-sm font-bold">出勤時刻</label><input type="time" id="past-start" class="w-full border p-2 rounded" onchange="updatePastWorkPreview()"></div>
                        <div><label class="block text-sm font-bold">退勤時刻</label><input type="time" id="past-end" class="w-full border p-2 rounded" onchange="updatePastWorkPreview()"></div>
                    </div>
                    <div class="mt-2"><label class="flex items-center text-sm cursor-pointer"><input type="checkbox" id="past-no-break" class="mr-2" onchange="updatePastWorkPreview()"><span class="text-red-600 font-bold">休憩なし (常時待機)</span></label></div>
                    <div id="past-break-input" class="grid grid-cols-2 gap-2 mt-2">
                        <div><label class="block text-sm font-bold">休憩開始</label><input type="time" id="past-break-start" class="w-full border p-2 rounded" onchange="updatePastWorkPreview()"></div>
                        <div><label class="block text-sm font-bold">休憩終了</label><input type="time" id="past-break-end" class="w-full border p-2 rounded" onchange="updatePastWorkPreview()"></div>
                    </div>
                    
                    <div id="overtime-detail-area" class="border rounded p-3 bg-yellow-50 mt-3" style="display:none;">
                        <h3 class="font-bold text-sm mb-2 text-orange-800"><i class="fas fa-clock mr-1"></i>時間外業務内容</h3>
                        <div id="early-work-area" class="mb-3" style="display:none;">
                            <div class="text-xs font-bold text-gray-700 mb-1">早出: <span id="early-minutes">-</span>分</div>
                            <div class="grid grid-cols-3 gap-1">
                                <button onclick="selectOvertimeActivity('early','プレホス準備')" class="early-activity-btn text-xs border rounded bg-white px-1 py-1 hover:bg-blue-50">プレホス準備</button>
                                <button onclick="selectOvertimeActivity('early','病棟引継ぎ')" class="early-activity-btn text-xs border rounded bg-white px-1 py-1 hover:bg-blue-50">病棟引継ぎ</button>
                                <button onclick="selectOvertimeActivity('early','回診')" class="early-activity-btn text-xs border rounded bg-white px-1 py-1 hover:bg-blue-50">回診</button>
                            </div>
                            <input type="text" id="early-custom" placeholder="その他" class="w-full text-xs border rounded p-1 mt-1" onchange="selectOvertimeActivity('early',this.value)">
                            <div class="text-xs mt-1 text-blue-600 font-bold" id="early-selected"></div>
                        </div>
                        <div id="late-work-area" style="display:none;">
                            <div class="text-xs font-bold text-gray-700 mb-1">残業: <span id="late-minutes">-</span>分</div>
                            <div class="grid grid-cols-3 gap-1">
                                <button onclick="selectOvertimeActivity('late','救急対応')" class="late-activity-btn text-xs border rounded bg-white px-1 py-1 hover:bg-blue-50">救急対応</button>
                                <button onclick="selectOvertimeActivity('late','記録作成')" class="late-activity-btn text-xs border rounded bg-white px-1 py-1 hover:bg-blue-50">記録作成</button>
                                <button onclick="selectOvertimeActivity('late','カンファレンス')" class="late-activity-btn text-xs border rounded bg-white px-1 py-1 hover:bg-blue-50">カンファ</button>
                            </div>
                            <input type="text" id="late-custom" placeholder="その他" class="w-full text-xs border rounded p-1 mt-1" onchange="selectOvertimeActivity('late',this.value)">
                            <div class="text-xs mt-1 text-blue-600 font-bold" id="late-selected"></div>
                        </div>
                    </div>

                    <div class="border-t pt-3 mt-3">
                        <label class="block text-sm font-bold mb-1">固定手当(科長職)の扱い</label>
                        <div class="space-y-2">
                            <label class="flex items-center text-sm"><input type="radio" name="past-applied" value="auto" class="mr-2" checked onchange="updatePastWorkPreview()"><span>時間に応じて自動計算</span></label>
                            <label class="flex items-center text-sm"><input type="radio" name="past-applied" value="custom" class="mr-2" onchange="updatePastWorkPreview()"><span>手動入力:</span><input type="number" id="past-applied-amount" class="ml-2 border p-1 rounded w-24" placeholder="0" onchange="updatePastWorkPreview()"><span class="ml-1">円</span></label>
                            <label class="flex items-center text-sm"><input type="radio" name="past-applied" value="none" class="mr-2" onchange="updatePastWorkPreview()"><span>なし（¥0）</span></label>
                        </div>
                    </div>
                </div>
                <div><label class="block text-sm font-bold">メモ</label><input type="text" id="past-memo" class="w-full border p-2 rounded" placeholder="例: 激務だった"></div>
                <div class="bg-blue-50 border border-blue-200 rounded p-3 text-xs space-y-1">
                    <div class="flex justify-between"><span>実働時間:</span> <span id="preview-work" class="font-bold">-</span></div>
                    <div class="flex justify-between"><span>固定手当:</span> <span id="preview-actual" class="font-bold">¥0</span></div>
                    <div class="border-t pt-1 mt-1 flex justify-between font-bold text-red-600"><span>待遇損益:</span> <span id="preview-balance">¥0</span></div>
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-2">
                <button onclick="closePastWork()" class="px-4 py-2 bg-gray-300 rounded text-sm hover:bg-gray-400">キャンセル</button>
                <button onclick="savePastWork()" class="px-4 py-2 bg-blue-600 text-white rounded text-sm hover:bg-blue-700 font-bold">保存する</button>
            </div>
        </div>
    </div>

    <div id="reportModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4 no-print">
                <h2 class="text-lg font-bold text-gray-800">労基署対応 実態報告書</h2>
                <button onclick="closeReport()" class="text-gray-500"><i class="fas fa-times"></i></button>
            </div>
            <div class="no-print bg-gray-50 p-4 rounded mb-4 flex gap-4 items-end">
                <div><label class="block text-xs font-bold mb-1">開始日</label><input type="date" id="report-start" class="border p-2 rounded text-sm"></div>
                <div><label class="block text-xs font-bold mb-1">終了日</label><input type="date" id="report-end" class="border p-2 rounded text-sm"></div>
                <button onclick="generateReport()" class="bg-blue-600 text-white px-4 py-2 rounded text-sm font-bold">生成</button>
            </div>
            <div id="report-content" class="bg-white p-4"></div>
            <div class="mt-4 flex justify-end gap-2 no-print">
                <button onclick="printReport()" class="bg-green-600 text-white px-6 py-2 rounded text-sm font-bold">印刷</button>
                <button onclick="copyReportText()" class="bg-indigo-600 text-white px-6 py-2 rounded text-sm font-bold">テキストコピー</button>
                <button onclick="closeReport()" class="bg-gray-300 px-4 py-2 rounded text-sm">閉じる</button>
            </div>
        </div>
    </div>

    <div id="exitModal" class="modal">
        <div class="modal-content">
            <h2 class="text-lg font-bold mb-4 text-red-600">エリア退出検知</h2>
            <p class="text-sm text-gray-600 mb-4">退出時刻は検知した瞬間に記録されています。<br>今の状況を選択してください。</p>
            <div class="grid grid-cols-1 gap-2">
                <button onclick="confirmExit('WORK_EXIT')" class="p-3 bg-yellow-100 text-yellow-900 rounded text-left font-bold"><i class="fas fa-helicopter mr-2"></i>業務による外出 (ヘリ/カー/転送)</button>
                <button onclick="confirmExit('SHIFT_END')" class="p-3 bg-blue-100 text-blue-900 rounded text-left font-bold"><i class="fas fa-home mr-2"></i>退勤 (帰宅)</button>
                <button onclick="confirmExit('IGNORE')" class="p-3 bg-gray-100 rounded text-left"><i class="fas fa-times mr-2"></i>記録しない (GPS誤差)</button>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="modal"><div class="modal-content"><h2 class="text-lg font-bold mb-4">設定</h2><div class="space-y-4"><div class="bg-blue-50 p-3 rounded"><label class="block text-sm font-bold text-blue-900 mb-2">A. 現状の支給条件</label><div class="mb-2"><label class="block text-xs font-bold">管理職手当 (月額)</label><input type="number" id="setting-manager-allowance" class="w-full border p-1 rounded" value="80000"></div><label class="block text-xs font-bold mb-1">科長職固定手当</label><div class="grid grid-cols-4 gap-1 text-xs"><div><span class="block text-gray-500">1h迄</span><input type="number" id="tier-1" class="border p-1 w-full" value="5000"></div><div><span class="block text-gray-500">1-3h</span><input type="number" id="tier-2" class="border p-1 w-full" value="6500"></div><div><span class="block text-gray-500">3-6h</span><input type="number" id="tier-3" class="border p-1 w-full" value="9000"></div><div><span class="block text-gray-500">6h超</span><input type="number" id="tier-4" class="border p-1 w-full" value="10000"></div></div></div><div class="bg-green-50 p-3 rounded"><label class="block text-sm font-bold text-green-900 mb-2">B. 本来(一般職)の計算条件</label><div class="grid grid-cols-2 gap-3 mb-2"><div><label class="block text-xs font-bold">基本給(月)</label><input type="number" id="setting-base-salary" class="w-full border p-1 rounded" value="500000"></div><div><label class="block text-xs font-bold">諸手当(月)</label><input type="number" id="setting-allowances-total" class="w-full border p-1 rounded" value="0"></div></div><p class="text-[10px] text-gray-600">※時給 = (基本給+諸手当)÷155h</p></div><div class="flex items-center gap-2 mt-2"><input type="checkbox" id="auto-no-break" class="h-4 w-4"><label for="auto-no-break" class="text-sm font-bold text-red-600">救急科 休憩なしモード (常時オン)</label></div><div class="border-t pt-2"><button onclick="clearAllData()" class="w-full bg-red-100 text-red-800 py-2 rounded text-sm">全データ削除</button></div></div><div class="mt-6 flex justify-end gap-2"><button onclick="closeSettings()" class="px-4 py-2 bg-gray-300 rounded">閉じる</button><button onclick="saveSettings()" class="px-4 py-2 bg-blue-600 text-white rounded">保存</button></div></div></div>
    <div id="manualLogModal" class="modal"><div class="modal-content"><h2 class="text-lg font-bold mb-4">手動ログ追加</h2><div class="space-y-3"><div><label>日時</label><input type="datetime-local" id="manual-timestamp" class="w-full border p-2 rounded"></div><div><label>種別</label><select id="manual-type" class="w-full border p-2 rounded"><option value="ENTRY">入館</option><option value="EXIT">退館</option><option value="ACTIVITY">活動</option><option value="BREAK_START">休憩開始</option><option value="BREAK_END">休憩終了</option><option value="STANDBY">待機</option></select></div><div><label>内容</label><input type="text" id="manual-note" class="w-full border p-2 rounded"></div></div><div class="mt-6 flex justify-end gap-2"><button onclick="closeManualLog()" class="px-4 py-2 bg-gray-300 rounded">キャンセル</button><button onclick="saveManualLog()" class="px-4 py-2 bg-blue-600 text-white rounded">追加</button></div></div></div>
    <div id="dataModal" class="modal"><div class="modal-content"><h2 class="text-lg font-bold mb-4">データ管理</h2><div class="space-y-3"><button onclick="exportFullBackup()" class="w-full bg-blue-600 text-white px-4 py-2 rounded">バックアップ保存</button><div class="border p-2 rounded"><p class="text-xs mb-1">復元:</p><input type="file" id="restore-file" onchange="importBackup()" class="text-xs"></div></div><div class="mt-6 flex justify-end"><button onclick="closeDataManagement()" class="px-4 py-2 bg-gray-300 rounded">閉じる</button></div></div></div>
    <div id="dailyModal" class="modal"><div class="modal-content"><h2 class="text-lg font-bold mb-4">日別詳細</h2><input type="date" id="detail-date" class="border p-2 rounded w-full mb-3" onchange="loadDailyDetail()"><div id="daily-detail-content" class="text-sm space-y-2"></div><div class="mt-6 flex justify-end"><button onclick="closeDailyDetail()" class="px-4 py-2 bg-gray-300 rounded">閉じる</button></div></div></div>
    <div id="detailModal" class="modal"><div class="modal-content"><h2 class="text-lg font-bold mb-2">詳細・コピー</h2><textarea id="detail-text-area" class="w-full h-64 border p-2 text-xs font-mono bg-gray-50 rounded" readonly></textarea><button onclick="copyToClipboard('detail-text-area')" class="w-full bg-indigo-600 text-white py-2 rounded mt-2 hover:bg-indigo-700 font-bold">コピーして閉じる</button><div class="mt-2 text-right"><button onclick="closeDetailModal()" class="text-gray-500 text-xs">キャンセル</button></div></div></div>

    <script>
        // ==================== CONFIG & STATE ====================
        const CONFIG_KEY='medwork_config_v4_5',LOG_KEY='medwork_logs_v4_5',SESSION_KEY='medwork_session_v4_5',HOLIDAY_KEY='medwork_holidays_v4_5',APPLIED_KEY='medwork_applied_v4_5',DAILY_SHIFTS_KEY='medwork_shifts_v4_5';
        const SHIFT_PATTERNS={'day':{start:'08:30',end:'17:15',standardHours:7.75,breakMinutes:60,name:'日勤'},'semi':{start:'13:15',end:'22:00',standardHours:7.75,breakMinutes:60,name:'準夜'},'night':{start:'17:15',end:'09:45',standardHours:16.5,breakMinutes:60,name:'夜勤'},'holiday':{start:null,end:null,standardHours:0,breakMinutes:0,name:'休日'}};
        
        let config={baseSalary:500000,allowancesTotal:0,managerAllowance:80000,allowanceTiers:{tier1:5000,tier2:6500,tier3:9000,tier4:10000},nightRate:50,holidayRate:35,hospitalLat:31.573568,hospitalLng:130.541833,radius:300,hospitalName:'鹿児島市立病院',userName:'',department:'救急科',autoNoBreak:false};
        let state={isInside:false,currentSession:null,onBreak:false,breakStartTime:null,logs:[],lastGPSCoords:null,holidays:{},appliedAllowances:{},dailyShifts:{},overtimeActivities:{early:'',late:''},lastCalcText:'',chartRange:'1m', pendingExitTime: null};

        function init(){loadData();updateClock();setInterval(updateClock,1000);initGeoLocation();renderLogs();initCharts();recalcToday();document.getElementById('edit-date').valueAsDate=new Date();const t=new Date();document.getElementById('report-start').valueAsDate=new Date(t.getFullYear(),t.getMonth(),1);document.getElementById('report-end').valueAsDate=t;}
        function loadData(){
            try{const c=localStorage.getItem(CONFIG_KEY);if(c)config={...config,...JSON.parse(c)};const l=localStorage.getItem(LOG_KEY);if(l)state.logs=JSON.parse(l);const h=localStorage.getItem(HOLIDAY_KEY);if(h)state.holidays=JSON.parse(h);const a=localStorage.getItem(APPLIED_KEY);if(a)state.appliedAllowances=JSON.parse(a);const s=localStorage.getItem(DAILY_SHIFTS_KEY);if(s)state.dailyShifts=JSON.parse(s);}catch(e){}
            document.getElementById('setting-base-salary').value=config.baseSalary;document.getElementById('setting-allowances-total').value=config.allowancesTotal||0;document.getElementById('setting-manager-allowance').value=config.managerAllowance||80000;
            document.getElementById('tier-1').value=config.allowanceTiers.tier1;document.getElementById('tier-2').value=config.allowanceTiers.tier2;document.getElementById('tier-3').value=config.allowanceTiers.tier3;document.getElementById('tier-4').value=config.allowanceTiers.tier4;
            document.getElementById('setting-hospital-name').value=config.hospitalName;document.getElementById('setting-user-name').value=config.userName;document.getElementById('auto-no-break').checked=config.autoNoBreak;
        }

        // ==================== GPS & LOGGING (TIMEOUT FIX) ====================
        function initGeoLocation(){
            if("geolocation" in navigator) {
                document.getElementById('current-status-text').innerText = "GPS初期化中...";
                
                // Watcher without timeout (Infinite wait for user permission)
                navigator.geolocation.watchPosition(
                    (p)=>{ handleGPSUpdate(p); },
                    (e)=>{ handleGPSError(e); },
                    { enableHighAccuracy: true, maximumAge: 0 } // REMOVED timeout: 5000
                );
                
                // One-shot check (Optional, good for quick start if already permitted)
                navigator.geolocation.getCurrentPosition(
                    (p)=>{ handleGPSUpdate(p); },
                    (e)=>{ /* Ignore errors on one-shot */ },
                    { enableHighAccuracy: true, timeout: 10000 }
                );
            } else {
                document.getElementById('current-status-text').innerText = "GPS非対応";
            }
        }
        
        function handleGPSUpdate(p){
            state.lastGPSCoords={lat:p.coords.latitude,lng:p.coords.longitude,accuracy:p.coords.accuracy};
            const d=getDist(p.coords.latitude,p.coords.longitude,config.hospitalLat,config.hospitalLng);
            
            const debugEl = document.getElementById('gps-debug-info');
            debugEl.style.display = 'block';
            debugEl.innerText = `${new Date().toLocaleTimeString()} 精度:${Math.round(p.coords.accuracy)}m`;
            document.getElementById('current-status-text').innerText = d < config.radius ? "院内エリア" : "院外エリア";
            
            handleLocation(d<config.radius);
        }
        
        function handleGPSError(e){
            // Code 1: Permission Denied, Code 2: Pos Unavailable, Code 3: Timeout
            let msg = "GPSエラー: ";
            if(e.code === 1) msg += "位置情報の許可が必要です";
            else if(e.code === 2) msg += "位置情報を取得できません";
            else if(e.code === 3) msg += "タイムアウト";
            else msg += e.message;
            document.getElementById('current-status-text').innerText = msg;
        }

        function getDist(lat1,lon1,lat2,lon2){const R=6371000,dLat=(lat2-lat1)*Math.PI/180,dLon=(lon2-lon1)*Math.PI/180,a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));}
        
        function handleLocation(isInside){
            const prev=state.isInside; state.isInside=isInside;
            const card=document.getElementById('status-card'),txt=document.getElementById('location-status'),btn=document.getElementById('manual-entry-btn');
            
            if(isInside){
                card.classList.add('border-green-500'); txt.innerText="院内/勤務中"; btn.innerText="手動退館";
                if(!prev) addLog('ENTRY','GPS自動入館',state.lastGPSCoords);
                state.pendingExitTime = null; 
            }
            else{
                card.classList.remove('border-green-500'); txt.innerText="院外/OFF"; btn.innerText="手動入館";
                // Detect EXIT while asleep/background
                if(prev && state.status !== 'MOBILE_WORK') {
                    state.pendingExitTime = new Date().toISOString();
                    document.getElementById('exitModal').style.display='block'; 
                }
            }
        }
        function manualToggleEntry(){if(state.isInside)document.getElementById('exitModal').style.display='block';else handleLocation(true);}
        function addLog(type,note,gps,timestampOverride=null){
            const ts = timestampOverride || new Date().toISOString();
            state.logs.unshift({id:Date.now(),timestamp:ts,type,note,gps});
            saveLogs();renderLogs();recalcToday();
        }
        function saveLogs(){localStorage.setItem(LOG_KEY,JSON.stringify(state.logs));}
        function renderLogs(){const c=document.getElementById('log-container');c.innerHTML='';state.logs.slice(0,50).forEach(l=>{const d=new Date(l.timestamp);const ts=`${d.getDate()}日 ${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}`;c.innerHTML+=`<div class="border-b py-1 flex text-xs log-item"><span class="w-20 text-gray-400">${ts}</span><span class="font-bold w-12 ${l.type==='ENTRY'?'text-green-600':l.type==='EXIT'?'text-red-600':'text-blue-600'}">${l.type}</span><span class="flex-1 truncate">${l.note}</span></div>`;});}
        
        function confirmExit(r){
            document.getElementById('exitModal').style.display='none';
            if(r==='IGNORE'){ state.pendingExitTime = null; return; }
            const exitTime = state.pendingExitTime || new Date().toISOString();
            state.pendingExitTime = null;
            if(r==='MOBILE_WORK'){state.status='MOBILE_WORK';addLog('EXIT','業務外出',state.lastGPSCoords,exitTime);}
            else{state.status='OUTSIDE';addLog('EXIT','勤務終了',state.lastGPSCoords,exitTime);}
            updateStatusUI();recalcToday();
        }
        function updateStatusUI(){
            const c=document.getElementById('status-card'),t=document.getElementById('location-status'),b=document.getElementById('manual-entry-btn');
            if(state.status==='MOBILE_WORK'){c.classList.add('border-orange-400');t.innerText='移動勤務中';b.innerText='勤務終了';}
            else if(state.isInside){c.classList.add('border-green-500');t.innerText='勤務中';b.innerText='退館';}
            else{c.classList.remove('border-green-500','border-orange-400');t.innerText='OFF';b.innerText='入館';}
        }

        // ==================== CALCULATION ====================
        function getCumulativeMonthlyOt(targetDateStr) {
            const targetDate = new Date(targetDateStr);
            const year = targetDate.getFullYear(); const month = targetDate.getMonth();
            let cumulative = 0;
            for (let d = 1; d < targetDate.getDate(); d++) {
                const dateStr = new Date(year, month, d).toLocaleDateString('en-CA');
                const s = calculateDailyStats(dateStr, true);
                if(s && !s.isOff) cumulative += s.otHours;
            }
            return cumulative;
        }

        function calculateDailyStats(dateStr, skipCumulative = false) {
            const dayLogs = state.logs.filter(l => new Date(l.timestamp).toLocaleDateString('en-CA') === dateStr).sort((a,b)=>new Date(a.timestamp)-new Date(b.timestamp));
            if (dayLogs.length === 0) return null;
            if (dayLogs.some(l => l.type === 'OFF')) return { isOff: true, actualPay: 0, legalPay: 0, balance: 0, text: '完全休日', otHours:0, nightHours:0, holidayDayHours:0, holidayNightHours:0, otDayHours:0, otNightHours:0, stdNightHours:0 };

            let points = [];
            dayLogs.forEach(l => {
                if(l.type === 'ENTRY') points.push({t: new Date(l.timestamp).getTime(), type: 1});
                if(l.type === 'EXIT') points.push({t: new Date(l.timestamp).getTime(), type: -1});
            });
            const now = new Date();
            if(dateStr === now.toLocaleDateString('en-CA') && state.isInside) points.push({t: now.getTime(), type: -1});
            points.sort((a,b) => a.t - b.t);

            let depth = 0, lastTime = null, totalWorkMs = 0, nightMs = 0;
            let startTime = null; let endTime = null;

            points.forEach(p => {
                if (depth > 0 && lastTime !== null) {
                    if(startTime === null) startTime = lastTime;
                    endTime = p.t;
                    totalWorkMs += (p.t - lastTime);
                    let start = new Date(lastTime), end = new Date(p.t);
                    while(start < end) {
                        const h = start.getHours();
                        if(h < 5 || h >= 22) nightMs += 60000;
                        start.setTime(start.getTime() + 60000);
                    }
                }
                depth += p.type; lastTime = p.t;
                if(depth < 0) depth = 0;
            });

            const savedShift = state.dailyShifts[dateStr] || 'day';
            const pattern = SHIFT_PATTERNS[savedShift];
            let breakMs = (config.autoNoBreak ? 0 : (pattern.breakMinutes || 60)) * 60000;
            if(totalWorkMs < breakMs) breakMs = 0;

            let netWorkHours = Math.max(0, totalWorkMs - breakMs) / 3600000;
            let nightHours = nightMs / 3600000;
            const isHoliday = state.holidays[dateStr] || (savedShift === 'holiday');
            const otHours = Math.max(0, netWorkHours - pattern.standardHours);
            
            // Chart Breakdown
            let holidayDayHours = 0, holidayNightHours = 0, otDayHours = 0, otNightHours = 0, stdNightHours = 0;
            if (isHoliday) {
                holidayNightHours = nightHours; holidayDayHours = Math.max(0, netWorkHours - nightHours);
            } else {
                let stdNight = (savedShift === 'night') ? 7 : 0; 
                otNightHours = Math.min(Math.max(0, nightHours - stdNight), otHours);
                otDayHours = Math.max(0, otHours - otNightHours);
                stdNightHours = Math.max(0, nightHours - otNightHours);
            }

            // Actual
            let actualPay = 0;
            let checkHours = isHoliday ? netWorkHours : otHours;
            if(checkHours > 0) {
                if(checkHours < 1) actualPay = config.allowanceTiers.tier1;
                else if(checkHours < 3) actualPay = config.allowanceTiers.tier2;
                else if(checkHours < 6) actualPay = config.allowanceTiers.tier3;
                else actualPay = config.allowanceTiers.tier4;
            }
            if(state.appliedAllowances[dateStr] !== undefined) actualPay = state.appliedAllowances[dateStr];

            // Legal
            const totalMonthlySalary = config.baseSalary + (config.allowancesTotal || 0);
            const hourly = totalMonthlySalary / 155; 
            let legalPay = 0;
            let over60hNote = "";
            let cumulativeOt = 0;
            if(!skipCumulative && !isHoliday) cumulativeOt = getCumulativeMonthlyOt(dateStr);

            if(isHoliday) {
                const dayWork = Math.max(0, netWorkHours - nightHours);
                legalPay = (hourly * 1.35 * dayWork) + (hourly * 1.60 * nightHours);
            } else {
                let otPay = 0;
                if (cumulativeOt >= 60) {
                    otPay = hourly * 1.50 * otHours; over60hNote = " (全1.5倍)";
                } else if (cumulativeOt + otHours > 60) {
                    const normalPart = 60 - cumulativeOt; const highPart = otHours - normalPart;
                    otPay = (hourly * 1.25 * normalPart) + (hourly * 1.50 * highPart); over60hNote = " (一部1.5倍)";
                } else {
                    otPay = hourly * 1.25 * otHours;
                }
                const nightPay = hourly * 0.25 * nightHours;
                legalPay = otPay + nightPay;
            }
            legalPay = Math.round(legalPay);

            let timeStr = "";
            if (startTime && endTime) {
                const s = new Date(startTime); const e = new Date(endTime);
                timeStr = `${s.getHours()}:${String(s.getMinutes()).padStart(2,'0')} - ${e.getHours()}:${String(e.getMinutes()).padStart(2,'0')}`;
            }

            return {
                netWorkHours, otHours, nightHours, holidayDayHours, holidayNightHours, otDayHours, otNightHours, stdNightHours,
                actualPay, legalPay, balance: actualPay - legalPay, 
                over60hNote, timeStr,
                text: `[${dateStr}]\n実働: ${netWorkHours.toFixed(2)}h / 残業: ${otHours.toFixed(2)}h${over60hNote}\n固定手当: ¥${actualPay}\n本来賃金: ¥${legalPay}`
            };
        }

        function recalcToday(){
            const today = new Date().toLocaleDateString('en-CA');
            const s = calculateDailyStats(today);
            
            if(s && !s.isOff){
                document.getElementById('today-work-hours').innerText = s.netWorkHours.toFixed(1)+'h';
                document.getElementById('today-ot-hours').innerText = s.otHours.toFixed(1)+'h';
                document.getElementById('today-fixed-allowance').innerText = '¥'+s.actualPay.toLocaleString();
                document.getElementById('calc-breakdown').innerText = `本来の残業代: ¥${s.legalPay.toLocaleString()}`;
                state.lastCalcText = s.text;
            } else {
                document.getElementById('today-work-hours').innerText = '0h';
                document.getElementById('today-ot-hours').innerText = '0h';
                document.getElementById('today-fixed-allowance').innerText = '¥0';
                document.getElementById('calc-breakdown').innerText = 'ログなし';
            }
            
            const now = new Date();
            const year = now.getFullYear(); const month = now.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            let totalActual = config.managerAllowance || 0;
            let totalLegal = 0;
            
            for(let d=1; d<=daysInMonth; d++){
                const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const stat = calculateDailyStats(dateStr);
                if(stat) { totalActual += stat.actualPay; totalLegal += stat.legalPay; }
            }
            
            const balance = totalActual - totalLegal;
            const balanceEl = document.getElementById('month-balance');
            
            document.getElementById('month-actual-pay').innerText = '¥' + totalActual.toLocaleString();
            document.getElementById('month-legal-pay').innerText = '¥' + totalLegal.toLocaleString();
            
            if (balance < 0) {
                balanceEl.innerText = '-¥' + Math.abs(balance).toLocaleString();
                balanceEl.className = "text-3xl font-extrabold text-red-600 blink-red";
                document.getElementById('month-balance-text').innerText = "損失発生中 (名ばかり管理職)";
            } else {
                balanceEl.innerText = '+¥' + balance.toLocaleString();
                balanceEl.className = "text-3xl font-extrabold text-green-600";
                document.getElementById('month-balance-text').innerText = "管理職手当内で推移";
            }
            
            updateCharts();
        }

        // ==================== CHARTS ====================
        let hoursChart, payChart;
        function initCharts(){
            const ctxH = document.getElementById('hoursChart').getContext('2d');
            hoursChart = new Chart(ctxH, { type: 'bar', data: { labels: [], datasets: [] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true, title: {display:true, text:'時間'} } }, plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 9 } } } } } });
            const ctxP = document.getElementById('payChart').getContext('2d');
            payChart = new Chart(ctxP, { type: 'bar', data: { labels: [], datasets: [] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, title: {display:true, text:'円'} } }, plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 9 } } } } } });
        }
        function updateCharts(){
            let daysRange = 30; if(state.chartRange === '7d') daysRange=7; if(state.chartRange === '3m') daysRange=90;
            const days=[], holidayDay=[], holidayNight=[], otDay=[], otNight=[], stdNight=[], payDaily=[], payCumulative=[];
            const today = new Date(); let cumulativePay = 0; const startD = new Date(today); startD.setDate(today.getDate() - daysRange + 1);
            for(let i=0; i<daysRange; i++){
                const d = new Date(startD); d.setDate(startD.getDate() + i); const dStr = d.toLocaleDateString('en-CA'); days.push(d.getDate()+'日');
                const s = calculateDailyStats(dStr);
                if(s) { holidayDay.push(s.holidayDayHours); holidayNight.push(s.holidayNightHours); otDay.push(s.otDayHours); otNight.push(s.otNightHours); stdNight.push(s.stdNightHours); payDaily.push(s.legalPay); cumulativePay += s.legalPay; payCumulative.push(cumulativePay); }
                else { holidayDay.push(0); holidayNight.push(0); otDay.push(0); otNight.push(0); stdNight.push(0); payDaily.push(0); payCumulative.push(cumulativePay); }
            }
            hoursChart.data.labels = days;
            hoursChart.data.datasets = [{ label: '休日(昼)', data: holidayDay, backgroundColor: '#ef4444' }, { label: '休日(夜)', data: holidayNight, backgroundColor: '#991b1b' }, { label: '残業(昼)', data: otDay, backgroundColor: '#f97316' }, { label: '残業(夜)', data: otNight, backgroundColor: '#c2410c' }, { label: '深夜(規程内)', data: stdNight, backgroundColor: '#8b5cf6' }];
            hoursChart.update();
            payChart.data.labels = days;
            payChart.data.datasets = [{ type: 'line', label: '積算残業代', data: payCumulative, borderColor: '#10b981', borderWidth: 2, tension: 0.1, yAxisID: 'y' }, { type: 'bar', label: '日次残業代', data: payDaily, backgroundColor: '#3b82f6', yAxisID: 'y' }];
            payChart.update();
        }
        function updateChartRange(r){ state.chartRange=r; updateCharts(); }

        // ==================== UI & SETTINGS ====================
        function updateShiftSelection() { const shift = document.getElementById('daily-shift-select').value; const today = new Date().toLocaleDateString('en-CA'); state.dailyShifts[today] = shift; localStorage.setItem(DAILY_SHIFTS_KEY, JSON.stringify(state.dailyShifts)); recalcToday(); }
        function saveBreakSetting() { config.autoNoBreak = document.getElementById('auto-no-break').checked; localStorage.setItem(CONFIG_KEY, JSON.stringify(config)); recalcToday(); }
        function updatePastWorkPreview(){ const shift = document.getElementById('past-shift').value; const isOff = shift === 'off'; const inputs = document.getElementById('past-work-inputs'); if(isOff) { inputs.classList.add('disabled-area'); document.getElementById('overtime-detail-area').style.display='none'; document.getElementById('preview-unpaid').innerText = '¥0'; } else { inputs.classList.remove('disabled-area'); const s = document.getElementById('past-start').value; const e = document.getElementById('past-end').value; if(s && e) { document.getElementById('overtime-detail-area').style.display='block'; document.getElementById('early-work-area').style.display='block'; document.getElementById('late-work-area').style.display='block'; } } }
        function selectOvertimeActivity(type, val){ state.overtimeActivities[type]=val; document.getElementById(type+'-selected').innerText = val; document.querySelectorAll('.'+type+'-activity-btn').forEach(b => b.classList.remove('activity-selected')); event.target.classList.add('activity-selected'); }
        function openPastWork(){ document.getElementById('pastWorkModal').style.display='block'; document.getElementById('past-date').valueAsDate=new Date(); state.overtimeActivities={early:'',late:''}; updatePastWorkPreview(); }
        function closePastWork(){ document.getElementById('pastWorkModal').style.display='none'; }
        
        function savePastWork() {
            const date = document.getElementById('past-date').value;
            const shift = document.getElementById('past-shift').value;
            if (!date) return alert('日付選択必須');
            state.dailyShifts[date] = shift; localStorage.setItem(DAILY_SHIFTS_KEY, JSON.stringify(state.dailyShifts));
            
            if (shift === 'off') {
                const offDate = new Date(`${date}T00:00:00`);
                state.logs.push({ id: Date.now(), timestamp: offDate.toISOString(), type: 'OFF', note: '完全休日 [過去入力]', manual: true });
                state.appliedAllowances[date] = 0;
            } else {
                const start = document.getElementById('past-start').value; const end = document.getElementById('past-end').value;
                if(!start || !end) return alert('時間入力必須');
                const dStart = new Date(`${date}T${start}`); let dEnd = new Date(`${date}T${end}`);
                if(shift === 'night' && dEnd < dStart) dEnd.setDate(dEnd.getDate()+1);
                state.logs.push({id:Date.now(), timestamp: dStart.toISOString(), type:'ENTRY', note:'過去入力開始', manual:true});
                state.logs.push({id:Date.now()+1, timestamp: dEnd.toISOString(), type:'EXIT', note:'過去入力終了', manual:true});
                if(state.overtimeActivities.early) state.logs.push({id:Date.now()+2, timestamp: dStart.toISOString(), type:'ACTIVITY', note:`早出: ${state.overtimeActivities.early}`, manual:true});
                if(state.overtimeActivities.late) state.logs.push({id:Date.now()+3, timestamp: dEnd.toISOString(), type:'ACTIVITY', note:`残業: ${state.overtimeActivities.late}`, manual:true});
                const appliedType = document.querySelector('input[name="past-applied"]:checked').value;
                if(appliedType === 'custom') { state.appliedAllowances[date] = parseInt(document.getElementById('past-applied-amount').value)||0; }
                else if(appliedType === 'none') { state.appliedAllowances[date] = 0; }
                else { delete state.appliedAllowances[date]; }
            }
            state.logs.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
            saveLogs(); localStorage.setItem(APPLIED_KEY, JSON.stringify(state.appliedAllowances));
            closePastWork(); recalcToday(); renderLogs(); alert('保存しました');
        }

        // --- Report ---
        function generateReport() {
            const startDate = new Date(document.getElementById('report-start').value); const endDate = new Date(document.getElementById('report-end').value);
            if (!startDate || !endDate) return alert('期間選択');
            let totalLegal = 0, totalFixed = 0; let reportRows = '';
            let cumulativeOtMonth = 0; let currentMonth = -1;
            let d = new Date(startDate);
            while(d <= endDate){
                if(d.getMonth() !== currentMonth) { cumulativeOtMonth = 0; currentMonth = d.getMonth(); }
                const dateStr = d.toLocaleDateString('en-CA'); const stats = calculateDailyStats(dateStr);
                const dayOfWeek = ['日','月','火','水','木','金','土'][d.getDay()];
                if(stats) {
                    if(stats.isOff) { reportRows += `<tr class="holiday-row"><td>${dateStr}</td><td colspan="7" class="text-center">休日</td></tr>`; }
                    else {
                        cumulativeOtMonth += stats.otHours;
                        let otRateNote = stats.over60hNote ? `<span class="rate-badge">60h超</span>` : "";
                        const dayLogs = state.logs.filter(l => new Date(l.timestamp).toLocaleDateString('en-CA') === dateStr);
                        const remarks = dayLogs.filter(l => l.type === 'ACTIVITY').map(l => l.note.replace(' [過去入力]','')).join(', ');
                        totalLegal += stats.legalPay; totalFixed += stats.actualPay;
                        reportRows += `<tr><td>${dateStr} (${dayOfWeek})</td><td>${SHIFT_PATTERNS[state.dailyShifts[dateStr]||'day'].name}</td><td>${stats.timeStr || '-'}</td><td>${stats.otHours.toFixed(2)}h${otRateNote}</td><td>${stats.nightHours.toFixed(2)}h</td><td class="text-right">¥${stats.actualPay.toLocaleString()}</td><td class="text-right">¥${stats.legalPay.toLocaleString()}</td><td class="text-right font-bold ${stats.balance<0?'text-red-600':''}">¥${stats.balance.toLocaleString()}</td><td class="text-left text-xs">${remarks}</td></tr>`;
                    }
                }
                d.setDate(d.getDate()+1);
            }
            const managerPay = config.managerAllowance; const totalActual = managerPay + totalFixed; const finalBalance = totalActual - totalLegal;
            const hourlyRate = Math.round((config.baseSalary + (config.allowancesTotal || 0)) / 155);
            const html = `
                <div class="print-only"><h1>管理職待遇に関する損益分析報告書</h1></div>
                <div class="report-summary"><div class="report-box"><strong>A. 現状の支給総額:</strong> ¥${totalActual.toLocaleString()}<br><span class="text-xs">(管理職手当 ¥${managerPay.toLocaleString()} + 固定手当 ¥${totalFixed.toLocaleString()})</span></div><div class="report-box"><strong>B. 一般職としての残業代:</strong> ¥${totalLegal.toLocaleString()}</div></div>
                <div class="report-box" style="margin-bottom:20px; background:${finalBalance<0?'#fee2e2':'#dcfce7'}; border-color:${finalBalance<0?'red':'green'};"><strong>【最終損益 (A - B)】: <span style="font-size:1.5em;">¥${finalBalance.toLocaleString()}</span></strong><br>${finalBalance<0?'管理職待遇により、一般職より賃金が低くなっています（名ばかり管理職の可能性大）。':'現状、管理職手当が残業代を上回っています。'}</div>
                <table class="report-table"><thead><tr><th>日付</th><th>シフト</th><th>時間</th><th>残業</th><th>深夜</th><th>固定手当</th><th>本来残業代</th><th>日次損益</th><th>備考</th></tr></thead><tbody>${reportRows}</tbody></table>
                <div style="margin-top:20px; font-size:10px;"><strong>【計算根拠】</strong><br>時給単価: ¥${hourlyRate.toLocaleString()} (基礎賃金÷155h)<br>割増率: 時間外1.25(60h超1.50) / 休日1.35 / 深夜+0.25</div>`;
            document.getElementById('report-content').innerHTML = html;
        }
        function copyReportText() { const content = document.getElementById('report-content').innerText; navigator.clipboard.writeText(content).then(()=>alert('レポートのテキストをコピーしました')); }

        // --- Common ---
        function openDetailModal(){ document.getElementById('detail-text-area').value=state.lastCalcText; document.getElementById('detailModal').style.display='block'; }
        function closeDetailModal(){ document.getElementById('detailModal').style.display='none'; }
        function copyToClipboard(id){ const el=document.getElementById(id); el.select(); navigator.clipboard.writeText(el.value); alert('コピーしました'); }
        function openSettings(){ document.getElementById('settingsModal').style.display='block'; }
        function closeSettings(){ document.getElementById('settingsModal').style.display='none'; }
        function saveSettings(){ 
            config.baseSalary=parseInt(document.getElementById('setting-base-salary').value);
            config.allowancesTotal=parseInt(document.getElementById('setting-allowances-total').value)||0;
            config.managerAllowance=parseInt(document.getElementById('setting-manager-allowance').value)||80000;
            config.allowanceTiers.tier1=parseInt(document.getElementById('tier-1').value); config.allowanceTiers.tier2=parseInt(document.getElementById('tier-2').value); config.allowanceTiers.tier3=parseInt(document.getElementById('tier-3').value); config.allowanceTiers.tier4=parseInt(document.getElementById('tier-4').value);
            config.hospitalName=document.getElementById('setting-hospital-name').value; config.userName=document.getElementById('setting-user-name').value;
            localStorage.setItem(CONFIG_KEY, JSON.stringify(config)); closeSettings(); recalcToday();
        }
        function openManualLog(){ document.getElementById('manualLogModal').style.display='block'; }
        function closeManualLog(){ document.getElementById('manualLogModal').style.display='none'; }
        function saveManualLog(){
            const ts = document.getElementById('manual-timestamp').value; const type = document.getElementById('manual-type').value; const note = document.getElementById('manual-note').value;
            if(!ts || !note) return alert('入力不備');
            addLog(type, note + ' [手動]', null, new Date(ts).toISOString()); closeManualLog();
        }
        function openDataManagement(){ document.getElementById('dataModal').style.display='block'; }
        function closeDataManagement(){ document.getElementById('dataModal').style.display='none'; }
        function clearAllData(){ if(confirm('全削除しますか？')){ localStorage.clear(); location.reload(); } }
        function exportFullBackup(){ const d = JSON.stringify({config, state}); const blob = new Blob([d], {type:'application/json'}); const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='backup.json'; a.click(); }
        function importBackup(){ const f = document.getElementById('restore-file').files[0]; const r = new FileReader(); r.onload = e => { const d = JSON.parse(e.target.result); config = d.config; state = d.state; localStorage.setItem(CONFIG_KEY, JSON.stringify(config)); localStorage.setItem(LOG_KEY, JSON.stringify(state.logs)); location.reload(); }; r.readAsText(f); }
        function openReport(){ document.getElementById('reportModal').style.display='block'; }
        function closeReport(){ document.getElementById('reportModal').style.display='none'; }
        function printReport(){ window.print(); }
        function viewDailyDetail(){ document.getElementById('dailyModal').style.display='block'; loadDailyDetail(); }
        function loadDailyDetail(){ const dStr = document.getElementById('detail-date').value; const logs = state.logs.filter(l => new Date(l.timestamp).toLocaleDateString('en-CA') === dStr); const c = document.getElementById('daily-detail-content'); c.innerHTML = logs.map(l => `<div>[${new Date(l.timestamp).toLocaleTimeString()}] ${l.type}: ${l.note}</div>`).join(''); }
        function closeDailyDetail(){ document.getElementById('dailyModal').style.display='none'; }
        function updateClock(){ document.getElementById('clock-display').innerText = new Date().toLocaleTimeString('ja-JP'); }
        function exportCSV(){ let csv = "Date,Type,Note\n"; state.logs.forEach(l => csv += `${l.timestamp},${l.type},${l.note}\n`); const blob = new Blob([csv], {type:'text/csv'}); const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='logs.csv'; a.click(); }
        function logActivity(n){addLog('ACTIVITY',n,state.lastGPSCoords);}
        function startBreak(){state.onBreak=!state.onBreak;addLog(state.onBreak?'BREAK_START':'BREAK_END',state.onBreak?'休憩開始':'休憩終了');}

        window.onload = init;
    </script>
</body>
</html>
