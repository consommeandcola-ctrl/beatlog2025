<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
<title>æ•‘æ€¥è¨˜éŒ² - è¶…é«˜ç²¾åº¦AIç‰ˆ v2.3.3 (ç—‡çŠ¶èªè­˜å¼·åŒ–)</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: rgba(0,0,0,0); }
  body {
    background: #f8f9fa; min-height: 100vh; color: #212529;
    font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Yu Gothic','Hiragino Sans',sans-serif;
    line-height: 1.4; font-size: 14px; -webkit-text-size-adjust: 100%; touch-action: manipulation; overflow-x: hidden;
  }
  header {
    background: #fff; border-bottom: 2px solid #e74c3c; padding: 6px 10px; box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    position: sticky; top: 0; z-index: 100;
  }
  .header-content { display: flex; justify-content: space-between; align-items: center; }
  h1 { font-size: 13px; font-weight: 700; color: #e74c3c; }
  .version { font-size: 8px; color: #9b59b6; margin-left: 4px; }
  .clock { font-size: 16px; font-weight: 700; color: #2c3e50; font-variant-numeric: tabular-nums; }
  .wrap { padding: 6px; }
  .grid { display: flex; flex-direction: column; gap: 6px; }
  .card { background: #fff; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
  .card h2 { padding: 6px 10px; border-bottom: 2px solid #3498db; font-size: 12px; font-weight: 700; color: #2c3e50; background: #ecf0f1; }
  .card .body { padding: 8px; }
  .voice-control {
    display: flex; gap: 8px; align-items: center; padding: 8px; background: #ecf0f1; border-radius: 6px; margin-bottom: 6px;
  }
  .voice-btn {
    flex-shrink: 0; width: 52px; height: 52px; border: none; border-radius: 50%;
    background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    color: #fff; font-size: 22px; box-shadow: 0 2px 6px rgba(231,76,60,0.3);
  }
  .voice-btn:active { transform: scale(0.95); }
  .voice-btn.active { background: linear-gradient(135deg, #27ae60 0%, #229954 100%); animation: pulse-voice 1.5s infinite; }
  @keyframes pulse-voice { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
  .voice-status { flex: 1; min-width: 0; }
  .voice-status-title { font-size: 10px; font-weight: 600; color: #2c3e50; margin-bottom: 2px; }
  .voice-status-text { font-size: 9px; color: #7f8c8d; line-height: 1.2; }
  .voice-interim { margin-top: 4px; padding: 4px 6px; background: #fff; border-radius: 4px; border-left: 2px solid #3498db; font-size: 10px; color: #7f8c8d; font-style: italic; min-height: 16px; }
  .confidence-bar { margin-top: 3px; height: 4px; background: #ecf0f1; border-radius: 2px; overflow: hidden; }
  .confidence-fill { height: 100%; transition: width 0.3s ease, background-color 0.3s ease; }
  .confidence-high { background: #27ae60; }
  .confidence-medium { background: #f39c12; }
  .confidence-low { background: #e74c3c; }
  .ai-indicator { margin-top: 3px; font-size: 8px; color: #9b59b6; font-weight: 600; }
  textarea {
    width: 100%; min-height: 50px; border: 2px solid #bdc3c7; border-radius: 6px; padding: 6px;
    font-size: 13px; line-height: 1.4; resize: vertical; font-family: inherit; background: #fff;
  }
  textarea:focus { outline: none; border-color: #3498db; box-shadow: 0 0 0 2px rgba(52,152,219,0.2); }
  .suggestions { margin-top: 4px; padding: 4px; background: #e8f4f8; border-radius: 4px; border-left: 2px solid #3498db; max-height: 100px; overflow-y: auto; }
  .suggestions-title { font-size: 9px; font-weight: 600; color: #2c3e50; margin-bottom: 3px; }
  .suggestion-item {
    display: inline-block; padding: 4px 8px; margin: 2px; background: #fff; border: 1px solid #3498db; border-radius: 10px; font-size: 10px; color: #2c3e50; min-height: 28px; line-height: 1.8;
  }
  .suggestion-item:active { background: #3498db; color: #fff; }
  .controls { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 6px; }
  .pill {
    display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; border: 1px solid #bdc3c7; border-radius: 12px;
    background: #ecf0f1; font-size: 10px; color: #2c3e50; font-weight: 500;
  }
  .pill select, .pill input[type="number"] { border: none; background: transparent; font-size: 10px; font-weight: 600; color: #2c3e50; }
  .pill input[type="checkbox"] { width: 14px; height: 14px; }
  .btn {
    border: none; background: #3498db; color: #fff; border-radius: 6px; padding: 8px 12px; font-weight: 600; font-size: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    min-height: 40px; display: inline-flex; align-items: center; justify-content: center;
  }
  .btn:active { transform: scale(0.97); opacity: 0.9; }
  .btn.success { background: #27ae60; }
  .btn.danger { background: #e74c3c; }
  .btn.warning { background: #f39c12; }
  .btn.secondary { background: #95a5a6; }
  .tag-buttons {
    display: flex; flex-wrap: wrap; gap: 3px; margin-top: 6px; max-height: 180px; overflow-y: auto; padding: 6px; background: #f8f9fa; border-radius: 6px; -webkit-overflow-scrolling: touch;
  }
  .tag-buttons .btn {
    background: #e8f4f8; color: #2c3e50; font-size: 10px; padding: 5px 8px; border-radius: 10px; border: 1px solid #3498db; min-height: 30px;
  }
  .tag-buttons .btn:active { background: #3498db; color: #fff; }
  .main-buttons { margin-top: 8px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; }
  .main-buttons .btn { padding: 10px 8px; font-size: 11px; }
  .stats { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 6px; margin-bottom: 8px; }
  .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; padding: 8px; border-radius: 6px; text-align: center; }
  .stat-value { font-size: 16px; font-weight: 700; margin-bottom: 2px; }
  .stat-label { font-size: 8px; opacity: 0.9; }
  .timeline { max-height: 35vh; overflow-y: auto; -webkit-overflow-scrolling: touch; }
  ul.log { list-style: none; display: flex; flex-direction: column; gap: 5px; }
  .row {
    padding: 6px; border-left: 3px solid #3498db; border-radius: 5px; background: #f8f9fa; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
  }
  .row:active { background: #fff; }
  .row.selected {
    background: #e8f4f8; border-left-color: #e74c3c; box-shadow: 0 2px 4px rgba(231,76,60,0.15);
  }
  .row.ai-corrected { border-left-color: #9b59b6; }
  .row.user-learned { border-left-color: #f39c12; }
  .time { font-size: 10px; color: #3498db; margin-bottom: 3px; font-weight: 700; display: flex; align-items: center; gap: 4px; }
  .elapsed { font-size: 8px; color: #7f8c8d; font-weight: 500; background: #ecf0f1; padding: 1px 5px; border-radius: 6px; }
  .addr { font-size: 10px; color: #2c3e50; margin: 2px 0 4px; padding-left: 4px; border-left: 2px solid #27ae60; background: #eef9f1; border-radius: 3px; }
  .addr.muted { opacity: 0.35; border-left-color: #bdc3c7; background: #f3f4f6; }
  .text { white-space: pre-wrap; word-break: break-word; font-size: 12px; margin-bottom: 3px; color: #2c3e50; line-height: 1.4; }
  .tags { margin-top: 3px; display: flex; flex-wrap: wrap; gap: 3px; }
  .tag { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; border-radius: 8px; padding: 1px 6px; font-size: 8px; font-weight: 600; }
  .row .tools { position: absolute; top: 4px; right: 4px; display: flex; gap: 3px; opacity: 0.8; }
  .row.selected .tools { opacity: 1; }
  .tools .btn { font-size: 9px; padding: 3px 6px; min-height: 28px; }
  .empty-state { text-align: center; padding: 25px 12px; color: #7f8c8d; font-size: 12px; }
  .ai-badge { font-size: 7px; background: #9b59b6; color: #fff; padding: 1px 4px; border-radius: 4px; margin-left: 4px; }
  .learn-badge { font-size: 7px; background: #f39c12; color: #fff; padding: 1px 4px; border-radius: 4px; margin-left: 4px; }
  
  /* ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« */
  .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
  .modal.show { display: flex; align-items: center; justify-content: center; }
  .modal-content { background: #fff; border-radius: 8px; padding: 16px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; }
  .modal-header { font-size: 14px; font-weight: 700; margin-bottom: 12px; color: #2c3e50; }
  .modal-body textarea { width: 100%; min-height: 100px; margin-bottom: 12px; }
  .modal-buttons { display: flex; gap: 8px; }
  .modal-buttons .btn { flex: 1; }
  
  @media (min-width: 768px){
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    textarea { min-height: 90px; }
    .timeline { max-height: 55vh; }
    h1 { font-size: 16px; }
    .clock { font-size: 20px; }
  }
</style>
</head>
<body>
  <header>
    <div class="header-content">
      <h1>ğŸš‘ æ•‘æ€¥è¨˜éŒ² (AI v2.3.3<span class="version">ç—‡çŠ¶èªè­˜å¼·åŒ–</span>)</h1>
      <div class="clock" id="clock">--:--:--</div>
    </div>
  </header>

  <div class="wrap">
    <div class="grid">
      <section class="card">
        <h2>ğŸ“ å…¥åŠ›</h2>
        <div class="body">
          <div class="voice-control">
            <button id="voiceBtn" type="button" class="voice-btn">ğŸ¤</button>
            <div class="voice-status">
              <div class="voice-status-title" id="voiceStatusTitle">åœæ­¢ä¸­</div>
              <div class="voice-status-text" id="voiceStatusText">ã‚¿ãƒƒãƒ—ã§é–‹å§‹</div>
              <div class="confidence-bar" id="confidenceBar">
                <div class="confidence-fill" id="confidenceFill" style="width: 0%"></div>
              </div>
              <div class="ai-indicator" id="aiIndicator"></div>
              <div class="voice-interim" id="voiceInterim"></div>
            </div>
          </div>

          <textarea id="input" placeholder="éŒ²éŸ³ãƒ‡ãƒ¼ã‚¿ã¯ã“ã“ã«ä¸€æ™‚çš„ã«è¡¨ç¤ºã•ã‚Œã¾ã™"></textarea>

          <div id="suggestions" class="suggestions" style="display:none;">
            <div class="suggestions-title">ğŸ’¡ å€™è£œ</div>
            <div id="suggestionItems"></div>
          </div>

          <div class="controls">
            <label class="pill">â± <select id="idleSec"></select></label>
            <label class="pill">ğŸ“ <input id="minLen" type="number" min="1" max="20" value="2"></label>
            <label class="pill"><input id="punct" type="checkbox" checked> å¥ç‚¹ã§ç¢ºå®š</label>
            <label class="pill"><input id="gpsHi" type="checkbox" checked> GPS</label>
            <label class="pill">â³ <input id="gpsTimeout" type="number" min="2" max="20" value="6"> ç§’</label>
            <label class="pill"><input id="aiMode" type="checkbox" checked> ğŸ§  AIè£œæ­£</label>
            <label class="pill"><input id="learnMode" type="checkbox" checked> ğŸ“š å­¦ç¿’</label>
          </div>

          <div class="tag-buttons" id="tagButtons"></div>

          <div class="main-buttons">
            <button id="btnCopy" type="button" class="btn success" title="ä½æ‰€ãªã—ã§ã‚³ãƒ”ãƒ¼">ğŸ“‹ ã‚³ãƒ”ãƒ¼(ä½æ‰€ãªã—)</button>
            <button id="btnCopyAddr" type="button" class="btn success" title="ä½æ‰€ä»˜ãã§ã‚³ãƒ”ãƒ¼">ğŸ“‹ ã‚³ãƒ”ãƒ¼(ä½æ‰€ã‚ã‚Š)</button>
            <button id="btnClear" type="button" class="btn danger">ğŸ—‘ å…¨æ¶ˆå»</button>
          </div>
        </div>
      </section>

      <section class="card">
        <h2>â° è¨˜éŒ²</h2>
        <div class="body">
          <div class="stats">
            <div class="stat-card">
              <div class="stat-value" id="totalLogs">0</div>
              <div class="stat-label">ä»¶æ•°</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="totalTime">0åˆ†</div>
              <div class="stat-label">çµŒé</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="aiCorrections">0</div>
              <div class="stat-label">AIè£œæ­£</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="userLearned">0</div>
              <div class="stat-label">å­¦ç¿’</div>
            </div>
          </div>
          <div class="timeline">
            <ul id="log" class="log"></ul>
          </div>
        </div>
      </section>
    </div>
  </div>

  <div id="editModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">ğŸ“ è¨˜éŒ²ã‚’ç·¨é›†</div>
      <div class="modal-body">
        <textarea id="editText" placeholder="è¨˜éŒ²ã‚’ç·¨é›†..."></textarea>
      </div>
      <div class="modal-buttons">
        <button id="btnSaveEdit" type="button" class="btn success">ğŸ’¾ ä¿å­˜</button>
        <button id="btnCancelEdit" type="button" class="btn secondary">âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>

<script>
  const STORE_KEY='emergency-doc-ultra-v3';
  let logs=[]; let selectedId=null; let startTime=null; let aiCorrectionCount=0; let userLearnedCount=0;
  let editingLogId=null;
  let saveDebounceTimer = null; 

  /* ====== ã€v2.3.3å¼·åŒ–ã€‘TAGSã«ã€Œèƒ¸ç—›ã€ã‚’è¿½åŠ  ====== */
  const TAGS=[
    "æ•‘æ€¥è¦šçŸ¥","æ•‘æ€¥æŒ‡ä»¤","æ•‘æ€¥å‡ºå‹•","æ•‘æ€¥ç¾ç€","æ•‘æ€¥æ¥è§¦","è»Šå†…åå®¹","ç¾ç™º","ç—…ç€",
    "ãƒ˜ãƒªè¦šçŸ¥","ãƒ˜ãƒªæŒ‡ä»¤","ãƒ˜ãƒªå‡ºå‹•","ãƒ˜ãƒªç¾ç€","ãƒ•ãƒ©ã‚¤ãƒˆãƒ‰ã‚¯ã‚¿ãƒ¼æ¥è§¦","ãƒ©ãƒ³ãƒ‡ãƒ–ãƒ¼ãƒã‚¤ãƒ³ãƒˆç€",
    "ã‚«ãƒ¼è¦šçŸ¥","ã‚«ãƒ¼æŒ‡ä»¤","ã‚«ãƒ¼å‡ºå‹•","ã‚«ãƒ¼ç¾ç€","ã‚«ãƒ¼æ¥è§¦","ãƒ‰ãƒƒã‚­ãƒ³ã‚°","åŒ»å¸«æ¥è§¦",
    
    // v2.3.2è¿½åŠ  + v2.3.3ã€Œèƒ¸ç—›ã€è¿½åŠ 
    "ä¸»è¨´","ç¾ç—…æ­´","æ—¢å¾€æ­´","å¸¸ç”¨è–¬","ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼","ç”Ÿæ´»æ­´","ADL", "èƒ¸ç—›",
    "èº«ä½“æ‰€è¦‹",

    "æ°—ç®¡æŒ¿ç®¡","äººå·¥å‘¼å¸","ãƒãƒƒã‚¯ãƒãƒ«ãƒ–ãƒã‚¹ã‚¯æ›æ°—","é…¸ç´ æŠ•ä¸","é…¸ç´ æŠ•ä¸é‡","NPPV",
    "ãƒ«ãƒ¼ãƒˆç¢ºä¿","ç”Ÿé£Ÿç‚¹æ»´","ã‚½ãƒ«ã‚¢ã‚»ãƒˆFç‚¹æ»´","å¤§è…¿å‹•è„ˆ","å¤§è…¿é™è„ˆ","éª¨é«„é‡",

    // v2.3.2è¿½åŠ  (ä¸€éƒ¨æ—¢å­˜)
    "è¡€æ¶²ã‚¬ã‚¹åˆ†æ","è¡€ç³–","ç°¡æ˜“è¶…éŸ³æ³¢æ¤œæŸ»","12èª˜å°å¿ƒé›»å›³","è¶…éŸ³æ³¢æ¤œæŸ»",

    "èƒ¸éª¨åœ§è¿«","é–‹èƒ¸","å¿ƒè‡“ãƒãƒƒã‚µãƒ¼ã‚¸",
    "ã‚¢ãƒ‰ãƒ¬ãƒŠãƒªãƒ³","ãƒŸãƒ€ã‚¾ãƒ©ãƒ ","ã‚¸ã‚¢ã‚¼ãƒ‘ãƒ ","ã‚¤ãƒ¼ã‚±ãƒ—ãƒ©","ãƒãƒ«ã‚¢ãƒ‰ãƒ¬ãƒŠãƒªãƒ³","ãƒ¬ãƒšã‚¿ãƒ³"
  ];

  /* ====== ã€v2.3.3å¼·åŒ–ã€‘åŒ»ç™‚ç”¨èªè¾æ›¸ã«ã€Œèƒ¸ç—›ã€é–¢é€£ã‚’è¿½åŠ  ====== */
  const MEDICAL_CORRECTIONS = {
    // v2.3.3è¿½åŠ : èƒ¸ç—›
    "ãã‚‡ã†ã¤ã†": "èƒ¸ç—›", "å…±é€š": "èƒ¸ç—›", // ã€Œå…±é€šã€ã¯æ–‡è„ˆåˆ¤æ–­ã«ä»»ã›ã‚‹ãŒã€è¾æ›¸ã«ã‚‚è¿½åŠ 
    "å…±é€šãŒ": "èƒ¸ç—›ãŒ", "å…±é€šã‚’": "èƒ¸ç—›ã‚’", "å…±é€šã®": "èƒ¸ç—›ã®",

    // v2.3.2è¿½åŠ : å¿…é ˆåŒ»ç™‚ç”¨èª
    "ã—ã‚…ã": "ä¸»è¨´", "ä¸»è¨´ã¯": "ä¸»è¨´",
    "ã’ã‚“ã³ã‚‡ã†ã‚Œã": "ç¾ç—…æ­´", "ç¾ç—…æ­´ã¯": "ç¾ç—…æ­´",
    "ããŠã†ã‚Œã": "æ—¢å¾€æ­´", "æ—¢å¾€æ­´ã¯": "æ—¢å¾€æ­´",
    "ã˜ã‚‡ã†ã‚ˆã†ã‚„ã": "å¸¸ç”¨è–¬", "å¸¸ç”¨è–¬ã¯": "å¸¸ç”¨è–¬",
    "ã‚ã‚Œã‚‹ããƒ¼": "ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼", "ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ã¯": "ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼",
    "ã›ã„ã‹ã¤ã‚Œã": "ç”Ÿæ´»æ­´",
    "ãˆãƒ¼ã§ãƒãƒ¼ãˆã‚‹": "ADL", "adl": "ADL",
    "ã—ã‚“ãŸã„ã—ã‚‡ã‘ã‚“": "èº«ä½“æ‰€è¦‹",
    "ã‘ã¤ãŒã™": "è¡€æ¶²ã‚¬ã‚¹åˆ†æ", // ã€Œè¡€ã‚¬ã‚¹ã€ã‹ã‚‰ã€Œè¡€æ¶²ã‚¬ã‚¹åˆ†æã€ã«å¼·åŒ–
    "ã‘ã£ã¨ã†": "è¡€ç³–",
    "12ã‚†ã†ã©ã†ã—ã‚“ã§ã‚“ãš": "12èª˜å°å¿ƒé›»å›³", "12èª˜å°": "12èª˜å°å¿ƒé›»å›³",
    "ã¡ã‚‡ã†ãŠã‚“ã±": "è¶…éŸ³æ³¢æ¤œæŸ»", "ã‚¨ã‚³ãƒ¼": "è¶…éŸ³æ³¢æ¤œæŸ»", "ç°¡æ˜“è¶…éŸ³æ³¢": "ç°¡æ˜“è¶…éŸ³æ³¢æ¤œæŸ»",

    // v2.3.1ã‹ã‚‰ã®ç¶™ç¶š: é‡è¦ãªåŒéŸ³ç•°ç¾©èªãƒ»èª¤èªè­˜
    "ã—ãƒ¼ã´ãƒ¼ãˆãƒ¼":"CPA","å¿ƒé…åœæ­¢":"å¿ƒè‚ºåœæ­¢","å¿ƒè‚ºè˜‡ç”Ÿ":"å¿ƒè‚ºåœæ­¢","å¿ƒè‚ºè£…ç½®":"å¿ƒè‚ºåœæ­¢","å¿ƒé…è£…ç½®":"å¿ƒè‚ºåœæ­¢",
    "æ°—ç®¡ç·ç›£":"æ°—ç®¡æŒ¿ç®¡","æ°—ç®¡å‰µåˆŠ":"æ°—ç®¡æŒ¿ç®¡","æ°—ç®¡ç›¸é–¢":"æ°—ç®¡æŒ¿ç®¡","æ°—ç®¡ç·åˆŠ":"æ°—ç®¡æŒ¿ç®¡",
    "ã‚‹ãƒ¼ã¨ã‹ãã»":"ãƒ«ãƒ¼ãƒˆç¢ºä¿","ã‚‹ãƒ¼ã¨ç¢ºä¿":"ãƒ«ãƒ¼ãƒˆç¢ºä¿","ãƒ«ãƒ¼ãƒˆè§’ç©‚":"ãƒ«ãƒ¼ãƒˆç¢ºä¿",
    "æ„è­˜ãƒ¬ãƒ™ãƒ«":"JCS","ã„ã—ãã‚Œã¹ã‚‹":"JCS",
    "æ„è­˜":"ä¼Šæ•·", // é€šå¸¸ã®èª¤èªè­˜ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ã—ã¦æ®‹ã™

    // ä¸€èˆ¬çš„ãªåŒ»ç™‚ç”¨èªã®èª¤èªè­˜
    "ã¼ã™ã¿ã‚“":"ãƒœã‚¹ãƒŸãƒ³","ã•ã¡ã‚…ã‚Œãƒ¼ã—ã‚‡ã‚“":"ã‚µãƒãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³","ãˆã™ã´ãƒ¼ãŠãƒ¼ã¤ãƒ¼":"SpO2","ã˜ã‡ãƒ¼ã—ãƒ¼ãˆã™":"JCS",
    "ã˜ãƒ¼ã—ãƒ¼ãˆã™":"GCS","ç”Ÿè·":"ç”Ÿé£Ÿ","èƒ¸éª¨åšè¿«":"èƒ¸éª¨åœ§è¿«","èƒ¸éª¨ã‚ã£ã±ã":"èƒ¸éª¨åœ§è¿«",
    "é™¤å‚µå‹•":"é™¤ç´°å‹•","ã˜ã‚‡ã•ã„ã©ã†":"é™¤ç´°å‹•","ã˜ã‚‡ã•ã„ã©":"é™¤ç´°å‹•","é™¤ç´°åŒ":"é™¤ç´°å‹•",
    "ã«ã£ã·ã¶":"NPPV",
    "ãƒ‰ã‚¯ã‚¿ãƒ¼æ¥è§¦":"åŒ»å¸«æ¥è§¦","ãƒ•ãƒ©ã‚¤ãƒˆãƒ‰ã‚¯ã‚¿ãƒ¼":"ãƒ•ãƒ©ã‚¤ãƒˆãƒ‰ã‚¯ã‚¿ãƒ¼æ¥è§¦",
    
    // é¹¿å…å³¶å¸‚æ•‘æ€¥éšŠåã®éŸ³å£°èª¤èªè­˜ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆæœ€é‡è¦ï¼‰
    "ãªã‚“ã‚Šã‚“ã˜":"å—æ—å¯º","ãªã‚“ã‚Šã‚“":"å—æ—å¯º","å—æ—":"å—æ—å¯º","ã“ã†ãªã‚“":"ç”²å—","æ±Ÿå—":"ç”²å—","æ¸¯å—":"ç”²å—","æ¹–å—":"ç”²å—",
    "ã‹ã¿ã¾ã¡":"ä¸Šç”º","ã‹ã¿ã¾ã¡":"ä¸Šç”º","ã‚ˆã—ã®":"å‰é‡","ã‚ˆã—ã ":"å‰ç”°","ã•ãã‚‰ã˜ã¾ã²ãŒã—":"æ¡œå³¶æ±",
    "ã•ãã‚‰ã˜ã¾ã«ã—":"æ¡œå³¶è¥¿","ã„ã—ã":"ä¼Šæ•·","ã¾ã¤ã‚‚ã¨":"æ¾å…ƒ","ã“ãŠã‚Šã‚„ã¾":"éƒ¡å±±","ãŸã«ã‚„ã¾":"è°·å±±",
    "ãŸã«ã‚„ã¾ããŸ":"è°·å±±åŒ—","ã“ãŠã‚Šã‚‚ã¨":"éƒ¡å…ƒ","ãã„ã‚Œ":"å–œå…¥","ä¸­å¤®æ¶ˆé˜²ç½²":"ä¸­å¤®æ¶ˆé˜²ç½²","è¥¿æ¶ˆé˜²ç½²":"è¥¿æ¶ˆé˜²ç½²","å—æ¶ˆé˜²ç½²":"å—æ¶ˆé˜²ç½²"
  };

  const KAGOSHIMA_EMERGENCY_TEAMS = [
    "å—æ—å¯º", "ç”²å—", "ä¸Šç”º", "å‰é‡", "å‰ç”°", "æ¡œå³¶æ±", "æ¡œå³¶è¥¿",
    "ä¼Šæ•·", "æ¾å…ƒ", "éƒ¡å±±",
    "è°·å±±", "è°·å±±åŒ—", "éƒ¡å…ƒ", "å–œå…¥",
    "ä¸­å¤®æ¶ˆé˜²ç½²", "è¥¿æ¶ˆé˜²ç½²", "å—æ¶ˆé˜²ç½²", "ä¸­å¤®æœ¬ç½²"
  ];
  const BLACKLIST_WORDS = [
    "æ±Ÿå—å¸‚", "æ¹–å—çœ", "æ¸¯å—åŒº", "æ±Ÿå—åŒº", "åå±±æ•‘æ€¥", "æ˜å’Œæ•‘æ€¥", "ç”°ä¸Šæ•‘æ€¥", "è„‡ç”°æ•‘æ€¥",
    "ä¼šè­°", "æ‰“ã¡åˆã‚ã›", "ãƒ—ãƒ¬ã‚¼ãƒ³", "å–¶æ¥­", "å¥‘ç´„", "ãƒ©ãƒ³ãƒ", "ãƒ‡ã‚£ãƒŠãƒ¼", 
    "æ˜ ç”»", "ãƒ‰ãƒ©ãƒ", "ã‚¢ãƒ‹ãƒ¡", "ã‚²ãƒ¼ãƒ ", "ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°", "è²·ã„ç‰©"
  ];

  /* v2.3.1ã§ä¿®æ­£æ¸ˆã¿ã®é–¢æ•° */
  function containsBlacklistedWord(text) {
    const lowerText = text.toLowerCase();
    for (const word of BLACKLIST_WORDS) {
      if (lowerText.includes(word.toLowerCase())) {
        return word;
      }
    }
    return null;
  }

  function detectAndCorrectEmergencyTeam(text) {
    let corrected = text;
    
    const VOICE_COMMON_ERRORS = {
      "æ±Ÿå—": "ç”²å—", "æ¸¯å—": "ç”²å—", "æ¹–å—": "ç”²å—", "ã“ã†ãªã‚“": "ç”²å—", "æ„è­˜": "ä¼Šæ•·", "æ°—å…¥ã‚Œ": "å–œå…¥", 
      "å¿ƒé…": "å¿ƒè‚º", "ç›¸é–¢": "æŒ¿ç®¡", "ç·ç›£": "æŒ¿ç®¡", "å‰µåˆŠ": "æŒ¿ç®¡", "åšè¿«": "åœ§è¿«"
    };
    
    for (const [wrong, correct] of Object.entries(VOICE_COMMON_ERRORS)) {
      const regex = new RegExp(wrong, 'gi');
      if (regex.test(corrected)) {
        corrected = corrected.replace(regex, correct);
      }
    }
    
    const patterns = [
      /(.{2,4}?)(æ•‘æ€¥|éšŠ|æ¶ˆé˜²)/g,
      /(.{2,4}?)æ•‘æ€¥è»Š/g
    ];
    
    for (const pattern of patterns) {
      const matches = [...corrected.matchAll(pattern)];
      
      for (const match of matches) {
        const teamNamePart = match[1].trim();
        let bestMatch = null;
        let bestScore = 0;
        
        for (const validTeam of KAGOSHIMA_EMERGENCY_TEAMS) {
          const score = similarityScore(teamNamePart, validTeam);
          
          if (score > bestScore && score > 0.35) {
            bestScore = score;
            bestMatch = validTeam;
          }
        }
        
        if (bestMatch) {
          corrected = corrected.replace(match[0], bestMatch + (match[2] || ''));
        }
      }
    }
    
    return corrected;
  }

  function getMedicalDomainScore(text) {
    let score = 0;
    const lowerText = text.toLowerCase();
    
    const medicalKeywords = [
      'cpa', 'å¿ƒè‚ºåœæ­¢', 'æŒ¿ç®¡', 'ãƒ«ãƒ¼ãƒˆ', 'ç‚¹æ»´', 'è¡€åœ§', 'spo2',
      'å‘¼å¸', 'æ„è­˜', 'jcs', 'gcs', 'èƒ¸éª¨', 'åœ§è¿«', 'é™¤ç´°å‹•',
      'ãƒã‚¤ã‚¿ãƒ«', 'è¦³å¯Ÿ', 'å‡¦ç½®', 'æŠ•ä¸', 'æ•‘æ€¥', 'ç¾ç€', 'è¦šçŸ¥',
      'å‡ºå‹•', 'æ¬é€', 'ç—…ç€', 'hr', 'bp', 'rr', 'bt', 'æ¥è§¦',
      'åŒ»å¸«', 'ãƒ‰ã‚¯ã‚¿ãƒ¼', 'ãƒ˜ãƒª', 'ã‚«ãƒ¼', 'ãƒ©ãƒ³ãƒ‡ãƒ–ãƒ¼',
      'ä¸»è¨´', 'ç¾ç—…æ­´', 'æ—¢å¾€æ­´', 'å¸¸ç”¨è–¬', 'ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼', 'adl', 'èº«ä½“æ‰€è¦‹', 'è¡€æ¶²ã‚¬ã‚¹', 'å¿ƒé›»å›³', 'è¶…éŸ³æ³¢',
      'èƒ¸ç—›' // v2.3.3è¿½åŠ 
    ];
    
    for (const keyword of medicalKeywords) {
      if (lowerText.includes(keyword)) {
        score += 0.08;
      }
    }
    
    for (const team of KAGOSHIMA_EMERGENCY_TEAMS) {
      if (text.includes(team)) {
        score += 0.2;
        break;
      }
    }
    
    return Math.min(1.0, score);
  }

  /* ====== ã€v2.3.3å¼·åŒ–ã€‘NGRAMSã«ã€Œèƒ¸ç—›ã€é–¢é€£ã‚’è¿½åŠ  ====== */
  const NGRAMS = {
    "æ•‘æ€¥ è¦šçŸ¥": 0.95, "æ•‘æ€¥ ç¾ç€": 0.95, "æ°—ç®¡ æŒ¿ç®¡": 0.90, "ãƒ«ãƒ¼ãƒˆ ç¢ºä¿": 0.90, 
    "èƒ¸éª¨ åœ§è¿«": 0.95, "è¡€åœ§ æ¸¬å®š": 0.85, "SpO2 æ¸¬å®š": 0.85, "JCS 3": 0.80,
    "GCS 15": 0.80, "ç”Ÿé£Ÿ ç‚¹æ»´": 0.85, "åŒ»å¸« æ¥è§¦": 0.90, "è»Šå†… åå®¹": 0.90,
    "å¿ƒè‚º åœæ­¢": 0.95, "ãƒãƒ« ã‚¢ãƒ‰ãƒ¬ãƒŠãƒªãƒ³": 0.90, "äººå·¥ å‘¼å¸": 0.85,

    // v2.3.2è¿½åŠ 
    "ä¸»è¨´ ã¯": 0.9, "ç¾ç—…æ­´ ã¯": 0.9, "æ—¢å¾€æ­´ ã«": 0.9, "å¸¸ç”¨è–¬ ã¯": 0.9, 
    "ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ ã¯": 0.9, "ADL ã¯": 0.9, "èº«ä½“æ‰€è¦‹": 0.9, "è¡€æ¶²ã‚¬ã‚¹åˆ†æ": 0.9, 
    "12èª˜å°å¿ƒé›»å›³": 0.9, "è¶…éŸ³æ³¢æ¤œæŸ»": 0.85,

    // v2.3.3è¿½åŠ 
    "èƒ¸ç—› ãŒ": 0.9, "èƒ¸ç—› ã‚’": 0.9
  };

  class ContextEngine {
    constructor() {
      this.history = [];
      this.currentPhase = 'initial';
      this.expectedNext = [];
    }
    
    addToHistory(text) {
      this.history.push({
        text: text,
        time: Date.now(),
        phase: this.currentPhase
      });
      
      if (this.history.length > 50) {
        this.history.shift();
      }
      
      this.updatePhase(text);
      this.updateExpectedNext();
    }
    
    /* ====== ã€v2.3.2å¼·åŒ–ã€‘ContextEngineã®ãƒ•ã‚§ãƒ¼ã‚ºèªè­˜ã‚’å¼·åŒ– ====== */
    updatePhase(text) {
      if (text.includes('è¦šçŸ¥') || text.includes('æŒ‡ä»¤')) {
        this.currentPhase = 'dispatch';
        this.expectedNext = ['å‡ºå‹•', 'ç¾ç€', 'åˆ°ç€'];
      } else if (text.includes('å‡ºå‹•')) {
        this.currentPhase = 'enroute';
        this.expectedNext = ['ç¾ç€', 'åˆ°ç€', 'æ¥è§¦'];
      } else if (text.includes('ç¾ç€') || text.includes('åˆ°ç€')) {
        this.currentPhase = 'onscene';
        this.expectedNext = ['æ¥è§¦', 'è¦³å¯Ÿ', 'ãƒã‚¤ã‚¿ãƒ«', 'å‡¦ç½®', 'æ„è­˜', 'ä¸»è¨´', 'ç¾ç—…æ­´', 'æ—¢å¾€æ­´', 'èƒ¸ç—›'];
      } else if (text.includes('ä¸»è¨´') || text.includes('ç¾ç—…æ­´') || text.includes('æ—¢å¾€æ­´') || text.includes('èƒ¸ç—›')) {
        this.currentPhase = 'onscene'; // ç¾å ´ã§ã®æƒ…å ±åé›†
        this.expectedNext = ['ãƒã‚¤ã‚¿ãƒ«', 'å‡¦ç½®', 'èº«ä½“æ‰€è¦‹', 'å¸¸ç”¨è–¬', 'ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼'];
      } else if (text.includes('å‡¦ç½®') || text.includes('æŒ¿ç®¡') || text.includes('ãƒ«ãƒ¼ãƒˆ') || text.includes('èº«ä½“æ‰€è¦‹')) {
        this.currentPhase = 'treatment';
        this.expectedNext = ['åŠ¹æœ', 'æ”¹å–„', 'æ¬é€', 'ç—…ç€', 'HR', 'BP', 'JCS', 'è¡€æ¶²ã‚¬ã‚¹', 'å¿ƒé›»å›³'];
      } else if (text.includes('æ¬é€') || text.includes('è»Šå†…')) {
        this.currentPhase = 'transport';
        this.expectedNext = ['ç—…ç€', 'åˆ°ç€', 'å¼•ç¶™'];
      } else if (text.includes('ç—…ç€')) {
        this.currentPhase = 'complete';
        this.expectedNext = ['å¼•ç¶™', 'å®Œäº†'];
      }
    }
    
    updateExpectedNext() {
      const recent = this.history.slice(-5).map(h => h.text).join(' ');
      
      if (recent.includes('è¡€åœ§') || recent.includes('HR')) {
        this.expectedNext.push('SpO2', 'RR', 'BT', 'JCS');
      }
      
      if (recent.includes('æŒ¿ç®¡') || recent.includes('ãƒ«ãƒ¼ãƒˆ') || recent.includes('ç‚¹æ»´')) {
        this.expectedNext.push('ç¢ºèª', 'æˆåŠŸ', 'è‰¯å¥½', 'æ”¹å–„');
      }
      
      // é‡è¤‡ã‚’å‰Šé™¤
      this.expectedNext = [...new Set(this.expectedNext)];
    }
    
    getContextScore(text) {
      let score = 0.5;
      
      for (const expected of this.expectedNext) {
        if (text.includes(expected)) {
          score += 0.1;
        }
      }
      
      if (this.currentPhase === 'onscene' && (text.includes('ãƒã‚¤ã‚¿ãƒ«') || text.includes('è¦³å¯Ÿ') || text.includes('ä¸»è¨´') || text.includes('æ—¢å¾€æ­´') || text.includes('èƒ¸ç—›'))) {
        score += 0.15;
      }
      if (this.currentPhase === 'treatment' && (text.includes('å‡¦ç½®') || text.includes('æŠ•ä¸') || text.includes('èº«ä½“æ‰€è¦‹'))) {
        score += 0.15;
      }
      
      return Math.min(1.0, score);
    }
  }

  function levenshteinDistance(str1, str2) {
    const len1 = str1.length;
    const len2 = str2.length;
    const matrix = [];
    
    for (let i = 0; i <= len1; i++) {
      matrix[i] = [i];
    }
    
    for (let j = 0; j <= len2; j++) {
      matrix[0][j] = j;
    }
    
    for (let i = 1; i <= len1; i++) {
      for (let j = 1; j <= len2; j++) {
        if (str1.charAt(i - 1) === str2.charAt(j - 1)) {
          matrix[i][j] = matrix[i - 1][j - 1];
        } else {
          matrix[i][j] = Math.min(
            matrix[i - 1][j - 1] + 1,
            matrix[i][j - 1] + 1,
            matrix[i - 1][j] + 1
          );
        }
      }
    }
    
    return matrix[len1][len2];
  }

  function similarityScore(str1, str2) {
    const distance = levenshteinDistance(str1.toLowerCase(), str2.toLowerCase());
    const maxLen = Math.max(str1.length, str2.length);
    return 1 - (distance / maxLen);
  }

  /* ====== ã€v2.3.3å¼·åŒ–ã€‘ã€Œèƒ¸ç—› vs å…±é€šã€ã®æ–‡è„ˆè£œæ­£ã‚’è¿½åŠ  ====== */
  function checkHomophoneContextCorrection(text, contextEngine) {
      let corrected = text;
      let boost = 0;
      
      // 1. ä¼Šæ•·ï¼ˆåœ°åï¼‰ vs æ„è­˜ï¼ˆæ„è­˜ãƒ¬ãƒ™ãƒ«ï¼‰
      if (corrected.includes('æ„è­˜')) {
          if (contextEngine.currentPhase === 'dispatch' || contextEngine.currentPhase === 'enroute') {
              if (similarityScore(corrected, 'ä¼Šæ•·') > 0.6) {
                  corrected = corrected.replace(/æ„è­˜/g, 'ä¼Šæ•·');
                  boost += 0.25;
                  console.log("  ğŸ§  æ–‡è„ˆè£œæ­£: 'æ„è­˜' â†’ 'ä¼Šæ•·' (åœ°åå„ªå…ˆ)");
              }
          }
      } else if (corrected.includes('ä¼Šæ•·')) {
          if (contextEngine.currentPhase === 'onscene' || contextEngine.currentPhase === 'treatment') {
              if (similarityScore(corrected, 'æ„è­˜') > 0.6) {
                  boost += 0.1;
              }
          }
      }
      
      // 2. å¿ƒé… vs å¿ƒè‚º
      if (corrected.includes('å¿ƒé…') && contextEngine.currentPhase !== 'initial') {
          const regex = /å¿ƒé…/g;
          if (regex.test(corrected)) {
              corrected = corrected.replace(regex, 'å¿ƒè‚º');
              boost += 0.2; 
              console.log("  ğŸ§  æ–‡è„ˆè£œæ­£: 'å¿ƒé…' â†’ 'å¿ƒè‚º'");
          }
      }
      
      // 3. å…±é€š vs èƒ¸ç—› (v2.3.3è¿½åŠ )
      if (corrected.includes('å…±é€š')) {
          // ç¾å ´åˆ°ç€ï½å‡¦ç½®ãƒ•ã‚§ãƒ¼ã‚ºã§ã®ã€Œå…±é€šã€ã¯ã€Œèƒ¸ç—›ã€ã®å¯èƒ½æ€§ãŒæ¥µã‚ã¦é«˜ã„
          if (contextEngine.currentPhase === 'onscene' || contextEngine.currentPhase === 'treatment' || contextEngine.currentPhase === 'enroute') {
              const regex = /å…±é€š/g;
              if (regex.test(corrected)) {
                  corrected = corrected.replace(regex, 'èƒ¸ç—›');
                  boost += 0.25; // å¼·åŠ›ã«ãƒ–ãƒ¼ã‚¹ãƒˆ
                  console.log("  ğŸ§  æ–‡è„ˆè£œæ­£: 'å…±é€š' â†’ 'èƒ¸ç—›' (ç—‡çŠ¶å„ªå…ˆ)");
              }
          }
      }

      return { corrected, boost };
  }

  class AICorrection {
    constructor() {
      this.contextEngine = new ContextEngine();
      this.userPatterns = {};
      this.userCorrections = {};
    }
    
    selectBestCandidate(alternatives, interimText='') {
      if (!alternatives || alternatives.length === 0) return null;
      
      let bestScore = -1;
      let bestCandidate = alternatives[0];
      
      const aiMode = document.getElementById('aiMode')?.checked;
      if (!aiMode) {
        return {
          text: alternatives[0].transcript,
          confidence: alternatives[0].confidence,
          aiCorrected: false,
          method: 'basic'
        };
      }
      
      console.log('ğŸ§  AIè£œæ­£ã‚¨ãƒ³ã‚¸ãƒ³èµ·å‹• (v2.3.3 - ç—‡çŠ¶èªè­˜å¼·åŒ–)');
      
      const filteredAlternatives = [];
      
      for (let i = 0; i < alternatives.length; i++) {
        const alt = alternatives[i];
        const text = alt.transcript;
        
        const blacklisted = containsBlacklistedWord(text);
        if (blacklisted) {
          console.log(`  ğŸš« å€™è£œ${i+1}: "${text}" - ç¦æ­¢ãƒ¯ãƒ¼ãƒ‰æ¤œå‡º (${blacklisted})`);
          continue;
        }
        
        filteredAlternatives.push(alt);
      }
      
      const candidatesToEvaluate = filteredAlternatives.length > 0 ? filteredAlternatives : alternatives;
      
      for (let i = 0; i < candidatesToEvaluate.length; i++) {
        const alt = candidatesToEvaluate[i];
        let score = alt.confidence || 0.5;
        
        let text = alt.transcript;
        
        // 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼å­¦ç¿’æ¸ˆã¿ä¿®æ­£ã‚’é©ç”¨
        if (this.userCorrections[text]) {
          const learnedCorrection = this.userCorrections[text];
          text = learnedCorrection;
          score += 0.4;
        }
        
        // 2. æ•‘æ€¥éšŠåãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œå‡ºï¼†è£œæ­£
        const correctedTeamText = detectAndCorrectEmergencyTeam(text);
        if (correctedTeamText !== text) {
          text = correctedTeamText;
          score += 0.3;
        }

        // 3. ã€v2.3ã€‘çŸ­æ–‡ã®å¼·åˆ¶è£œæ­£ãƒ­ã‚¸ãƒƒã‚¯
        if (text.length <= 6 && score < 0.95) { 
            const importantTerms = ['CPA', 'å¿ƒè‚ºåœæ­¢', 'æŒ¿ç®¡', 'ãƒ«ãƒ¼ãƒˆç¢ºä¿', 'ç”²å—', 'å—æ—å¯º', 'ä¸»è¨´', 'æ—¢å¾€æ­´', 'ADL', 'èƒ¸ç—›']; // v2.3.3ã€Œèƒ¸ç—›ã€è¿½åŠ 
            for (const term of importantTerms) {
                const sim = similarityScore(text, term);
                if (sim > 0.8) {
                    console.log(`  ğŸ’¥ çŸ­æ–‡å¼·åˆ¶è£œæ­£: "${text}" â†’ "${term}" (é¡ä¼¼åº¦:${sim.toFixed(2)})`);
                    text = term;
                    score += 0.6; 
                    break;
                }
            }
        }
        
        // 4. ã€v2.3.3å¼·åŒ–ã€‘åŒéŸ³ç•°ç¾©èªã®æ–‡è„ˆåˆ¤å®šè£œæ­£
        const { corrected: homophoneCorrected, boost: homophoneBoost } = checkHomophoneContextCorrection(text, this.contextEngine);
        if (homophoneCorrected !== text) {
            text = homophoneCorrected;
        }
        score += homophoneBoost;
        
        // 5. ã€v2.3.2ã€‘æ–‡è„ˆã‚¹ã‚³ã‚¢ã®åŠ ç®—
        const contextScore = this.contextEngine.getContextScore(text);
        score += contextScore * 0.25;
        
        // 6. åŒ»ç™‚ç”¨èª/ã‚¿ã‚°ã®ä¸€è‡´åº¦
        let medicalScore = 0;
        for (const term of TAGS) {
          if (text.includes(term)) {
            medicalScore += 0.1;
          }
        }
        score += Math.min(0.25, medicalScore);
        
        // 7. ã€v2.3ã€‘N-gramã‚¹ã‚³ã‚¢ã®åŠ ç®—
        let ngramScore = 0;
        for (const [ngram, weight] of Object.entries(NGRAMS)) {
          if (text.includes(ngram.replace(' ', ''))) {
            ngramScore += weight * 0.2; 
          }
        }
        score += Math.min(0.2, ngramScore);
        
        // 8. æ•‘æ€¥éšŠåã®ä¸€è‡´åº¦ï¼ˆé¡ä¼¼åº¦ï¼‰
        let similarityBest = 0;
        for (const teamName of KAGOSHIMA_EMERGENCY_TEAMS) {
          const sim = similarityScore(text, teamName);
          if (sim > similarityBest) {
            similarityBest = sim;
          }
        }
        score += similarityBest * 0.2;
        
        if (this.userPatterns[text]) {
          score += this.userPatterns[text] * 0.15;
        }
        
        // 9. ã€v2.3ã€‘ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¹ã‚³ã‚¢ã®åŠ ç®—
        const domainScore = getMedicalDomainScore(text);
        score += domainScore * 0.25; 
        
        // 10. ã€v2.3ã€‘æ•‘æ€¥éšŠåãƒœãƒ¼ãƒŠã‚¹
        for (const teamName of KAGOSHIMA_EMERGENCY_TEAMS) {
          if (text.includes(teamName)) {
            score += 0.4;
            break;
          }
        }
        
        if (score > bestScore) {
          bestScore = score;
          bestCandidate = { ...alt, transcript: text };
        }
      }
      
      const aiCorrected = bestCandidate.transcript !== alternatives[0].transcript;
      
      if (aiCorrected) {
        aiCorrectionCount++;
        document.getElementById('aiCorrections').textContent = aiCorrectionCount;
      }
      
      return {
        text: bestCandidate.transcript,
        confidence: bestScore,
        originalConfidence: bestCandidate.confidence,
        aiCorrected: aiCorrected,
        method: 'ai'
      };
    }
    
    learn(text, wasAccepted) {
      if (wasAccepted) {
        this.userPatterns[text] = (this.userPatterns[text] || 0) + 0.1;
        this.contextEngine.addToHistory(text);
      }
    }
    
    learnCorrection(original, corrected) {
      if (!document.getElementById('learnMode')?.checked) return;
      
      this.userCorrections[original] = corrected;
      userLearnedCount++;
      document.getElementById('userLearned').textContent = userLearnedCount;
      
      save(); 
    }
  }

  const aiCorrection = new AICorrection();

  /* ====== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ====== */
  function nowHHMMSS(){ const d=new Date(); return d.toLocaleTimeString('ja-JP',{hour12:false}); }
  function getElapsedMinutes(t1,t2){
    const [h1,m1,s1]=t1.split(':').map(Number); const [h2,m2,s2]=t2.split(':').map(Number);
    return Math.floor(Math.abs((h2*3600+m2*60+s2)-(h1*3600+m1*60+s1))/60);
  }
  function formatElapsed(m){ if(m<1)return'é–‹å§‹ç›´å¾Œ'; const h=Math.floor(m/60),mins=m%60; return h>0?`${h}æ™‚é–“${mins}åˆ†`:`${mins}åˆ†`; }

  function save(){ 
    clearTimeout(saveDebounceTimer);
    saveDebounceTimer = setTimeout(() => {
      localStorage.setItem(STORE_KEY, JSON.stringify({logs,startTime,aiCorrectionCount,userLearnedCount})); 
      localStorage.setItem(STORE_KEY+'_patterns', JSON.stringify(aiCorrection.userPatterns));
      localStorage.setItem(STORE_KEY+'_corrections', JSON.stringify(aiCorrection.userCorrections));
    }, 300); 
  }
  
  function load(){ 
    try{ 
      const d=JSON.parse(localStorage.getItem(STORE_KEY)); 
      if(d){ 
        logs=d.logs||[]; 
        startTime=d.startTime||null; 
        aiCorrectionCount=d.aiCorrectionCount||0;
        userLearnedCount=d.userLearnedCount||0;
        document.getElementById('aiCorrections').textContent = aiCorrectionCount;
        document.getElementById('userLearned').textContent = userLearnedCount;
      }
      const patterns=JSON.parse(localStorage.getItem(STORE_KEY+'_patterns'));
      if(patterns) aiCorrection.userPatterns = patterns;
      
      const corrections=JSON.parse(localStorage.getItem(STORE_KEY+'_correCTIONS'));
      if(corrections) aiCorrection.userCorrections = corrections;
    }catch{ 
      logs=[]; startTime=null; aiCorrectionCount=0; userLearnedCount=0;
    } 
  }

  /* ====== ãƒã‚¤ã‚¿ãƒ«ã‚µã‚¤ãƒ³ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå¼·åŒ–ï¼ˆv2.2åŒæ§˜ï¼‰ ====== */
  function formatVitalSigns(text) {
    let formatted = text;
    
    // è¡€åœ§ã¯2ã¤ã®æ•°å€¤ã‚’å«ã‚€ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆåŒºåˆ‡ã‚Šæ–‡å­—ãªã—ã®ã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šï¼‰ã‚’å„ªå…ˆçš„ã«å‡¦ç†
    formatted = formatted.replace(/(?:è¡€åœ§|BP|ãƒ“ãƒ¼ãƒ”ãƒ¼)\s*(\d{2,3})\s+(\d{2,3})(?:\s|$)/gi, 'NIBP $1/$2 mmHg');
    formatted = formatted.replace(/(?:è¡€åœ§|BP|ãƒ“ãƒ¼ãƒ”ãƒ¼)\s*(\d+)\s*(?:ã®|\/|ãƒ¼)\s*(\d+)/gi, 'NIBP $1/$2 mmHg');
    formatted = formatted.replace(/^(\d{2,3})\s*(?:ã®|\/|ãƒ¼)\s*(\d{2,3})(?:\s|$)/gm, 'NIBP $1/$2 mmHg');
    
    // è„ˆæ‹ãƒ»å¿ƒæ‹æ•°
    formatted = formatted.replace(/(?:è„ˆæ‹|å¿ƒæ‹|è„ˆ|HR|ã‚¨ã‚¤ãƒã‚¢ãƒ¼ãƒ«)\s*(\d+)/gi, 'HR $1å›/åˆ†');
    
    // ã‚µãƒãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
    formatted = formatted.replace(/(?:ã‚µãƒãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³|ã‚µãƒãƒ¥|SpO2|ã‚¨ã‚¹ãƒ”ãƒ¼ã‚ªãƒ¼ãƒ„ãƒ¼|é…¸ç´ é£½å’Œåº¦)\s*(\d+)/gi, 'SpO2 $1%');
    
    // å‘¼å¸æ•°
    formatted = formatted.replace(/(?:å‘¼å¸æ•°|å‘¼å¸|RR|ã‚¢ãƒ¼ãƒ«ã‚¢ãƒ¼ãƒ«)\s*(\d+)/gi, 'RR $1å›/åˆ†');
    
    // ä½“æ¸©
    formatted = formatted.replace(/(?:ä½“æ¸©|BT|ãƒ“ãƒ¼ãƒ†ã‚£ãƒ¼)\s*(\d+\.?\d*)/gi, 'BT $1â„ƒ');
    
    // JCS (3-3-9åº¦æ–¹å¼ã«åˆã‚ã›ã¦åˆ†é¡)
    formatted = formatted.replace(/(?:JCS|ã‚¸ã‚§ãƒ¼ã‚·ãƒ¼ã‚¨ã‚¹)\s*([1-3])(?!\d)/gi, (_m,num)=>`JCS I-${num}`);
    formatted = formatted.replace(/(?:JCS|ã‚¸ã‚§ãƒ¼ã‚·ãƒ¼ã‚¨ã‚¹)\s*(10|20|30)\b/gi, (_m,num)=>`JCS II-${num}`);
    formatted = formatted.replace(/(?:JCS|ã‚¸ã‚§ãƒ¼ã‚·ãƒ¼ã‚¨ã‚¹)\s*(100|200|300)\b/gi, (_m,num)=>`JCS III-${num}`);

    // GCS
    formatted = formatted.replace(/(?:GCS|ã‚¸ãƒ¼ã‚·ãƒ¼ã‚¨ã‚¹)\s*([3-9]|1[0-5])\b/gi, 'GCS $1ç‚¹');
    
    // ç³å­”
    formatted = formatted.replace(/ç³å­”(?:å¾„)?\s*(\d+\.?\d*)\s*(?:ãƒŸãƒª|mm)?/gi, 'ç³å­”å¾„ $1mm');
    
    // å¯¾å…‰åå°„
    formatted = formatted.replace(/å¯¾å…‰åå°„\s*(?:ã‚ã‚Š|é™½æ€§|\+|ãƒ—ãƒ©ã‚¹)/gi, 'å¯¾å…‰åå°„ +');
    formatted = formatted.replace(/å¯¾å…‰åå°„\s*(?:ãªã—|é™°æ€§|\-|ãƒã‚¤ãƒŠã‚¹)/gi, 'å¯¾å…‰åå°„ -');
    
    // è¡€ç³–å€¤
    formatted = formatted.replace(/(?:è¡€ç³–å€¤?|BS|ãƒ“ãƒ¼ã‚¨ã‚¹)\s*(\d+)/gi, 'è¡€ç³– $1mg/dL');
    
    // é…¸ç´ æŠ•ä¸
    formatted = formatted.replace(/é…¸ç´ (?:æŠ•ä¸)?\s*(\d+\.?\d*)\s*(?:ãƒªãƒƒãƒˆãƒ«|L|ãƒªãƒƒã‚¿ãƒ¼)/gi, 'O2 $1L/åˆ†');
    
    return formatted;
  }

  function enhancedNormalize(t){
    let n=t;
    
    Object.entries(MEDICAL_CORRECTIONS).forEach(([wrong, correct])=>{
      const escaped=wrong.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
      const regex=new RegExp(escaped, 'gi');
      n=n.replace(regex, correct);
    });
    
    n = n.replace(/(\d+)ã®(\d+)/g,'$1/$2');
    
    n = formatVitalSigns(n);
    
    n = n.replace(/(\d+)æ™‚(\d+)åˆ†/g,'$1:$2');
    n = n.replace(/(\d+)\s*ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆ/g,'$1%');
    n = n.replace(/(\d+)\s*(?:ãƒŸãƒªã‚°ãƒ©ãƒ |mg)/g,'$1mg');
    
    return n;
  }

  async function getPosition(opts){
    return new Promise((resolve,reject)=>{
      if(!navigator.geolocation){ reject(new Error('geolocation unsupported')); return; }
      navigator.geolocation.getCurrentPosition(resolve,reject,opts);
    });
  }

  async function reverseGeocode(lat,lon,timeoutMs=6000){
    const ctrl = new AbortController();
    const timer = setTimeout(()=>ctrl.abort(), timeoutMs);
    try{
      const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}&zoom=18&addressdetails=1&accept-language=ja`;
      const res = await fetch(url, {
        headers: {
          'Accept': 'application/json',
          'User-Agent': 'EmergencyDoc/2.3.3 (iOS Safari)' 
        },
        signal: ctrl.signal
      });
      const data = await res.json();
      
      if(data && data.address){
        const addr = data.address;
        let result = '';
        
        if(addr.city) { result = addr.city; } else if(addr.town) { result = addr.town; } 
        else if(addr.county) { result = addr.county; } else if(addr.state) { result = addr.state; }
        
        if(addr.suburb) { result += addr.suburb; } else if(addr.neighbourhood) { result += addr.neighbourhood; } 
        else if(addr.quarter) { result += addr.quarter; } else if(addr.hamlet) { result += addr.hamlet; }
        
        return result || `${lat.toFixed(5)},${lon.toFixed(5)}`;
      }
      
      return `${lat.toFixed(5)},${lon.toFixed(5)}`;
    }catch(e){
      return '';
    }finally{
      clearTimeout(timer);
    }
  }

  async function fetchAddressFromGPS(){
    try{
      const hi = document.getElementById('gpsHi').checked;
      const to = Math.max(2, Math.min(20, +document.getElementById('gpsTimeout').value || 6));
      const pos = await getPosition({ enableHighAccuracy: hi, timeout: to*1000, maximumAge: 10000 });
      const { latitude, longitude } = pos.coords;
      const addr = await reverseGeocode(latitude, longitude, to*1000);
      return addr;
    }catch(e){
      return '';
    }
  }

  function addLine(text, address='', aiCorrected=false, userLearned=false){
    const minLen = +document.getElementById('minLen').value || 2;
    const t = text.trim();
    if(!t || t.length<minLen) return;
    if(logs.length===0) startTime = nowHHMMSS();
    logs.push({ 
      id:'L'+Date.now(), 
      time:nowHHMMSS(), 
      text:t, 
      address:address||'', 
      tags:[], 
      aiCorrected: aiCorrected,
      userLearned: userLearned
    });
    
    aiCorrection.learn(t, true);
    
    save(); render(); updateStats();
  }

  function openEditModal(logId) {
    const log = logs.find(l => l.id === logId);
    if (!log) return;
    
    editingLogId = logId;
    document.getElementById('editText').value = log.text;
    document.getElementById('editModal').classList.add('show');
  }

  function closeEditModal() {
    editingLogId = null;
    document.getElementById('editModal').classList.remove('show');
  }

  function saveEdit() {
    if (!editingLogId) return;
    
    const log = logs.find(l => l.id === editingLogId);
    if (!log) return;
    
    const newText = document.getElementById('editText').value.trim();
    if (!newText) {
      alert('ç©ºç™½ã®è¨˜éŒ²ã¯ä¿å­˜ã§ãã¾ã›ã‚“');
      return;
    }
    
    if (log.text !== newText && document.getElementById('learnMode')?.checked) {
      aiCorrection.learnCorrection(log.text, newText);
      log.userLearned = true;
    }
    
    log.text = newText;
    save();
    render();
    closeEditModal();
  }

  document.getElementById('btnSaveEdit').onclick = saveEdit;
  document.getElementById('btnCancelEdit').onclick = closeEditModal;
  
  document.getElementById('editModal').onclick = function(e) {
    if (e.target === this) {
      closeEditModal();
    }
  };

  function render(){
    const list=document.getElementById('log'); list.innerHTML='';
    if(!logs.length){
      const li=document.createElement('li'); li.className='empty-state'; li.textContent='ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“'; list.appendChild(li); return;
    }
    const reversed=[...logs].reverse();
    reversed.forEach(row=>{
      const li=document.createElement('li'); 
      li.className='row'; 
      if(row.aiCorrected) li.classList.add('ai-corrected');
      if(row.userLearned) li.classList.add('user-learned');
      li.dataset.id=row.id; 
      if(row.id===selectedId) li.classList.add('selected');

      const time=document.createElement('div'); time.className='time'; 
      time.innerHTML=`ğŸ• ${row.time}`;
      if(row.aiCorrected){
        const badge=document.createElement('span'); 
        badge.className='ai-badge'; 
        badge.textContent='AIè£œæ­£';
        time.appendChild(badge);
      }
      if(row.userLearned){
        const badge=document.createElement('span'); 
        badge.className='learn-badge'; 
        badge.textContent='å­¦ç¿’æ¸ˆã¿';
        time.appendChild(badge);
      }
      if(logs[0].time && row.time !== logs[0].time){
        const el = getElapsedMinutes(logs[0].time, row.time);
        const span = document.createElement('span'); span.className='elapsed'; span.textContent = formatElapsed(el);
        time.appendChild(span);
      }

      const addrDiv = document.createElement('div'); addrDiv.className='addr';
      const thisIdx = logs.findIndex(x=>x.id===row.id);
      const prevAddr = (thisIdx>0 && logs[thisIdx-1].address) ? logs[thisIdx-1].address : '';
      const showAddr = row.address && row.address !== prevAddr;
      if(row.address){
        addrDiv.textContent = `ğŸ“ ${row.address}`;
        if(!showAddr) addrDiv.classList.add('muted');
      }

      const text=document.createElement('div'); text.className='text'; text.textContent=row.text;

      const tags=document.createElement('div'); tags.className='tags';
      (row.tags||[]).forEach(tag=>{ const span=document.createElement('span'); span.className='tag'; span.textContent=tag; tags.appendChild(span); });

      const tools=document.createElement('div'); tools.className='tools';
      const btnSel=document.createElement('button'); btnSel.type='button'; btnSel.className='btn'; btnSel.textContent = selectedId===row.id?'è§£é™¤':'é¸æŠ';
      btnSel.onclick=()=>{ selectedId = (selectedId===row.id ? null : row.id); render(); };
      
      const btnEdit=document.createElement('button'); btnEdit.type='button'; btnEdit.className='btn warning'; btnEdit.textContent='ç·¨é›†';
      btnEdit.onclick=()=>{ openEditModal(row.id); };
      
      const btnDel=document.createElement('button'); btnDel.type='button'; btnDel.className='btn danger'; btnDel.textContent='å‰Šé™¤';
      btnDel.onclick=()=>{ if(confirm('å‰Šé™¤ã—ã¾ã™ã‹?')){ logs = logs.filter(x=>x.id!==row.id); if(selectedId===row.id) selectedId=null; save(); render(); updateStats(); } };
      tools.append(btnSel,btnEdit,btnDel);

      li.append(time);
      if(row.address){ li.append(addrDiv); }
      li.append(text,tags,tools);
      list.appendChild(li);
    });
    list.scrollTop=0;
  }

  function updateStats(){
    document.getElementById('totalLogs').textContent = logs.length;
    if(logs.length>=2){
      const el=getElapsedMinutes(logs[0].time, logs[logs.length-1].time);
      document.getElementById('totalTime').textContent = `${el}åˆ†`;
    }else{
      document.getElementById('totalTime').textContent = '0åˆ†';
    }
  }

  /* ====== ã€v2.3.3å¼·åŒ–ã€‘ã‚¿ã‚°ãƒœã‚¿ãƒ³ã®ã‚«ãƒ†ã‚´ãƒªåˆ†ã‘ã‚’æ›´æ–° ====== */
  function renderTagButtons(){
    const box=document.getElementById('tagButtons'); box.innerHTML='';
    const cats={
      'ğŸš‘ æ•‘æ€¥':["æ•‘æ€¥è¦šçŸ¥","æ•‘æ€¥æŒ‡ä»¤","æ•‘æ€¥å‡ºå‹•","æ•‘æ€¥ç¾ç€","æ•‘æ€¥æ¥è§¦","è»Šå†…åå®¹","ç¾ç™º","ç—…ç€"],
      'ğŸš ãƒ˜ãƒª':["ãƒ˜ãƒªè¦šçŸ¥","ãƒ˜ãƒªæŒ‡ä»¤","ãƒ˜ãƒªå‡ºå‹•","ãƒ˜ãƒªç¾ç€","ãƒ•ãƒ©ã‚¤ãƒˆãƒ‰ã‚¯ã‚¿ãƒ¼æ¥è§¦","ãƒ©ãƒ³ãƒ‡ãƒ–ãƒ¼ãƒã‚¤ãƒ³ãƒˆç€"],
      'ğŸš™ ã‚«ãƒ¼':["ã‚«ãƒ¼è¦šçŸ¥","ã‚«ãƒ¼æŒ‡ä»¤","ã‚«ãƒ¼å‡ºå‹•","ã‚«ãƒ¼ç¾ç€","ã‚«ãƒ¼æ¥è§¦","ãƒ‰ãƒƒã‚­ãƒ³ã‚°","åŒ»å¸«æ¥è§¦"],
      'ğŸ“‹ æƒ…å ±':["ä¸»è¨´", "èƒ¸ç—›", "ç¾ç—…æ­´","æ—¢å¾€æ­´","å¸¸ç”¨è–¬","ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼","ç”Ÿæ´»æ­´","ADL"], // èƒ¸ç—›ã‚’è¿½åŠ 
      'ğŸ”¬ æ¤œæŸ»':["èº«ä½“æ‰€è¦‹","è¡€æ¶²ã‚¬ã‚¹åˆ†æ","è¡€ç³–","ç°¡æ˜“è¶…éŸ³æ³¢æ¤œæŸ»","12èª˜å°å¿ƒé›»å›³","è¶…éŸ³æ³¢æ¤œæŸ»"],
      'ğŸ« å‘¼å¸':["æ°—ç®¡æŒ¿ç®¡","äººå·¥å‘¼å¸","ãƒãƒƒã‚¯ãƒãƒ«ãƒ–ãƒã‚¹ã‚¯æ›æ°—","é…¸ç´ æŠ•ä¸","é…¸ç´ æŠ•ä¸é‡","NPPV"],
      'ğŸ’‰ å¾ªç’°':["ãƒ«ãƒ¼ãƒˆç¢ºä¿","ç”Ÿé£Ÿç‚¹æ»´","ã‚½ãƒ«ã‚¢ã‚»ãƒˆFç‚¹æ»´","å¤§è…¿å‹•è„ˆ","å¤§è…¿é™è„ˆ","éª¨é«„é‡"],
      'â¤ï¸ è˜‡ç”Ÿ':["èƒ¸éª¨åœ§è¿«","é–‹èƒ¸","å¿ƒè‡“ãƒãƒƒã‚µãƒ¼ã‚¸"],
      'ğŸ’Š è–¬å‰¤':["ã‚¢ãƒ‰ãƒ¬ãƒŠãƒªãƒ³","ãƒŸãƒ€ã‚¾ãƒ©ãƒ ","ã‚¸ã‚¢ã‚¼ãƒ‘ãƒ ","ã‚¤ãƒ¼ã‚±ãƒ—ãƒ©","ãƒãƒ«ã‚¢ãƒ‰ãƒ¬ãƒŠãƒªãƒ³","ãƒ¬ãƒšã‚¿ãƒ³"]
    };
    Object.entries(cats).forEach(([cat,tags])=>{
      const h=document.createElement('div');
      h.style.cssText='width:100%; font-weight:700; font-size:10px; color:#2c3e50; margin:6px 0 3px 0; padding:3px 6px; border-left:3px solid #3498db; background:#ecf0f1;';
      h.textContent=cat; box.appendChild(h);
      tags.forEach(tag=>{
        const b=document.createElement('button'); b.type='button'; b.className='btn'; b.textContent=tag;
        b.onclick=async ()=>{
          if(selectedId){
            const row=logs.find(r=>r.id===selectedId);
            if(row && !row.tags.includes(tag)){ row.tags.push(tag); save(); render(); }
          }else{
            const addr = await fetchAddressFromGPS();
            addLine(tag, addr);
          }
        };
        box.appendChild(b);
      });
    });
  }

  function showSuggestions(txt){
    const sug=document.getElementById('suggestions'); const items=document.getElementById('suggestionItems');
    const matches=new Set();
    TAGS.forEach(tag=>{ if(!txt.includes(tag)&&tag.length>=2&&txt.includes(tag.substring(0,1))) matches.add(tag); });
    const arr=Array.from(matches);
    if(arr.length>0){
      sug.style.display='block'; items.innerHTML='';
      arr.slice(0,10).forEach(term=>{
        const span=document.createElement('span'); span.className='suggestion-item'; span.textContent=term;
        span.onclick=()=>{ const input=document.getElementById('input'); input.value+=term+' '; input.focus(); sug.style.display='none'; };
        items.appendChild(span);
      });
    }else{ sug.style.display='none'; }
  }

  function updateConfidenceBar(confidence) {
    const fill = document.getElementById('confidenceFill');
    const percent = Math.round(confidence * 100);
    fill.style.width = `${percent}%`;
    
    if(confidence >= 0.8) {
      fill.className = 'confidence-fill confidence-high';
    } else if(confidence >= 0.6) {
      fill.className = 'confidence-fill confidence-medium';
    } else {
      fill.className = 'confidence-fill confidence-low';
    }
  }

  class BeatLog{
    constructor(el){ this.el=el; this._idle=null; this._punctRe=/[ã€‚.ã€‚!?!?]\s*$/; this._onInput=this._onInput.bind(this); this._onBlur=this._onBlur.bind(this); }
    start(){ this.el.addEventListener('input',this._onInput); this.el.addEventListener('blur',this._onBlur); }
    _onInput(){
      const raw=this.el.value; showSuggestions(raw);
      if(document.getElementById('punct').checked && (this._punctRe.test(raw)||raw.endsWith('\n'))){ this.commitNow(); return; }
      clearTimeout(this._idle);
      const sec=parseFloat(document.getElementById('idleSec').value)||1.2; const ms=Math.max(300,sec*1000);
      this._idle=setTimeout(()=>{ if(this.el.value.trim()) this.commitNow(); }, ms);
    }
    _onBlur(){ if(this.el.value.trim()) this.commitNow(); clearTimeout(this._idle); }
    commitNow(){
      const raw=this.el.value.replace(/\s+/g,' ').trim(); if(!raw) return;
      this.el.value=''; clearTimeout(this._idle); document.getElementById('suggestions').style.display='none';
      addLine(enhancedNormalize(raw), '');
    }
  }

  /* ====== ã€v2.3ã€‘éŸ³å£°èªè­˜ã‚¨ãƒ³ã‚¸ãƒ³ ====== */
  class UltraPrecisionVoiceRec{
    constructor(){
      this.rec=null; this.isRec=false; this.interim=''; this.audioStream=null;
      this.wakeLock=null; this.restartTimer=null; this.lastSoundTime=Date.now();
      try{
        if('webkitSpeechRecognition' in window) this.rec=new webkitSpeechRecognition();
        else if('SpeechRecognition' in window) this.rec=new SpeechRecognition();
      }catch(e){ this.rec=null; }
      if(this.rec) this.setup();
      this.setupEnhancedAudio(); 
      this.setupVisibilityHandler();
      this.setupWakeLock();
    }
    
    async setupWakeLock(){
      if('wakeLock' in navigator){
        try{
          document.addEventListener('visibilitychange', async ()=>{
            if(this.isRec && document.visibilityState === 'visible' && !this.wakeLock){
              await this.requestWakeLock();
            }
          });
        }catch(e){ console.log('Wake Lockæœªå¯¾å¿œ'); }
      }
    }
    
    async requestWakeLock(){
      if('wakeLock' in navigator && this.isRec){
        try{
          this.wakeLock = await navigator.wakeLock.request('screen');
          this.wakeLock.addEventListener('release', ()=>{ this.wakeLock=null; });
        }catch(e){ }
      }
    }
    
    async releaseWakeLock(){
      if(this.wakeLock){
        try{ await this.wakeLock.release(); this.wakeLock=null; }catch{}
      }
    }
    
    setupVisibilityHandler(){
      document.addEventListener('visibilitychange', ()=>{
        if(this.isRec){
          if(document.hidden){
            this.ensureRecording();
          }else{
            this.ensureRecording();
          }
        }
      });
    }
    
    ensureRecording(){
      if(!this.isRec) return;
      clearTimeout(this.restartTimer);
      this.restartTimer = setTimeout(()=>{
        if(this.isRec){
          const timeSinceLastSound = Date.now() - this.lastSoundTime;
          if(timeSinceLastSound > 15000){
            this.forceRestart();
          }else{
            this.ensureRecording();
          }
        }
      }, 10000);
    }
    
    forceRestart(){
      if(!this.rec || !this.isRec) return;
      try{ this.rec.stop(); }catch{}
      setTimeout(()=>{
        if(this.isRec){
          try{ 
            this.rec.start(); 
            this.lastSoundTime=Date.now(); 
          }catch(e){ 
            setTimeout(()=>{ if(this.isRec) this.forceRestart(); }, 1000);
          }
        }
      }, 100);
    }

    async setupEnhancedAudio() {
      try {
        this.audioStream = await navigator.mediaDevices.getUserMedia({
          audio: {
            echoCancellation: { ideal: true },
            noiseSuppression: { ideal: true },
            autoGainControl: { ideal: true },
            sampleRate: 48000,
            channelCount: 1
          }
        });
      } catch(e) {
      }
    }
    
    setup(){
      try{ 
        this.rec.lang='ja-JP'; 
        this.rec.continuous=true; 
        this.rec.interimResults=true; 
        this.rec.maxAlternatives=10;
      }catch(e){}
      
      this.rec.onresult=async (e)=>{
        this.lastSoundTime = Date.now();
        let interim='', final='';
        
        for(let i=e.resultIndex;i<e.results.length;i++){
          if(e.results[i].isFinal) {
            const alternatives = [];
            for(let j=0; j<Math.min(e.results[i].length, 10); j++){
              alternatives.push(e.results[i][j]);
            }
            
            const bestResult = aiCorrection.selectBestCandidate(alternatives, interim);
            
            if(bestResult){
              final += bestResult.text;
              
              const confidencePercent = Math.round(bestResult.confidence * 100);
              
              updateConfidenceBar(bestResult.confidence);
              
              const aiInd = document.getElementById('aiIndicator');
              if(bestResult.aiCorrected){
                aiInd.textContent = 'ğŸ§  AIè£œæ­£é©ç”¨';
                aiInd.style.color = '#9b59b6';
              }else{
                aiInd.textContent = '';
              }
              
              if(bestResult.confidence < 0.6) {
                document.getElementById('voiceStatusText').textContent = `âš ï¸ ä½ç²¾åº¦ (${confidencePercent}%)`;
                document.getElementById('voiceStatusText').style.color = '#e74c3c';
              } else if(bestResult.confidence < 0.8) {
                document.getElementById('voiceStatusText').textContent = `ğŸ“ èªè­˜ä¸­ (${confidencePercent}%)`;
                document.getElementById('voiceStatusText').style.color = '#f39c12';
              } else {
                document.getElementById('voiceStatusText').textContent = `âœ… èªè­˜å®Œäº† (${confidencePercent}%)`;
                document.getElementById('voiceStatusText').style.color = '#27ae60';
              }
              
              const norm = enhancedNormalize(bestResult.text);
              document.getElementById('voiceStatusText').textContent = 'ğŸ“¡ ä½ç½®æƒ…å ±å–å¾—ä¸­...';
              
              const addr = await fetchAddressFromGPS();
              addLine(norm, addr, bestResult.aiCorrected);
              
              this.interim=''; 
              document.getElementById('voiceInterim').textContent='';
              document.getElementById('voiceStatusText').textContent='å¾…æ©Ÿä¸­...';
              document.getElementById('voiceStatusText').style.color = '#7f8c8d';
              document.getElementById('aiIndicator').textContent = '';
            }
          } else {
            interim += e.results[i][0].transcript;
          }
        }
        
        if(interim){ 
          this.interim=interim; 
          document.getElementById('voiceInterim').textContent=`èªè­˜ä¸­: ${interim}`; 
        }
      };
      
      this.rec.onstart=()=>{ 
        this.isRec=true; 
        this.lastSoundTime=Date.now();
        this.updateUI(); 
        this.ensureRecording();
      };
      
      this.rec.onend=()=>{ 
        if(this.isRec){ 
          setTimeout(()=>{
            if(this.isRec){
              try{ 
                this.rec.start(); 
              }catch(e){ 
                setTimeout(()=>{ if(this.isRec) this.forceRestart(); } , 1000);
              }
            }
          }, 100);
        } else { 
          this.updateUI(); 
          clearTimeout(this.restartTimer);
        }
      };
      
      this.rec.onerror=(e)=>{
        const st=document.getElementById('voiceStatusText');
        if(e.error==='no-speech'){ 
          this.lastSoundTime=Date.now();
          return;
        }
        if(e.error==='audio-capture'){ st.textContent='âŒ ãƒã‚¤ã‚¯ãªã—'; this.stop(); }
        else if(e.error==='not-allowed'){ st.textContent='âŒ è¨±å¯ãªã—'; this.stop(); }
        else if(e.error==='network'){ 
          st.textContent='âš ï¸ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ (å†è©¦è¡Œä¸­)'; 
          setTimeout(()=>{ if(this.isRec) this.forceRestart(); }, 2000);
        }
        else if(e.error==='aborted'){
          if(this.isRec){
            setTimeout(()=>{ if(this.isRec) this.forceRestart(); }, 500);
          }
        }
      };
      
      this.rec.onsoundstart=()=>{ this.lastSoundTime=Date.now(); document.getElementById('voiceStatusText').textContent='ğŸ¤ éŸ³å£°æ¤œå‡ºä¸­...'; };
      this.rec.onsoundend = ()=>{ this.lastSoundTime=Date.now(); if(this.isRec && !this.interim){ document.getElementById('voiceStatusText').textContent='å¾…æ©Ÿä¸­...'; } };
      this.rec.onspeechstart=()=>{ this.lastSoundTime=Date.now(); document.getElementById('voiceStatusText').textContent='ğŸ—£ï¸ èªè­˜ä¸­...'; };
      this.rec.onspeechend =()=>{ this.lastSoundTime=Date.now(); if(this.isRec){ document.getElementById('voiceStatusText').textContent='å¾…æ©Ÿä¸­...'; } };
    }
    
    async start(){
      if(!this.rec){ alert('éŸ³å£°èªè­˜æœªå¯¾å¿œ'); return; }
      if(this.isRec) return;
      try{
        this.isRec=true; 
        this.lastSoundTime=Date.now();
        this.rec.start();
        await this.requestWakeLock();
        document.getElementById('voiceStatusText').textContent='ğŸ¤ è©±ã—ã¦ãã ã•ã„';
        this.updateUI();
      }catch(e){ 
        this.isRec=false; 
        alert('é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ'); 
      }
    }
    
    stop(){
      if(!this.rec || !this.isRec) return;
      this.isRec=false; 
      clearTimeout(this.restartTimer);
      this.releaseWakeLock();

      try{ this.rec.stop(); }catch{}
      if (this.audioStream) {
        this.audioStream.getTracks().forEach(track => track.stop());
        this.audioStream = null;
      }
      
      this.interim=''; 
      document.getElementById('voiceInterim').textContent=''; 
      document.getElementById('voiceStatusText').textContent='ã‚¿ãƒƒãƒ—ã§é–‹å§‹';
      document.getElementById('voiceStatusText').style.color = '#7f8c8d';
      document.getElementById('aiIndicator').textContent = '';
      updateConfidenceBar(0);
      this.updateUI();
    }
    
    toggle(){ if(this.isRec) this.stop(); else this.start(); }
    
    updateUI(){
      const btn=document.getElementById('voiceBtn'); 
      const title=document.getElementById('voiceStatusTitle');
      if(this.isRec){ 
        btn.classList.add('active'); 
        title.textContent='ğŸ”´ éŒ²éŸ³ä¸­ (AI v2.3.3)'; 
      } else { 
        btn.classList.remove('active'); 
        title.textContent='åœæ­¢ä¸­'; 
      }
    }
  }

  document.getElementById('btnCopy').onclick=async()=>{
    if(!logs.length){ alert('ã‚³ãƒ”ãƒ¼ã™ã‚‹ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
    const txt=logs.map(e=>`${e.time} ${e.text}${e.tags.length?' ['+e.tags.join(',')+']':''}`).join('\n');
    try{ await navigator.clipboard.writeText(txt); alert('âœ… ã‚³ãƒ”ãƒ¼å®Œäº†'); }catch{ alert('âŒ ã‚³ãƒ”ãƒ¼å¤±æ•—'); }
  };
  
  document.getElementById('btnCopyAddr').onclick=async()=>{
    if(!logs.length){ alert('ã‚³ãƒ”ãƒ¼ã™ã‚‹ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
    const txt=logs.map((e,i)=>{
      const prev = i>0 ? logs[i-1] : null;
      const showAddr = e.address && (!prev || e.address !== prev.address);
      return `${e.time}${showAddr?` [${e.address}]`:''} ${e.text}${e.tags.length?' ['+e.tags.join(',')+']':''}`;
    }).join('\n');
    try{ await navigator.clipboard.writeText(txt); alert('âœ… ã‚³ãƒ”ãƒ¼å®Œäº†'); }catch{ alert('âŒ ã‚³ãƒ”ãƒ¼å¤±æ•—'); }
  };

  document.getElementById('btnClear').onclick=()=>{
    if(!logs.length){ alert('æ¶ˆå»ã™ã‚‹ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
    if(confirm('âš ï¸ å…¨å‰Šé™¤ã—ã¾ã™ã‹?')){ 
      logs=[]; selectedId=null; startTime=null; aiCorrectionCount=0; userLearnedCount=0;
      document.getElementById('aiCorrections').textContent = '0';
      document.getElementById('userLearned').textContent = '0';
      save(); render(); updateStats(); 
    }
  };

  function updateClock(){ document.getElementById('clock').textContent = nowHHMMSS(); }

  function init(){
    load(); render(); updateStats(); renderTagButtons();
    const sel=document.getElementById('idleSec');
    for(let i=0.5;i<=10;i+=0.5){ 
      const opt=document.createElement('option'); 
      opt.value=i.toFixed(1); 
      opt.textContent=`${i.toFixed(1)}ç§’`; 
      if(Math.abs(i-1.2)<0.01) opt.selected=true; 
      sel.appendChild(opt); 
    }
    new BeatLog(document.getElementById('input')).start();
    const voice=new UltraPrecisionVoiceRec(); 
    document.getElementById('voiceBtn').onclick=()=>voice.toggle();
    updateClock(); setInterval(updateClock,1000);
    
    console.log('ğŸš‘ èµ·å‹•å®Œäº† (è¶…é«˜ç²¾åº¦AIç‰ˆ v2.3.3 - ç—‡çŠ¶èªè­˜å¼·åŒ–ç‰ˆ)');
    console.log('');
    console.log('ğŸ†• v2.3.3ã®å¼·åŒ–ç‚¹ (ç—‡çŠ¶èªè­˜å¼·åŒ–):');
    console.log('  ğŸ§  æ–‡è„ˆè£œæ­£å¼·åŒ–: ã€Œå…±é€šã€ã‚’ã€Œèƒ¸ç—›ã€ã«è‡ªå‹•è£œæ­£ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ ');
    console.log('  âœ… è¾æ›¸(MEDICAL_CORRECTIONS)ã«ã€Œãã‚‡ã†ã¤ã†ã€ã€Œå…±é€šãŒã€ãªã©ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¿½åŠ ');
    console.log('  âœ… é€£èª(NGRAMS)ã«ã€Œèƒ¸ç—› ãŒã€ãªã©ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¿½åŠ ');
    console.log('  âœ… ã‚¿ã‚°ãƒœã‚¿ãƒ³ã«ã€Œèƒ¸ç—›ã€ã‚’è¿½åŠ ');
    console.log('  âœ… æ–‡è„ˆã‚¨ãƒ³ã‚¸ãƒ³(ContextEngine)ãŒã€Œèƒ¸ç—›ã€ã‚’èªè­˜ã—ã€ãƒ•ã‚§ãƒ¼ã‚ºã‚’æ›´æ–°');
    console.log('');
    console.log('ğŸ§  AIæ©Ÿèƒ½ (v2.3.2ã‹ã‚‰ã®ç¶™ç¶š):');
    console.log('  âœ… åŒ»ç™‚ç”¨èªï¼ˆä¸»è¨´, æ—¢å¾€æ­´ãªã©ï¼‰ã®äº‹å‰å­¦ç¿’');
    console.log('  ğŸ’¥ çŸ­æ–‡å¼·åˆ¶è£œæ­£ãƒ­ã‚¸ãƒƒã‚¯');
    console.log('  ğŸ§  æ–‡è„ˆã«ã‚ˆã‚‹åŒéŸ³ç•°ç¾©èªè£œæ­£ï¼ˆæ„è­˜/ä¼Šæ•·, å¿ƒé…/å¿ƒè‚ºï¼‰');
    console.log('  âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼å­¦ç¿’æ©Ÿèƒ½');
    console.log('');
  }
  init();
</script>
</body>
</html>
