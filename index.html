<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
<title>æ•‘æ€¥è¨˜éŒ² - AI Ultimate v2.8.0</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: rgba(0,0,0,0); }
  body {
    background: #f8f9fa; min-height: 100vh; color: #212529;
    font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Yu Gothic','Hiragino Sans',sans-serif;
    line-height: 1.4; font-size: 14px; -webkit-text-size-adjust: 100%; touch-action: manipulation; overflow-x: hidden;
  }
  header {
    background: #fff; border-bottom: 2px solid #e74c3c; padding: 6px 10px; box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    position: sticky; top: 0; z-index: 100;
  }
  .header-content { display: flex; justify-content: space-between; align-items: center; }
  h1 { font-size: 13px; font-weight: 700; color: #e74c3c; }
  .version { font-size: 8px; color: #9b59b6; margin-left: 4px; }
  .clock { font-size: 16px; font-weight: 700; color: #2c3e50; font-variant-numeric: tabular-nums; }
  .wrap { padding: 6px; }
  .grid { display: flex; flex-direction: column; gap: 6px; }
  .card { background: #fff; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
  .card h2 { padding: 6px 10px; border-bottom: 2px solid #3498db; font-size: 12px; font-weight: 700; color: #2c3e50; background: #ecf0f1; }
  .card .body { padding: 8px; }
  
  /* éŒ²éŸ³ãƒãƒŠãƒ¼ */
  .recording-banner {
    display: none; position: fixed; top: 50px; left: 0; right: 0; 
    background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
    color: #fff; text-align: center; padding: 15px; z-index: 99;
    box-shadow: 0 4px 12px rgba(39, 174, 96, 0.4);
    animation: banner-pulse 2s infinite;
  }
  .recording-banner.show { display: block; }
  .recording-banner .main-text { font-size: 20px; font-weight: 700; margin-bottom: 5px; }
  .recording-banner .sub-text { font-size: 14px; opacity: 0.9; }
  .recording-time { 
    font-size: 28px; font-weight: 700; font-variant-numeric: tabular-nums;
    color: #fff; text-shadow: 0 2px 4px rgba(0,0,0,0.3);
  }
  @keyframes banner-pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.85; } }
  
  /* ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ */
  .system-status {
    font-size: 9px; padding: 4px 8px; background: #e8f4f8; border-radius: 4px;
    color: #2c3e50; margin-top: 4px; border-left: 2px solid #3498db;
  }
  .system-status.warning { background: #fff3cd; border-left-color: #f39c12; color: #856404; }
  .system-status.error { background: #f8d7da; border-left-color: #e74c3c; color: #721c24; }
  .system-status.success { background: #d4edda; border-left-color: #27ae60; color: #155724; }
  
  /* æ¨©é™ã‚¢ãƒ©ãƒ¼ãƒˆ */
  .permission-alert {
    display: none; background: #fff3cd; border: 2px solid #f39c12; border-radius: 8px;
    padding: 12px; margin-bottom: 8px;
  }
  .permission-alert.show { display: block; }
  .permission-alert-title { font-size: 13px; font-weight: 700; color: #856404; margin-bottom: 6px; }
  .permission-alert-text { font-size: 11px; color: #856404; line-height: 1.5; margin-bottom: 8px; }
  .permission-alert-buttons { display: flex; gap: 6px; }
  
  /* ãƒœã‚¤ã‚¹ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */
  .voice-control { 
    display: flex; justify-content: center; align-items: center; 
    padding: 12px; background: #ecf0f1; border-radius: 6px; margin-bottom: 6px; 
  }
  .voice-btn {
    width: 70px; height: 70px; border: none; border-radius: 50%;
    background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    color: #fff; font-size: 32px; box-shadow: 0 2px 6px rgba(231,76,60,0.3);
  }
  .voice-btn:active { transform: scale(0.95); }
  .voice-btn.active { 
    background: linear-gradient(135deg, #27ae60 0%, #229954 100%); 
    animation: pulse-voice 1.5s infinite;
    box-shadow: 0 0 20px rgba(39, 174, 96, 0.6);
  }
  .voice-btn:disabled { background: #95a5a6; opacity: 0.6; cursor: not-allowed; }
  @keyframes pulse-voice { 
    0%, 100% { transform: scale(1); box-shadow: 0 0 20px rgba(39, 174, 96, 0.6); } 
    50% { transform: scale(1.08); box-shadow: 0 0 30px rgba(39, 174, 96, 0.8); } 
  }
  
  /* è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
  .settings-section {
    background: #fff3cd; border: 2px solid #ffc107; border-radius: 6px; padding: 10px; margin-bottom: 8px;
  }
  .settings-title {
    font-size: 11px; font-weight: 700; color: #856404; margin-bottom: 6px;
    display: flex; align-items: center; gap: 4px;
  }
  .setting-row {
    display: flex; align-items: center; gap: 8px; margin: 6px 0; padding: 6px;
    background: #fff; border-radius: 4px;
  }
  .setting-row label { flex: 1; font-size: 11px; color: #2c3e50; font-weight: 500; }
  .setting-row input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; }
  .setting-row input[type="number"] { width: 60px; padding: 4px; border: 1px solid #bdc3c7; border-radius: 4px; font-size: 11px; }
  .setting-row input[type="password"] { flex:2; padding:4px; border:1px solid #bdc3c7; border-radius:4px; font-size:10px; }

  /* å…¥åŠ›ãƒ»ãƒœã‚¿ãƒ³é¡ */
  .controls { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 6px; }
  .pill {
    display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; border: 1px solid #bdc3c7; border-radius: 12px;
    background: #ecf0f1; font-size: 10px; color: #2c3e50; font-weight: 500;
  }
  .btn {
    border: none; background: #3498db; color: #fff; border-radius: 6px; padding: 8px 12px; font-weight: 600; font-size: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    min-height: 40px; display: inline-flex; align-items: center; justify-content: center;
  }
  .btn:active { transform: scale(0.97); opacity: 0.9; }
  .btn.success { background: #27ae60; }
  .btn.danger { background: #e74c3c; }
  .btn.warning { background: #f39c12; }
  .btn.secondary { background: #95a5a6; }
  .btn.purple { background: #9b59b6; }
  
  /* ãƒ—ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ */
  .tag-buttons {
    display: flex; flex-wrap: wrap; gap: 5px; margin-top: 6px; max-height: 240px; overflow-y: auto; 
    padding: 8px; background: #f8f9fa; border-radius: 6px; -webkit-overflow-scrolling: touch;
  }
  .tag-buttons .btn {
    background: #e8f4f8; color: #2c3e50; font-size: 12px; padding: 8px 12px; 
    border-radius: 12px; border: 2px solid #3498db; min-height: 42px; font-weight: 600;
  }
  .tag-buttons .btn:active { background: #3498db; color: #fff; }
  .tag-buttons .category-header {
    width: 100%; font-weight: 700; font-size: 11px; margin: 8px 0 4px; 
    border-left: 3px solid #3498db; padding-left: 6px; color: #2c3e50;
  }
  
  .main-buttons { margin-top: 8px; display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
  
  /* æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ */
  .search-section {
    background: #e8f4f8; border: 2px solid #3498db; border-radius: 6px; padding: 10px; margin-bottom: 8px;
  }
  .search-title { font-size: 11px; font-weight: 700; color: #2c3e50; margin-bottom: 6px; }
  .search-row { display: flex; gap: 6px; margin-bottom: 6px; align-items: center; }
  .search-row input[type="date"] { 
    flex: 1; padding: 6px; border: 1px solid #bdc3c7; border-radius: 4px; font-size: 11px; 
  }
  .search-row input[type="text"] { 
    flex: 1; padding: 6px; border: 1px solid #bdc3c7; border-radius: 4px; font-size: 11px; 
  }
  .search-row .btn { min-height: 32px; font-size: 10px; }
  
  /* çµ±è¨ˆ */
  .stats { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; margin-bottom: 8px; }
  .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; padding: 8px; border-radius: 6px; text-align: center; }
  .stat-value { font-size: 16px; font-weight: 700; margin-bottom: 2px; }
  .stat-label { font-size: 8px; opacity: 0.9; }
  
  /* äº‹ä¾‹æƒ…å ± */
  .case-info {
    background: #d4edda; border: 2px solid #27ae60; border-radius: 6px; padding: 8px; margin-bottom: 8px;
  }
  .case-info-title { font-size: 11px; font-weight: 700; color: #155724; margin-bottom: 4px; }
  .case-info-text { font-size: 13px; font-weight: 700; color: #155724; }
  
  /* ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ */
  .timeline { max-height: 35vh; overflow-y: auto; -webkit-overflow-scrolling: touch; }
  ul.log { list-style: none; display: flex; flex-direction: column; gap: 5px; }
  
  /* ãƒ­ã‚°è¡Œ */
  .row {
    padding: 8px 8px 48px 8px;
    border-left: 3px solid #3498db; border-radius: 5px; background: #f8f9fa; 
    position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
  }
  .row.selected { background: #e8f4f8; border-left-color: #e74c3c; }
  .row.ai-processing { border-left-color: #bdc3c7; background: #fff; opacity: 0.8; }
  .row.ai-processing .text::after { content: ' ğŸ¤– AIæ•´å½¢ä¸­...'; font-size: 10px; color: #9b59b6; animation: blink 1.5s infinite; }
  .row.ai-done { border-left-color: #9b59b6; }
  @keyframes blink { 50% { opacity: 0.5; } }
  
  .time { font-size: 10px; color: #3498db; margin-bottom: 3px; font-weight: 700; display: flex; align-items: center; gap: 4px; }
  .elapsed { font-size: 8px; color: #7f8c8d; font-weight: 500; background: #ecf0f1; padding: 1px 5px; border-radius: 6px; }
  .addr { 
    font-size: 10px; color: #2c3e50; margin: 2px 0 4px; padding: 4px 6px; 
    border-left: 2px solid #27ae60; background: #eef9f1; border-radius: 3px; 
  }
  .addr.muted { opacity: 0.35; border-left-color: #bdc3c7; background: #f3f4f6; }
  .text { 
    white-space: pre-wrap; word-break: break-word; font-size: 12px; margin-bottom: 3px; 
    color: #2c3e50; line-height: 1.5; padding-right: 4px;
  }
  .tags { margin-top: 3px; display: flex; flex-wrap: wrap; gap: 3px; }
  .tag { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; border-radius: 8px; padding: 1px 6px; font-size: 8px; font-weight: 600; }
  
  .row .tools { 
    position: absolute; bottom: 6px; left: 8px; right: 8px; 
    display: flex; gap: 4px; opacity: 1;
  }
  .tools .btn { font-size: 10px; padding: 4px 8px; min-height: 32px; flex: 1; }
  
  .empty-state { text-align: center; padding: 25px 12px; color: #7f8c8d; font-size: 12px; }
  .ai-badge { font-size: 7px; background: #9b59b6; color: #fff; padding: 1px 4px; border-radius: 4px; margin-left: 4px; }
  
  /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
  .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
  .modal.show { display: flex; align-items: center; justify-content: center; }
  .modal-content { background: #fff; border-radius: 8px; padding: 16px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; }
  .modal-header { font-size: 14px; font-weight: 700; margin-bottom: 12px; color: #2c3e50; }
  .modal-body textarea { width: 100%; min-height: 100px; margin-bottom: 12px; border: 2px solid #bdc3c7; border-radius: 6px; padding: 6px; font-size: 13px; line-height: 1.4; resize: vertical; font-family: inherit; }
  .modal-buttons { display: flex; gap: 8px; }
  .modal-buttons .btn { flex: 1; }
  
  /* äº‹ä¾‹ä¸€è¦§ */
  .case-list { max-height: 50vh; overflow-y: auto; }
  .case-item {
    padding: 10px; border-left: 3px solid #3498db; border-radius: 5px; background: #f8f9fa;
    margin-bottom: 6px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); position: relative;
  }
  .case-item:hover { background: #e8f4f8; }
  .case-item-header { font-size: 13px; font-weight: 700; color: #2c3e50; margin-bottom: 4px; padding-right: 40px; }
  .case-item-info { font-size: 10px; color: #7f8c8d; }
  .case-item-delete {
    position: absolute; top: 8px; right: 8px; background: #e74c3c; color: #fff;
    border: none; border-radius: 4px; padding: 4px 8px; font-size: 10px; font-weight: 600;
    cursor: pointer;
  }
  .case-item-delete:active { transform: scale(0.95); opacity: 0.9; }
  .case-item-body { cursor: pointer; }
  
  @media (min-width: 768px){
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .timeline { max-height: 55vh; }
    h1 { font-size: 16px; }
  }
</style>
</head>
<body>
  <header>
    <div class="header-content">
      <h1>ğŸš‘ æ•‘æ€¥è¨˜éŒ² (AI Ultimate v2.8.0)</h1>
      <div class="clock" id="clock">--:--:--</div>
    </div>
  </header>

  <div id="recordingBanner" class="recording-banner">
    <div class="main-text">ğŸ”´ éŒ²éŸ³ä¸­</div>
    <div class="recording-time" id="recordingTime">00:00</div>
    <div class="sub-text">æ´»å‹•ä¸­ã‚‚ç¶™ç¶šè¨˜éŒ²</div>
  </div>

  <div class="wrap">
    <div class="grid">
      <section class="card">
        <h2>ğŸ“ å…¥åŠ›ãƒ»è¨­å®š</h2>
        <div class="body">
          <div id="permissionAlert" class="permission-alert">
            <div class="permission-alert-title">ğŸ¤ ãƒã‚¤ã‚¯è¨±å¯ãŒå¿…è¦ã§ã™</div>
            <div class="permission-alert-text">iPhoneè¨­å®š > Safari > ãƒã‚¤ã‚¯ã§è¨±å¯ã—ã¦ãã ã•ã„ã€‚</div>
            <div class="permission-alert-buttons">
              <button id="btnRetryPermission" type="button" class="btn warning">ğŸ”„ å†è©¦è¡Œ</button>
            </div>
          </div>

          <div class="settings-section">
            <div class="settings-title">âš™ï¸ è¨­å®š & AIã‚­ãƒ¼ (ç«¯æœ«ä¿å­˜)</div>
            <div class="setting-row">
              <label>Gemini API Key</label>
              <input type="password" id="apiKeyInput" placeholder="ã“ã“ã«APIã‚­ãƒ¼ã‚’å…¥åŠ›">
            </div>
            <div class="setting-row">
              <button id="btnSaveKey" type="button" class="btn success" style="width:100%; height:30px; font-size:10px;">APIã‚­ãƒ¼ã‚’ä¿å­˜</button>
            </div>
            <hr style="border:0; border-top:1px solid #e0a800; margin:8px 0;">
            <div class="setting-row">
              <label>AIæ•´å½¢ã‚’ä½¿ç”¨</label>
              <input type="checkbox" id="useAI" checked>
            </div>
            <div class="setting-row">
              <label>ç”»é¢å¸¸æ™‚ç‚¹ç¯</label>
              <input type="checkbox" id="keepScreenOn" checked>
            </div>
          </div>

          <div class="voice-control">
            <button id="voiceBtn" type="button" class="voice-btn">ğŸ¤</button>
          </div>
          
          <div id="systemStatus" class="system-status" style="display:none;"></div>

          <div class="controls">
            <label class="pill"><input id="gpsHi" type="checkbox" checked> GPS</label>
            <label class="pill">â³ <input id="gpsTimeout" type="number" min="2" max="20" value="6">s</label>
          </div>

          <div class="tag-buttons" id="tagButtons"></div>

          <div class="main-buttons">
            <button id="btnCopy" type="button" class="btn success" title="ä½æ‰€ãªã—ã§ã‚³ãƒ”ãƒ¼">ğŸ“‹ ã‚³ãƒ”ãƒ¼(ä½æ‰€ç„¡)</button>
            <button id="btnCopyAddr" type="button" class="btn success" title="ä½æ‰€ä»˜ãã§ã‚³ãƒ”ãƒ¼">ğŸ“‹ ã‚³ãƒ”ãƒ¼(ä½æ‰€æœ‰)</button>
          </div>
          <div class="main-buttons" style="margin-top:6px;">
            <button id="btnEndCase" type="button" class="btn warning">âœ… äº‹ä¾‹çµ‚äº†</button>
            <button id="btnClear" type="button" class="btn danger">ğŸ—‘ ç¾åœ¨è¨˜éŒ²æ¶ˆå»</button>
          </div>
        </div>
      </section>

      <section class="card">
        <h2>â° è¨˜éŒ² (AIé€£æº)</h2>
        <div class="body">
          <div class="case-info">
            <div class="case-info-title">ç¾åœ¨ã®äº‹ä¾‹</div>
            <div class="case-info-text" id="currentCaseInfo">äº‹ä¾‹ #1</div>
          </div>
          
          <div class="search-section">
            <div class="search-title">ğŸ” æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿</div>
            <div class="search-row">
              <input type="date" id="filterDate" placeholder="æ—¥ä»˜">
              <button id="btnShowCaseList" type="button" class="btn">ğŸ“‹ äº‹ä¾‹ä¸€è¦§</button>
              <button id="btnClearDate" type="button" class="btn secondary">Ã—</button>
            </div>
            <div class="search-row">
              <input type="text" id="searchKeyword" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢">
              <button id="btnClearSearch" type="button" class="btn secondary">Ã—</button>
            </div>
          </div>
          
          <div class="stats">
            <div class="stat-card"><div class="stat-value" id="totalLogs">0</div><div class="stat-label">ä»¶æ•°</div></div>
            <div class="stat-card"><div class="stat-value" id="totalTime">0åˆ†</div><div class="stat-label">çµŒé</div></div>
            <div class="stat-card"><div class="stat-value" id="filteredCount">-</div><div class="stat-label">è¡¨ç¤ºä¸­</div></div>
          </div>
          <div class="timeline">
            <ul id="log" class="log"></ul>
          </div>
        </div>
      </section>
    </div>
  </div>

  <div id="editModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">ğŸ“ è¨˜éŒ²ã‚’ç·¨é›†</div>
      <div class="modal-body"><textarea id="editText"></textarea></div>
      <div class="modal-buttons">
        <button id="btnSaveEdit" type="button" class="btn success">ğŸ’¾ ä¿å­˜</button>
        <button id="btnCancelEdit" type="button" class="btn secondary">âŒ</button>
      </div>
    </div>
  </div>

  <div id="caseListModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">ğŸ“‹ äº‹ä¾‹ä¸€è¦§</div>
      <div class="modal-body">
        <div class="case-list" id="caseList"></div>
      </div>
      <div class="modal-buttons">
        <button id="btnCloseCaseList" type="button" class="btn secondary">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

<script>
  const STORE_KEY='emergency-doc-v2-8';
  const API_KEY_STORE = 'gemini_api_key_local';
  
  // ç¾åœ¨ã®äº‹ä¾‹
  let currentCase = {
    caseNumber: 1,
    startTime: null,
    endTime: null,
    date: null,
    logs: []
  };
  
  // éå»ã®äº‹ä¾‹
  let cases = [];
  
  let selectedId=null; let editingLogId=null; let saveDebounceTimer = null; 
  let filterDate = ''; let searchKeyword = '';
  let viewingCaseNumber = null; // è¡¨ç¤ºä¸­ã®äº‹ä¾‹ç•ªå·

  /* --- Feedback Manager --- */
  class FeedbackManager {
    constructor() {
      this.audioCtx = null;
      this.speechSynth = window.speechSynthesis;
    }

    init() {
      if (!this.audioCtx) {
        this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }
      if (this.audioCtx.state === 'suspended') {
        this.audioCtx.resume();
      }
    }

    playBeep(frequency, duration) {
      this.init();
      if (!this.audioCtx) return;

      const oscillator = this.audioCtx.createOscillator();
      const gainNode = this.audioCtx.createGain();

      oscillator.connect(gainNode);
      gainNode.connect(this.audioCtx.destination);

      oscillator.type = 'square';
      oscillator.frequency.setValueAtTime(frequency, this.audioCtx.currentTime);

      gainNode.gain.setValueAtTime(0.5, this.audioCtx.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.001, this.audioCtx.currentTime + duration / 1000);

      oscillator.start();
      setTimeout(() => {
        oscillator.stop();
      }, duration);
    }
    
    speak(text) {
      if (!this.speechSynth) return;
      this.speechSynth.cancel();
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'ja-JP';
      utterance.rate = 1.2;
      utterance.pitch = 1.0;
      utterance.volume = 1.0;
      this.speechSynth.speak(utterance);
    }
  }
  const feedback = new FeedbackManager();

  /* --- Gemini AI Client --- */
  class GeminiClient {
    constructor() {
      this.apiKey = localStorage.getItem(API_KEY_STORE) || '';
      this.model = 'gemini-2.0-flash-exp';
    }
    
    hasKey() { return !!this.apiKey; }
    
    setKey(key) {
      this.apiKey = key.trim();
      localStorage.setItem(API_KEY_STORE, this.apiKey);
      showSystemStatus('APIã‚­ãƒ¼ã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
      feedback.playBeep(1200, 100);
    }
    
    async correctText(originalText) {
      if (!this.apiKey) {
        showSystemStatus('AIã‚­ãƒ¼ãŒæœªå…¥åŠ›ã§ã™ã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'error');
        return originalText;
      }
      
      const prompt = `
      ã‚ãªãŸã¯æ•‘æ€¥éšŠå“¡ã®ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚
      ä»¥ä¸‹ã®éŸ³å£°å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆã‚’ã€åŒ»å­¦çš„ã«æ­£ã—ã„è¡¨è¨˜ã€æ•°å€¤å½¢å¼ã€ãƒã‚¤ã‚¿ãƒ«ã‚µã‚¤ãƒ³ã®æ¨™æº–çš„ãªè¨˜è¼‰ï¼ˆä¾‹: BP 120/80, SpO2 98%, JCS 1ï¼‰ã«æ•´å½¢ã—ã¦ãã ã•ã„ã€‚
      ãƒ«ãƒ¼ãƒ«:
      1. æ„å‘³ã‚’å¤‰ãˆãšã«èª¤å­—è„±å­—ã‚’ä¿®æ­£ã€‚
      2. ãƒ•ã‚£ãƒ©ãƒ¼ï¼ˆã€Œã‚ãƒ¼ã€ç­‰ï¼‰å‰Šé™¤ã€‚
      3. **æœ€é‡è¦: å€‹äººåï¼ˆæ‚£è€…æ°åï¼‰ãŒå«ã¾ã‚Œã‚‹å ´åˆã¯çµ¶å¯¾ã«å‰Šé™¤ã—ã€[æ°åå‰Šé™¤]ã¨ç½®æ›ã™ã‚‹ã€‚**
      4. ä½™è¨ˆãªæŒ¨æ‹¶ã¯ä¸è¦ã€‚æ•´å½¢å¾Œã®ãƒ†ã‚­ã‚¹ãƒˆã®ã¿è¿”ã™ã“ã¨ã€‚
      ãƒ†ã‚­ã‚¹ãƒˆ: ${originalText}
      `;

      const url = `https://generativelanguage.googleapis.com/v1beta/models/${this.model}:generateContent?key=${this.apiKey}`;
      
      try {
        const res = await fetch(url, {
          method: 'POST', 
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
        });
        
        if (!res.ok) {
            const errData = await res.json();
            console.error('AI API Error Detail:', errData);
            
            let statusMessage = `AIé€šä¿¡ã‚¨ãƒ©ãƒ¼: ${res.status} ${res.statusText}`;
            if(res.status === 404){
              statusMessage = `AIé€šä¿¡ã‚¨ãƒ©ãƒ¼: 404 (ãƒ¢ãƒ‡ãƒ«ã€Œ${this.model}ã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚APIã‚­ãƒ¼/ãƒ¢ãƒ‡ãƒ«åã‚’ç¢ºèªã—ã¦ãã ã•ã„)`;
            } else if (res.status === 400){
              statusMessage = 'AIé€šä¿¡ã‚¨ãƒ©ãƒ¼: 400 (APIã‚­ãƒ¼ãŒç„¡åŠ¹ã€æ®‹é«˜ä¸è¶³ã€ã¾ãŸã¯ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒç„¡åŠ¹)';
            }
            showSystemStatus(statusMessage, 'error');
            return originalText; 
        }

        const data = await res.json();
        return data.candidates?.[0]?.content?.parts?.[0]?.text.trim() || originalText;
      } catch (e) {
        console.error('AI Connection Error:', e);
        showSystemStatus('AIæ¥ç¶šå¤±æ•—: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ç¢ºèª', 'error');
        return originalText;
      }
    }
  }
  const gemini = new GeminiClient();

  /* --- Core Functions --- */
  function nowHHMMSS(){ return new Date().toLocaleTimeString('ja-JP',{hour12:false}); }
  function nowDate(){ return new Date().toISOString().slice(0,10); }
  
  function save(){ 
    clearTimeout(saveDebounceTimer);
    saveDebounceTimer = setTimeout(() => {
      localStorage.setItem(STORE_KEY, JSON.stringify({currentCase, cases})); 
    }, 300); 
  }
  
  function load(){ 
    try{ 
      const d=JSON.parse(localStorage.getItem(STORE_KEY)); 
      if(d){ 
        currentCase = d.currentCase || {caseNumber: 1, startTime: null, endTime: null, date: null, logs: []};
        cases = d.cases || [];
      }
      document.getElementById('apiKeyInput').value = gemini.apiKey;
      updateCaseInfo();
    }catch{ 
      currentCase = {caseNumber: 1, startTime: null, endTime: null, date: null, logs: []};
      cases = [];
    } 
  }
  
  function updateCaseInfo(){
    document.getElementById('currentCaseInfo').textContent = `äº‹ä¾‹ #${currentCase.caseNumber}`;
  }

  /* --- GPS --- */
  async function fetchAddressFromGPS(){
    if(!document.getElementById('gpsHi').checked) return '';
    const to = Math.max(2, Math.min(20, +document.getElementById('gpsTimeout').value || 6));
    try{
      const pos = await new Promise((resolve,reject) => {
        navigator.geolocation.getCurrentPosition(resolve,reject,{enableHighAccuracy:true, timeout:to*1000, maximumAge:10000});
      });
      const {latitude, longitude} = pos.coords;
      
      try {
        const ctrl = new AbortController();
        setTimeout(()=>ctrl.abort(), to*1000);
        const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&zoom=18&addressdetails=1`;
        const res = await fetch(url, { signal: ctrl.signal });
        const data = await res.json();
        const addr = data.address;
        let resStr = '';
        
        if(addr){
          if(addr.city) resStr += addr.city;
          else if(addr.town) resStr += addr.town;
          else if(addr.village) resStr += addr.village;
          
          if(addr.suburb) resStr += addr.suburb;
          else if(addr.neighbourhood) resStr += addr.neighbourhood;
          else if(addr.quarter) resStr += addr.quarter;
          
          if(addr.road) resStr += addr.road;
          if(addr.house_number) resStr += addr.house_number;
        }
        
        return resStr || `${latitude.toFixed(4)},${longitude.toFixed(4)}`;
      } catch(e) { 
        return `${latitude.toFixed(4)},${longitude.toFixed(4)}`; 
      }
    } catch(e){ 
      return ''; 
    }
  }

  /* --- Logging Logic --- */
  async function addLine(text, address='', useAI=false, useSpeech=false){
    const t = text.trim();
    if(!t) return;
    
    if(currentCase.logs.length===0) {
      currentCase.startTime = nowHHMMSS();
      currentCase.date = nowDate();
    }
    
    const id = 'L'+Date.now();
    const newLog = {
      id: id, 
      time: nowHHMMSS(), 
      date: nowDate(),
      text: t, 
      address: address,
      tags: [], 
      status: useAI && gemini.hasKey() ? 'processing' : 'done'
    };
    
    currentCase.logs.push(newLog);
    save(); render(); updateStats();
    
    if(useSpeech){
      feedback.speak('è¨˜éŒ²ã—ã¾ã—ãŸ');
    }
    feedback.playBeep(440, 50);

    if(useAI && gemini.hasKey()){
      try {
        const corrected = await gemini.correctText(t);
        const target = currentCase.logs.find(l=>l.id===id);
        if(target){ 
          target.text = corrected; 
          target.status = 'done'; 
          save(); render(); 
          feedback.playBeep(880, 50);
        }
      } catch(e){
        const target = currentCase.logs.find(l=>l.id===id);
        if(target){ target.status = 'done'; save(); render(); }
      }
    }
  }
  
  /* --- Case Management --- */
  function endCase(){
    if(currentCase.logs.length === 0){
      alert('è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“');
      return;
    }
    
    if(!confirm('ç¾åœ¨ã®äº‹ä¾‹ã‚’çµ‚äº†ã—ã¾ã™ã‹ï¼Ÿ')){
      return;
    }
    
    currentCase.endTime = nowHHMMSS();
    cases.push({...currentCase});
    
    // æ–°ã—ã„äº‹ä¾‹ã‚’é–‹å§‹
    currentCase = {
      caseNumber: currentCase.caseNumber + 1,
      startTime: null,
      endTime: null,
      date: null,
      logs: []
    };
    
    save();
    updateCaseInfo();
    render();
    updateStats();
    
    showSystemStatus('äº‹ä¾‹ã‚’çµ‚äº†ã—ã¾ã—ãŸ', 'success');
    feedback.playBeep(600, 200);
  }
  
  function showCaseList(){
    if(!filterDate){
      alert('æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„');
      return;
    }
    
    const filteredCases = cases.filter(c => c.date === filterDate);
    
    const list = document.getElementById('caseList');
    list.innerHTML = '';
    
    if(filteredCases.length === 0){
      list.innerHTML = '<div class="empty-state">è©²å½“ã™ã‚‹äº‹ä¾‹ãŒã‚ã‚Šã¾ã›ã‚“</div>';
    } else {
      filteredCases.forEach(c => {
        const item = document.createElement('div');
        item.className = 'case-item';
        item.innerHTML = `
          <button class="case-item-delete" onclick="deleteCase(${c.caseNumber}); event.stopPropagation();">å‰Šé™¤</button>
          <div class="case-item-body" onclick="viewCase(${c.caseNumber})">
            <div class="case-item-header">äº‹ä¾‹ #${c.caseNumber}</div>
            <div class="case-item-info">${c.startTime} - ${c.endTime} | ${c.logs.length}ä»¶ã®è¨˜éŒ²</div>
          </div>
        `;
        list.appendChild(item);
      });
    }
    
    document.getElementById('caseListModal').classList.add('show');
  }
  
  function viewCase(caseNumber){
    viewingCaseNumber = caseNumber;
    document.getElementById('caseListModal').classList.remove('show');
    render();
    updateStats();
  }
  
  window.deleteCase = function(caseNumber){
    if(!confirm(`äº‹ä¾‹ #${caseNumber} ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)){
      return;
    }
    
    cases = cases.filter(c => c.caseNumber !== caseNumber);
    save();
    
    // è¡¨ç¤ºä¸­ã®äº‹ä¾‹ãŒå‰Šé™¤ã•ã‚ŒãŸå ´åˆ
    if(viewingCaseNumber === caseNumber){
      viewingCaseNumber = null;
      document.getElementById('caseListModal').classList.remove('show');
      render();
      updateStats();
    } else {
      // äº‹ä¾‹ä¸€è¦§ã‚’å†è¡¨ç¤º
      showCaseList();
    }
    
    showSystemStatus('äº‹ä¾‹ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
    feedback.playBeep(400, 100);
  }

  /* --- Filtering & Rendering --- */
  function getLogsToDisplay() {
    // è¡¨ç¤ºã™ã‚‹äº‹ä¾‹ã‚’æ±ºå®š
    let logs = [];
    
    if(viewingCaseNumber !== null){
      const targetCase = cases.find(c => c.caseNumber === viewingCaseNumber);
      if(targetCase){
        logs = targetCase.logs;
      }
    } else {
      logs = currentCase.logs;
    }
    
    // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢
    if (searchKeyword) {
      const keyword = searchKeyword.toLowerCase();
      logs = logs.filter(log => 
        log.text.toLowerCase().includes(keyword) || 
        (log.address && log.address.toLowerCase().includes(keyword)) ||
        (log.tags && log.tags.some(tag => tag.toLowerCase().includes(keyword)))
      );
    }
    
    return logs;
  }

  function render(){
    const list=document.getElementById('log'); 
    list.innerHTML='';
    
    const logs = getLogsToDisplay();
    
    if(!logs.length){ 
      list.innerHTML='<li class="empty-state">è¨˜éŒ²ãªã—</li>'; 
      document.getElementById('filteredCount').textContent = '0';
      return; 
    }
    
    document.getElementById('filteredCount').textContent = logs.length;
    
    [...logs].reverse().forEach(row=>{
      const li=document.createElement('li'); 
      li.className=`row ${row.status==='processing'?'ai-processing':''} ${row.id===selectedId?'selected':''}`;
      if(row.status==='done' && row.text.match(/[a-zA-Z]/)) li.classList.add('ai-done');
      li.dataset.id=row.id;

      const time=document.createElement('div'); time.className='time'; 
      time.innerHTML=`ğŸ• ${row.time}`;
      
      if(row.address){
        const ad=document.createElement('div'); ad.className='addr'; ad.textContent=`ğŸ“ ${row.address}`;
        li.append(ad);
      }

      const text=document.createElement('div'); text.className='text'; text.textContent=row.text;
      const tags=document.createElement('div'); tags.className='tags';
      (row.tags||[]).forEach(tag=>{ 
        const sp=document.createElement('span'); sp.className='tag'; sp.textContent=tag; tags.appendChild(sp); 
      });

      const tools=document.createElement('div'); tools.className='tools';
      
      // éå»ã®äº‹ä¾‹ã‚’è¡¨ç¤ºä¸­ã¯ç·¨é›†ãƒ»å‰Šé™¤ä¸å¯
      if(viewingCaseNumber === null){
        tools.innerHTML = `
          <button class="btn" onclick="selectLog('${row.id}')">${selectedId===row.id?'âœ“é¸æŠä¸­':'é¸æŠ'}</button>
          <button class="btn warning" onclick="openEditModal('${row.id}')">ç·¨é›†</button>
          <button class="btn danger" onclick="delLog('${row.id}')">å‰Šé™¤</button>
        `;
      } else {
        tools.innerHTML = `<div style="font-size:10px; color:#7f8c8d; text-align:center; width:100%;">éå»ã®äº‹ä¾‹ï¼ˆé–²è¦§ã®ã¿ï¼‰</div>`;
      }

      li.append(time, text, tags, tools);
      list.appendChild(li);
    });
  }

  window.selectLog = (id) => { selectedId = (selectedId===id ? null : id); render(); };
  window.delLog = (id) => { 
    if(confirm('å‰Šé™¤ã—ã¾ã™ã‹?')){ 
      currentCase.logs = currentCase.logs.filter(x=>x.id!==id); 
      save(); render(); updateStats(); 
    }
  };

  /* --- Tag Buttons --- */
  function renderTagButtons(){
    const box=document.getElementById('tagButtons'); 
    box.innerHTML='';
    
    const categories = {
      'ğŸš‘ å…ˆè¡Œæ•‘æ€¥éšŠ': {
        prefix: 'å…ˆè¡Œæ•‘æ€¥éšŠ',
        buttons: [
          {label: 'è¦šçŸ¥', log: 'è¦šçŸ¥'},
          {label: 'æŒ‡ä»¤', log: 'æŒ‡ä»¤'},
          {label: 'å‡ºå‹•', log: 'å‡ºå‹•'},
          {label: 'ç¾ç€', log: 'ç¾ç€'},
          {label: 'æ¥è§¦', log: 'æ¥è§¦'},
          {label: 'è»Šå†…åå®¹', log: 'è»Šå†…åå®¹'},
          {label: 'ç¾ç™º', log: 'ç¾ç™º'},
          {label: 'ãƒ‰ãƒƒã‚­ãƒ³ã‚°ãƒã‚¤ãƒ³ãƒˆç€', log: 'ãƒ‰ãƒƒã‚­ãƒ³ã‚°ãƒã‚¤ãƒ³ãƒˆç€'},
          {label: 'ç—…ç€', log: 'ç—…ç€'}
        ]
      },
      'ğŸš ãƒ˜ãƒª': {
        prefix: 'ãƒ˜ãƒª',
        buttons: [
          {label: 'è¦šçŸ¥', log: 'è¦šçŸ¥'},
          {label: 'æŒ‡ä»¤', log: 'æŒ‡ä»¤'},
          {label: 'å‡ºå‹•', log: 'å‡ºå‹•'},
          {label: 'LZç€', log: 'LZç€'},
          {label: 'åŒ»å¸«æ¥è§¦', log: 'åŒ»å¸«æ¥è§¦'},
          {label: 'LZé›¢é™¸', log: 'LZé›¢é™¸'},
          {label: 'ç—…ç€', log: 'ç—…ç€'}
        ]
      },
      'ğŸš— ãƒ‰ã‚¯ã‚¿ãƒ¼ã‚«ãƒ¼': {
        prefix: 'ãƒ‰ã‚¯ã‚¿ãƒ¼ã‚«ãƒ¼',
        buttons: [
          {label: 'è¦šçŸ¥', log: 'è¦šçŸ¥'},
          {label: 'æŒ‡ä»¤', log: 'æŒ‡ä»¤'},
          {label: 'å‡ºå‹•', log: 'å‡ºå‹•'},
          {label: 'ãƒ‰ãƒƒã‚­ãƒ³ã‚°ãƒã‚¤ãƒ³ãƒˆç€', log: 'ãƒ‰ãƒƒã‚­ãƒ³ã‚°ãƒã‚¤ãƒ³ãƒˆç€'},
          {label: 'ç¾ç€', log: 'ç¾ç€'},
          {label: 'ã‚«ãƒ¼ãƒ‰ã‚¯ã‚¿ãƒ¼æ¥è§¦', log: 'ã‚«ãƒ¼ãƒ‰ã‚¯ã‚¿ãƒ¼æ¥è§¦'},
          {label: 'ç¾ç™º', log: 'ç¾ç™º'},
          {label: 'ç—…ç€', log: 'ç—…ç€'}
        ]
      }
    };
    
    Object.entries(categories).forEach(([catName, catData])=>{
      const h = document.createElement('div');
      h.className = 'category-header';
      h.textContent = catName; 
      box.appendChild(h);
      
      catData.buttons.forEach(btn => {
        const b = document.createElement('button'); 
        b.className = 'btn'; 
        b.textContent = btn.label;
        
        b.onclick = async ()=>{
          let logText = '';
          
          if(catData.prefix === 'ãƒ‰ã‚¯ã‚¿ãƒ¼ã‚«ãƒ¼'){
            if(['è¦šçŸ¥','æŒ‡ä»¤','å‡ºå‹•','ç¾ç€','ç¾ç™º','ç—…ç€'].includes(btn.log)){
              logText = catData.prefix + btn.log;
            } else {
              logText = btn.log;
            }
          } else {
            logText = catData.prefix + btn.log;
          }
          
          if(selectedId){
            const row = currentCase.logs.find(r=>r.id===selectedId);
            if(row && !row.tags.includes(logText)){ 
              row.tags.push(logText); 
              save(); 
              render(); 
            }
          } else {
            const addr = await fetchAddressFromGPS();
            addLine(logText, addr, false, false);
          }
        };
        box.appendChild(b);
      });
    });
  }

  /* --- Wake Lock --- */
  class EnhancedWakeLock {
    constructor() {
      this.wakeLock = null; this.noSleepVideo = null; this.silentAudioCtx = null;
      this.setupNoSleepVideo();
    }
    setupNoSleepVideo() {
      this.noSleepVideo = document.createElement('video');
      this.noSleepVideo.setAttribute('playsinline',''); this.noSleepVideo.setAttribute('muted','');
      this.noSleepVideo.setAttribute('loop',''); this.noSleepVideo.style.display='none';
      this.noSleepVideo.src = 'data:video/mp4;base64,AAAAIGZ0eXBpc29tAAACAGlzb21pc28yYXZjMW1wNDEAAAAIZnJlZQAAAAhtZGF0AAAA1m1vb3YAAABsbXZoZAAAAAAAAAAAAAAAAAAAA+gAAAAAAAEAAAEAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIAAABidWR0YQAAAFptZXRhAAAAAAAAACFoZGxyAAAAAAAAAABtZGlyYXBwbAAAAAAAAAAAAAAAAC1pbHN0AAAAJal0b28AAAAdZGF0YQAAAAEAAAAATGF2ZjU2LjQwLjEwMQ==';
      document.body.appendChild(this.noSleepVideo);
    }
    startSilentAudio() {
      if (!this.silentAudioCtx) this.silentAudioCtx = new (window.AudioContext||window.webkitAudioContext)();
      if (this.silentAudioCtx.state==='suspended') this.silentAudioCtx.resume();
      const osc=this.silentAudioCtx.createOscillator(); const g=this.silentAudioCtx.createGain();
      osc.connect(g); g.connect(this.silentAudioCtx.destination);
      osc.frequency.value=440; g.gain.value=0.001; osc.start();
    }
    async request() {
      if(!document.getElementById('keepScreenOn').checked) return;
      if('wakeLock' in navigator){ try{ this.wakeLock=await navigator.wakeLock.request('screen'); }catch(e){} }
      try{ await this.noSleepVideo.play(); }catch(e){}
      try{ this.startSilentAudio(); }catch(e){}
    }
    async release() {
      if(this.wakeLock) { this.wakeLock.release(); this.wakeLock=null; }
      this.noSleepVideo.pause();
      if(this.silentAudioCtx) { this.silentAudioCtx.close(); this.silentAudioCtx=null; }
    }
  }
  const enhancedWakeLock = new EnhancedWakeLock();

  /* --- Voice Recognition --- */
  class VoiceRec {
    constructor(){
      this.rec=null; this.isRec=false; this.timer=null;
    }
    async start(){
      try{
        const stream = await navigator.mediaDevices.getUserMedia({audio:true});
        const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
        if(!Speech) throw new Error('No API');
        
        this.rec = new Speech();
        this.rec.lang='ja-JP'; this.rec.continuous=true; this.rec.interimResults=true;
        
        this.rec.onresult = (e) => {
          let interim='';
          for(let i=e.resultIndex; i<e.results.length; i++){
            if(e.results[i].isFinal){
              const t = e.results[i][0].transcript;
              const useAI = document.getElementById('useAI').checked;
              addLine(t, '', useAI, true);
            } else {
              interim += e.results[i][0].transcript;
            }
          }
        };
        this.rec.onend = () => { if(this.isRec) this.rec.start(); };
        
        this.rec.start();
        this.isRec=true;
        enhancedWakeLock.request();
        document.getElementById('voiceBtn').classList.add('active');
        document.getElementById('recordingBanner').classList.add('show');
        this.startTimer();
        feedback.playBeep(1000, 100);
      } catch(e){
        alert('ãƒã‚¤ã‚¯èµ·å‹•ã‚¨ãƒ©ãƒ¼: '+e.message);
      }
    }
    stop(){
      this.isRec=false;
      if(this.rec) this.rec.stop();
      enhancedWakeLock.release();
      document.getElementById('voiceBtn').classList.remove('active');
      document.getElementById('recordingBanner').classList.remove('show');
      clearInterval(this.timer);
    }
    toggle(){ if(this.isRec) this.stop(); else this.start(); }
    startTimer(){
      const el=document.getElementById('recordingTime'); let s=0;
      this.timer=setInterval(()=>{ 
        s++; 
        el.textContent=`${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`; 
      },1000);
    }
  }
  const voiceRec = new VoiceRec();

  /* --- Init --- */
  document.getElementById('voiceBtn').onclick = ()=>voiceRec.toggle();
  document.getElementById('btnSaveKey').onclick = ()=>{ gemini.setKey(document.getElementById('apiKeyInput').value); };
  document.getElementById('btnCopy').onclick = ()=>copyLogs(false);
  document.getElementById('btnCopyAddr').onclick = ()=>copyLogs(true);
  document.getElementById('btnEndCase').onclick = ()=>endCase();
  document.getElementById('btnClear').onclick = ()=>{ 
    if(confirm('ç¾åœ¨ã®è¨˜éŒ²ã‚’å…¨æ¶ˆå»?')){ 
      currentCase.logs=[]; 
      save(); 
      render(); 
      updateStats(); 
    } 
  };
  
  // äº‹ä¾‹ä¸€è¦§
  document.getElementById('btnShowCaseList').onclick = ()=>showCaseList();
  document.getElementById('btnCloseCaseList').onclick = ()=>{
    document.getElementById('caseListModal').classList.remove('show');
    viewingCaseNumber = null;
    render();
    updateStats();
  };
  
  // ãƒ•ã‚£ãƒ«ã‚¿é–¢é€£
  document.getElementById('filterDate').addEventListener('change', (e)=>{
    filterDate = e.target.value;
  });
  document.getElementById('btnClearDate').onclick = ()=>{
    filterDate = '';
    document.getElementById('filterDate').value = '';
    viewingCaseNumber = null;
    render();
    updateStats();
  };
  document.getElementById('searchKeyword').addEventListener('input', (e)=>{
    searchKeyword = e.target.value;
    render();
  });
  document.getElementById('btnClearSearch').onclick = ()=>{
    searchKeyword = '';
    document.getElementById('searchKeyword').value = '';
    render();
  };

  /* --- Utils --- */
  function showSystemStatus(msg, type){
    const el=document.getElementById('systemStatus');
    el.textContent=msg; el.className='system-status '+type; el.style.display='block';
    setTimeout(()=>el.style.display='none',3000);
  }
  
  function updateStats(){
    const logs = getLogsToDisplay();
    document.getElementById('totalLogs').textContent = logs.length;
    
    if(logs.length>1){
      const [h1,m1,s1]=logs[0].time.split(':'); 
      const [h2,m2,s2]=logs[logs.length-1].time.split(':');
      const diff=Math.floor(((h2*3600+m2*60+s2*1)-(h1*3600+m1*60+s1*1))/60);
      document.getElementById('totalTime').textContent=diff+'åˆ†';
    } else {
      document.getElementById('totalTime').textContent='0åˆ†';
    }
    
    document.getElementById('filteredCount').textContent = logs.length;
  }
  
  function copyLogs(addr){
    const logs = getLogsToDisplay();
    const txt = logs.map(l => `${l.time} ${l.text} ${addr&&l.address?'('+l.address+')':''}`).join('\n');
    navigator.clipboard.writeText(txt); 
    alert('ã‚³ãƒ”ãƒ¼å®Œäº†');
  }
  
  // Edit Modal
  window.openEditModal = (id) => {
    editingLogId=id; 
    const row=currentCase.logs.find(r=>r.id===id);
    if(row){ 
      document.getElementById('editText').value=row.text; 
      document.getElementById('editModal').classList.add('show'); 
    }
  };
  document.getElementById('btnSaveEdit').onclick = () => {
    const row=currentCase.logs.find(r=>r.id===editingLogId);
    if(row){ 
      row.text=document.getElementById('editText').value; 
      save(); render(); 
    }
    document.getElementById('editModal').classList.remove('show');
  };
  document.getElementById('btnCancelEdit').onclick = ()=>document.getElementById('editModal').classList.remove('show');

  window.onload=()=>{ 
    load(); 
    render(); 
    renderTagButtons(); 
    updateStats();
    setInterval(()=>document.getElementById('clock').textContent=nowHHMMSS(),1000); 
  };
</script>
</body>
</html>
