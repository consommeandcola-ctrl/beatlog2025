<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
<title>ÊïëÊÄ•Ë®òÈå≤ - AI Ultimate v2.8.0</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: rgba(0,0,0,0); }
  body {
    background: #f8f9fa; min-height: 100vh; color: #212529;
    font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Yu Gothic','Hiragino Sans',sans-serif;
    line-height: 1.4; font-size: 14px; -webkit-text-size-adjust: 100%; touch-action: manipulation; overflow-x: hidden;
  }
  header {
    background: #fff; border-bottom: 2px solid #e74c3c; padding: 6px 10px; box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    position: sticky; top: 0; z-index: 100;
  }
  header h1 {
    font-size: 1.2rem; margin: 0; display: flex; justify-content: space-between; align-items: center;
  }
  .settings-container {
    display: flex; gap: 10px; align-items: center; padding: 5px 0; border-top: 1px solid #eee; margin-top: 5px;
  }
  .settings-container input[type="text"] {
    flex-grow: 1; padding: 5px 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px;
  }
  .settings-container button {
    padding: 5px 10px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;
    white-space: nowrap;
  }
  .settings-container button:active { background: #1e7e34; }
  .main-content { padding: 10px; }
  #input-section {
    position: sticky; top: 70px; /* Adjust based on header size */
    background: #fff; padding: 10px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    margin-bottom: 10px; z-index: 50;
  }
  #input {
    width: 100%; padding: 10px; font-size: 1rem; border: 1px solid #ccc; border-radius: 6px;
    resize: none; min-height: 100px;
    font-family: monospace; /* For better log readability */
  }
  .status-line {
    display: flex; justify-content: space-between; align-items: center; margin-top: 5px;
    font-size: 12px; color: #6c757d;
  }
  #mic-status {
    font-weight: bold; color: #e74c3c;
  }
  .log-container {
    margin-top: 10px;
  }
  .log-row {
    background: #fff; border: 1px solid #e9ecef; margin-bottom: 5px; padding: 8px 10px; border-radius: 6px;
    display: flex; align-items: flex-start;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
  }
  .log-time {
    font-weight: bold; color: #343a40; min-width: 65px; margin-right: 10px;
  }
  .log-text {
    flex-grow: 1;
  }
  .log-status {
    font-size: 10px;
    color: #007bff;
    font-style: italic;
    margin-left: 5px;
  }
  .log-actions {
    margin-left: 10px;
    display: flex;
    gap: 5px;
  }
  .log-actions button {
    background: #e74c3c; color: white; border: none; padding: 3px 6px; border-radius: 3px; font-size: 11px; cursor: pointer;
    line-height: 1;
  }
  .log-actions button:active { background: #c0392b; }
  .tag-buttons {
    display: flex; flex-wrap: wrap; gap: 5px; margin-top: 10px;
    padding-bottom: 10px; border-bottom: 1px solid #eee;
  }
  .tag-buttons button {
    padding: 8px 12px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 13px;
    flex-grow: 1; min-width: 120px;
  }
  .tag-buttons button:active { background: #2980b9; }
  .tag-buttons .tag-critical { background: #e74c3c; }
  .tag-buttons .tag-critical:active { background: #c0392b; }

  #editModal {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);
    display: none; justify-content: center; align-items: center; z-index: 1000;
  }
  #editModal.show { display: flex; }
  .modal-content {
    background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 500px;
  }
  .modal-content textarea {
    width: 100%; min-height: 150px; margin-bottom: 15px; padding: 10px; border: 1px solid #ccc; border-radius: 4px;
    font-family: monospace;
  }
  .modal-actions {
    display: flex; justify-content: flex-end; gap: 10px;
  }
  .modal-actions button {
    padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer;
  }
  #btnSaveEdit { background: #007bff; color: white; }
  #btnSaveEdit:active { background: #0056b3; }
  #btnCancelEdit { background: #6c757d; color: white; }
  #btnCancelEdit:active { background: #5a6268; }

  .case-container {
    background: #ecf0f1; padding: 10px; border-radius: 8px; margin-top: 20px;
  }
  .case-header {
    font-weight: bold; border-bottom: 1px solid #bdc3c7; padding-bottom: 5px; margin-bottom: 10px;
    display: flex; justify-content: space-between; align-items: center;
  }
  .case-controls {
    display: flex; gap: 10px; margin-top: 10px;
  }
  .case-controls button {
    flex-grow: 1; padding: 8px; background: #f39c12; color: white; border: none; border-radius: 4px; cursor: pointer;
  }
  .case-controls button:active { background: #e67e22; }

  .past-case {
    background: #fff; border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; border-radius: 6px;
  }
  .past-case-title {
    font-weight: bold; margin-bottom: 5px;
  }
  .past-case-meta {
    font-size: 12px; color: #6c757d; margin-bottom: 10px;
  }
  .past-case-log-count {
    font-weight: bold; color: #2980b9;
  }
  .past-case-actions {
    display: flex; gap: 10px; margin-top: 10px;
  }
  .past-case-actions button {
    padding: 5px 10px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;
  }
  .past-case-actions .btn-delete { background: #c0392b; }
  .past-case-actions button:active { background: #0056b3; }
  .past-case-actions .btn-delete:active { background: #a93226; }
  
  /* Filter and Search */
  #filter-section {
    padding: 10px 0; border-bottom: 1px solid #eee; margin-bottom: 10px;
    display: flex; gap: 10px;
  }
  #filter-section input[type="text"] {
    flex-grow: 1; padding: 5px 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px;
  }
  #filter-section select {
    padding: 5px 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px;
  }

  /* GPS Status */
  #gps-status {
    font-size: 12px;
    color: #1abc9c;
    font-weight: bold;
    margin-top: 5px;
  }

  /* AI Status */
  .log-status.processing {
    color: #f39c12;
  }
  .log-status.error {
    color: #e74c3c;
  }
  .log-status.success {
    color: #28a745;
  }
  
  .system-status {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 15px 30px;
    border-radius: 8px;
    font-size: 1.1rem;
    z-index: 2000;
    display: none;
    text-align: center;
  }
  .system-status.error {
    background: #e74c3c;
  }
  .system-status.success {
    background: #28aa55;
  }
  
  .log-address {
    font-size: 12px;
    color: #6c757d;
    margin-top: 2px;
  }

</style>
</head>
<body>

<header>
  <h1>
    ÊïëÊÄ•Ë®òÈå≤ - AI Ultimate v2.8.0
    <span id="clock" style="font-size: 1.2rem; color: #e74c3c;">00:00:00</span>
  </h1>
  <div class="settings-container">
    <input type="text" id="apiKey" placeholder="Gemini API Key" title="„Åì„Åì„Å´API„Ç≠„Éº„ÇíÂÖ•Âäõ">
    <button id="btnSaveKey">API„Ç≠„Éº„Çí‰øùÂ≠ò</button>
  </div>
  <div class="settings-container" style="justify-content: flex-start; border: none; margin-top: 0;">
    <label><input type="checkbox" id="useAI" checked> AIÊï¥ÂΩ¢„Çí‰ΩøÁî®</label>
  </div>
</header>

<div class="main-content">

  <div id="input-section">
    <div class="tag-buttons" id="tagButtons">
      </div>
    <textarea id="input" placeholder="„Åì„Åì„Å´Èü≥Â£∞Ë™çË≠ò„ÅÆÁµêÊûú„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô..." readonly></textarea>
    <div class="status-line">
      <div id="mic-status">Ê∫ñÂÇôÂÆå‰∫Ü</div>
      <div id="gps-status">GPS„Çπ„ÉÜ„Éº„Çø„Çπ: ÂæÖÊ©ü‰∏≠</div>
    </div>
  </div>

  <div class="case-container">
    <div class="case-header">
      <span>ÁèæÂú®„ÅÆ‰∫ã‰æã: <span id="currentCaseId">Êú™ÈñãÂßã</span></span>
      <span style="font-size: 0.9rem;">
        ÂÖ® <span id="totalLogs">0</span> ‰ª∂ / <span id="totalTime">0ÂàÜ</span>
      </span>
    </div>

    <div class="case-controls">
      <button id="btnEndCase">‰∫ã‰æãÁµÇ‰∫Ü</button>
      <button id="btnGetAddr">‰ΩèÊâÄÂèñÂæó</button>
    </div>

    <div id="filter-section">
      <select id="caseFilter">
        <option value="current">ÁèæÂú®„ÅÆ‰∫ã‰æã</option>
        </select>
      <input type="text" id="searchKeyword" placeholder="„Ç≠„Éº„ÉØ„Éº„ÉâÊ§úÁ¥¢">
    </div>

    <div class="log-container" id="logContainer">
      </div>
    <div style="font-size: 0.9rem; text-align: right; margin-top: 10px;">
        Ë°®Á§∫„É≠„Ç∞Êï∞: <span id="filteredCount">0</span>
    </div>

  </div>

  <div class="case-container" style="margin-top: 15px;">
    <div class="case-header">
      <span>„ÉÑ„Éº„É´„Å®Áµ±Ë®à</span>
    </div>
    <div class="case-controls">
      <button id="btnCopy">Ë®òÈå≤„Ç≥„Éî„Éº</button>
      <button id="btnCopyAddr">‰ΩèÊâÄËæº„Åø„Ç≥„Éî„Éº</button>
      <button id="btnClear">Ë®òÈå≤ÂâäÈô§</button>
    </div>
  </div>

</div>

<div id="editModal" style="display: none;">
  <div class="modal-content">
    <h3>Ë®òÈå≤„ÅÆÁ∑®ÈõÜ</h3>
    <textarea id="editText"></textarea>
    <div class="modal-actions">
      <button id="btnSaveEdit">‰øùÂ≠ò</button>
      <button id="btnCancelEdit">„Ç≠„É£„É≥„Çª„É´</button>
    </div>
  </div>
</div>

<div id="systemStatus" class="system-status"></div>

<script>
const STORE_KEY = 'emergencyRecordData_v2_8_0';
const DEFAULT_MODEL = 'gemini-2.0-flash-exp'; // ‰ΩøÁî®„É¢„Éá„É´„ÇíÁ∂≠ÊåÅ

let currentCase = {
  id: 'current',
  startTime: null,
  logs: []
};
let pastCases = [];
let editingLogId = null;
let currentPosition = null;

// --- Utility Functions ---

function nowHHMMSS() {
  const date = new Date();
  return date.toTimeString().slice(0, 8);
}

function generateId() {
  return Date.now().toString(36) + Math.random().toString(36).substring(2);
}

// --- Local Storage Management ---

function save() {
  localStorage.setItem(STORE_KEY, JSON.stringify({ currentCase, pastCases, currentPosition }));
}

function load() {
  const data = JSON.parse(localStorage.getItem(STORE_KEY));
  if (data) {
    if (data.currentCase) currentCase = data.currentCase;
    if (data.pastCases) pastCases = data.pastCases;
    if (data.currentPosition) currentPosition = data.currentPosition;
  }
  if (!currentCase.id) currentCase.id = 'current';
  if (!currentCase.logs) currentCase.logs = [];
}

// --- System Status and Feedback ---

function showSystemStatus(msg, type = 'info') {
  const el = document.getElementById('systemStatus');
  el.textContent = msg; 
  el.className = `system-status ${type}`; 
  el.style.display = 'block';
  setTimeout(() => el.style.display = 'none', 3000);
}

const FeedbackManager = {
    // È´òÂ∫¶„Å™„Ç¶„Çß„Ç§„ÇØ„É≠„ÉÉ„ÇØÊ©üËÉΩÔºàÈü≥Â£∞Ë™çË≠ò‰∏≠„ÅÆ„Çπ„É™„Éº„ÉóÈò≤Ê≠¢Ôºâ
    wakeLock: null,
    audioCtx: null,
    oscillator: null,

    init() {
        if ('wakeLock' in navigator) {
            this.requestWakeLock();
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') {
                    this.requestWakeLock();
                }
            });
        }
        
    },

    async requestWakeLock() {
        try {
            this.wakeLock = await navigator.wakeLock.request('screen');
            console.log('Wake Lock„Ç¢„ÇØ„ÉÜ„Ç£„Éñ');
        } catch (err) {
            console.warn(`Wake Lock„Ç®„É©„Éº: ${err.name}, ${err.message}`);
        }
    },

    playBeep(freq = 440, duration = 100) {
        try {
            if (!this.audioCtx) {
                this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            const oscillator = this.audioCtx.createOscillator();
            const gainNode = this.audioCtx.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(this.audioCtx.destination);

            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(freq, this.audioCtx.currentTime);
            gainNode.gain.setValueAtTime(0.5, this.audioCtx.currentTime);

            oscillator.start();
            
            // „Éï„Çß„Éº„Éâ„Ç¢„Ç¶„Éà
            gainNode.gain.exponentialRampToValueAtTime(0.00001, this.audioCtx.currentTime + duration / 1000);
            oscillator.stop(this.audioCtx.currentTime + duration / 1000);

        } catch (e) {
            console.error('BeepÂÜçÁîü„Ç®„É©„Éº:', e);
        }
    },

    speak(text) {
        if ('speechSynthesis' in window) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ja-JP';
            speechSynthesis.speak(utterance);
        }
    }
};

// --- Gemini API Client ---

class GeminiClient {
  constructor() {
    this.apiKey = localStorage.getItem('geminiApiKey') || '';
    this.model = DEFAULT_MODEL; 
    document.getElementById('apiKey').value = this.apiKey;
    document.getElementById('btnSaveKey').onclick = this.saveKey.bind(this);
  }

  hasKey() {
    return !!this.apiKey;
  }

  saveKey() {
    this.apiKey = document.getElementById('apiKey').value.trim();
    localStorage.setItem('geminiApiKey', this.apiKey);
    showSystemStatus('API„Ç≠„Éº„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü', 'success');
    FeedbackManager.speak('„Ç≠„Éº‰øùÂ≠ò');
  }

  async correctText(text) {
    if (!this.hasKey()) {
      showSystemStatus('API„Ç≠„Éº„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì', 'error');
      return text;
    }

    const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${this.model}:generateContent?key=${this.apiKey}`;
    
    // AIÊï¥ÂΩ¢„ÅÆ„Åü„ÇÅ„ÅÆ„Éó„É≠„É≥„Éó„Éà
    const prompt = `„ÅÇ„Å™„Åü„ÅØÂÑ™ÁßÄ„Å™ÂåªÁôÇË®òÈå≤AI„Åß„Åô„ÄÇ‰ª•‰∏ã„ÅÆÊïëÊÄ•Èöä„ÅÆÈü≥Â£∞Ë™çË≠òÁµêÊûú„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„Çí„ÄÅÊ¨°„ÅÆ„É´„Éº„É´„Å´Âæì„Å£„Å¶Êï¥ÂΩ¢„Åó„ÄÅÊï¥ÂΩ¢Âæå„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„Å†„Åë„ÇíËøî„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
    
    „ÄêÊï¥ÂΩ¢„É´„Éº„É´„Äë
    1.  **ÂÄã‰∫∫ÊÉÖÂ†±„Éû„Çπ„Ç≠„É≥„Ç∞**: ÊÇ£ËÄÖÊ∞èÂêç„ÄÅ‰ΩèÊâÄ„ÄÅÈõªË©±Áï™Âè∑„Å™„Å©„ÅÆÂÄã‰∫∫ÊÉÖÂ†±„ÅåÂê´„Åæ„Çå„ÇãÂ†¥Âêà„ÅØ„ÄÅ**Áµ∂ÂØæ„Å´ÂâäÈô§**„Åó„ÄÅ**[Ê∞èÂêçÂâäÈô§]** „Åæ„Åü„ÅØ **[ÊÉÖÂ†±ÂâäÈô§]** „Å®ÁΩÆÊèõ„Åô„Çã„ÄÇ
    2.  **Âè•Ë™≠ÁÇπË£úÂÆå**: ÈÅ©Âàá„Å™‰ΩçÁΩÆ„Å´Âè•Ë™≠ÁÇπÔºà„ÄÅ„ÄÇÔºâ„ÇíËøΩÂä†„Åó„ÄÅË™≠„Åø„ÇÑ„Åô„ÅÑÊñáÁ´†„Å´„Åô„Çã„ÄÇ
    3.  **Â∞ÇÈñÄÁî®Ë™ûË£úÊ≠£**: ÂåªÁôÇÁî®Ë™û„ÇÑÁï•Ë™ûÔºà‰æã: „Ç∑„Éß„ÉÉ„ÇØ‚Üí„Ç∑„Éß„ÉÉ„ÇØÁä∂ÊÖã„ÄÅPS‚Üí„Éó„É¨„Éõ„Çπ„Éî„Çø„É´Ôºâ„ÇíÊé®Ê∏¨„Åó„ÄÅÊ≠£„Åó„ÅÑÁî®Ë™û„Å´Ë£úÊ≠£„Åô„Çã„ÄÇ
    4.  **‰∏çË¶Å„Å™Áô∫Ë©±„ÅÆÂâäÈô§**: ÊÑèÂë≥„ÅÆ„Å™„ÅÑ„Äå„Åà„Éº„Å®„Äç„Äå„ÅÇ„ÅÆ„Éº„Äç„ÇÑ„ÄÅÁπ∞„ÇäËøî„Åó„ÄÅË™çË≠ò„Éü„Çπ„Å®ÊÄù„Çè„Çå„ÇãÂçòË™û„ÅØÂâäÈô§„Åô„Çã„ÄÇ
    5.  **Êï¥ÂΩ¢Âæå„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„ÅÆ„Åø„ÇíËøîÂç¥„Åó„ÄÅËß£Ë™¨„ÇÑÂâçÁΩÆ„Åç„ÅÆË®ÄËëâ„ÅØ‰∏ÄÂàáÂê´„ÇÅ„Å™„ÅÑ„ÄÇ**

    „ÄêÈü≥Â£∞Ë™çË≠òÁµêÊûú„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„Äë
    ${text}`;

    try {
      const response = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: prompt }] }],
          // 429„Ç®„É©„Éº„ÅÆÂéüÂõ†„Å®„Å™„Çã GroundingÔºàÊ§úÁ¥¢ÈÄ£Êê∫Ôºâ„ÅÆË®òËø∞„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü
          config: {
            temperature: 0.1,
          },
        }),
      });

      const data = await response.json();
      
      if (response.status === 429) {
          showSystemStatus('AIÊé•Á∂öÂ§±Êïó: „É™„ÇØ„Ç®„Çπ„Éà„ÅåÂ§ö„Åô„Åé„Åæ„Åô (429)„ÄÇÂà∂Èôê„Çí„ÅîÁ¢∫Ë™ç„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
          return text; 
      }
      
      if (!response.ok) {
        const errorDetail = data.error ? data.error.message : 'Ë©≥Á¥∞‰∏çÊòé';
        showSystemStatus(`AIÊé•Á∂öÂ§±Êïó: ${response.status} (${errorDetail})`, 'error');
        return text; 
      }
      
      if (data.candidates && data.candidates.length > 0) {
        return data.candidates[0].content.parts[0].text.trim();
      }
      
      showSystemStatus('AIÂøúÁ≠î„Ç®„É©„Éº: ÊúâÂäπ„Å™ÂÄôË£ú„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü', 'error');
      return text;

    } catch (error) {
      showSystemStatus('AIÊé•Á∂öÂ§±Êïó: „Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„ÇíÁ¢∫Ë™ç„Åô„Çã„Åã„ÄÅ„Ç≠„Éº„ÅÆÊúâÂäπÊÄß„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
      console.error('Gemini API Error:', error);
      return text;
    }
  }
}

// --- GPS and Address ---

async function getAddressFromCoords(lat, lon) {
    const NOMINATIM_URL = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1&accept-language=ja`;
    try {
        const response = await fetch(NOMINATIM_URL, {
            headers: { 'User-Agent': 'EmergencyRecordApp/v2.8.0' }
        });
        const data = await response.json();
        if (data.display_name) {
            // Êó•Êú¨Ë™û„Åß„Äå‰ΩèÊâÄ„Äç„ÇíÊé¢„Åó„ÄÅÁ∞°ÊΩî„Å´„Åô„Çã
            let address = data.display_name;
            if (data.address.road && data.address.house_number) {
                address = (data.address.state || '') + (data.address.city || '') + (data.address.town || '') + (data.address.village || '') + data.address.road + data.address.house_number;
            } else if (data.address.road) {
                address = (data.address.state || '') + (data.address.city || '') + (data.address.town || '') + (data.address.village || '') + data.address.road;
            }
            // ‰∏çË¶Å„Å™ÈÉ®ÂàÜ„ÇíÂâäÈô§Ôºà‰æãÔºöÊó•Êú¨„ÄÅ„Äí„ÄúÔºâ
            address = address.replace(/, Japan|„Äí\d{3}-\d{4}|[A-Za-z0-9\s]+$/, '').trim();
            return address;
        }
        return '‰ΩèÊâÄ‰∏çÊòé';
    } catch (e) {
        console.error('Address lookup failed:', e);
        return '‰ΩèÊâÄÂèñÂæó„Ç®„É©„Éº';
    }
}

function updateGpsStatus(msg, type = 'info') {
    const el = document.getElementById('gps-status');
    el.textContent = `GPS„Çπ„ÉÜ„Éº„Çø„Çπ: ${msg}`;
    el.style.color = type === 'error' ? '#e74c3c' : (type === 'success' ? '#28a745' : '#1abc9c');
}

function updateCurrentPosition() {
    if (navigator.geolocation) {
        updateGpsStatus('‰ΩçÁΩÆÊÉÖÂ†±ÂèñÂæó‰∏≠...');
        navigator.geolocation.getCurrentPosition(async (position) => {
            currentPosition = {
                lat: position.coords.latitude,
                lon: position.coords.longitude
            };
            const address = await getAddressFromCoords(currentPosition.lat, currentPosition.lon);
            currentPosition.address = address;
            save();
            updateGpsStatus(`ÊúÄÁµÇÂèñÂæó: ${nowHHMMSS()} - ${address}`, 'success');
        }, (error) => {
            updateGpsStatus(`„Ç®„É©„Éº: ${error.message}`, 'error');
        }, {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
        });
    } else {
        updateGpsStatus('„Éñ„É©„Ç¶„Ç∂„Åå‰ΩçÁΩÆÊÉÖÂ†±„Å´ÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì', 'error');
    }
}


// --- Log and Case Management ---

async function addLine(text, tag = false) {
  if (text.trim() === '') return;
  if (!currentCase.startTime) {
    currentCase.startTime = nowHHMMSS();
  }
  
  const newLog = {
    id: generateId(),
    time: nowHHMMSS(),
    text: text,
    tag: tag,
    status: 'raw', // raw, processing, corrected, error
    address: currentPosition ? currentPosition.address : null,
    coords: currentPosition ? { lat: currentPosition.lat, lon: currentPosition.lon } : null
  };

  currentCase.logs.push(newLog);
  save();
  render();
  updateStats();
  
  // AIÊï¥ÂΩ¢Âá¶ÁêÜ„ÅÆÂÆüË°å
  const useAI = document.getElementById('useAI').checked;
  if (useAI && geminiClient.hasKey()) {
    newLog.status = 'processing';
    render(); // Âá¶ÁêÜ‰∏≠„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÂèçÊò†
    
    // AIÊï¥ÂΩ¢„ÇíÂÆüË°å
    const correctedText = await geminiClient.correctText(newLog.text);
    
    // ÂøúÁ≠î„ÉÅ„Çß„ÉÉ„ÇØ
    if (correctedText !== newLog.text) {
        newLog.text = correctedText;
        newLog.status = 'corrected';
        FeedbackManager.speak('Ë®òÈå≤„Åó„Åæ„Åó„Åü');
    } else {
        newLog.status = 'error'; // „Ç®„É©„ÉºÊôÇ„ÇÑ„Ç≠„Éº„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„Ç®„É©„ÉºË°®Á§∫
    }
    
    save();
    render();
    updateStats();
  } else {
      newLog.status = 'success';
      FeedbackManager.speak('Ë®òÈå≤„Åó„Åæ„Åó„Åü');
      save();
      render();
      updateStats();
  }
}

function endCase() {
  if (currentCase.logs.length === 0) {
    showSystemStatus('Ë®òÈå≤„Åå„Å™„ÅÑ„Åü„ÇÅ„ÄÅ‰∫ã‰æã„ÇíÁµÇ‰∫Ü„Åß„Åç„Åæ„Åõ„Çì', 'error');
    return;
  }
  if (!confirm('ÁèæÂú®„ÅÆ‰∫ã‰æã„ÇíÁµÇ‰∫Ü„Åó„ÄÅÈÅéÂéª„ÅÆ‰∫ã‰æã„Å®„Åó„Å¶„Ç¢„Éº„Ç´„Ç§„Éñ„Åó„Åæ„Åô„ÅãÔºü')) return;

  const caseId = `Case_${currentCase.startTime}_${Date.now()}`;
  const archivedCase = {
    ...currentCase,
    id: caseId,
    endTime: nowHHMMSS(),
    summary: currentCase.logs.map(l => l.text).join(' / ')
  };
  pastCases.unshift(archivedCase); // Êñ∞„Åó„ÅÑ‰∫ã‰æã„Çí„É™„Çπ„Éà„ÅÆÂÖàÈ†≠„Å´ËøΩÂä†

  // Êñ∞„Åó„ÅÑCurrent Case„ÇíÂàùÊúüÂåñ
  currentCase = {
    id: 'current',
    startTime: null,
    logs: []
  };
  currentPosition = null; // ‰ΩçÁΩÆÊÉÖÂ†±„ÇÇ„É™„Çª„ÉÉ„Éà

  save();
  renderCaseFilter(); // „Éï„Ç£„É´„Çø„Ç™„Éó„Ç∑„Éß„É≥„ÇíÊõ¥Êñ∞
  showSystemStatus(`‰∫ã‰æã ${caseId} „Çí„Ç¢„Éº„Ç´„Ç§„Éñ„Åó„Åæ„Åó„Åü`, 'success');
  
  // Ë°®Á§∫„ÅÆÂàá„ÇäÊõø„Åà
  document.getElementById('caseFilter').value = 'current';
  render();
  updateStats();
  
  // UI‰∏ä„ÅÆË°®Á§∫„Çí„É™„Çª„ÉÉ„Éà
  document.getElementById('currentCaseId').textContent = 'Êú™ÈñãÂßã';
}

function deleteCase(id) {
    if (!confirm(`‰∫ã‰æã ${id} „ÇíÂÆåÂÖ®„Å´ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü\n„Åì„ÅÆÊìç‰Ωú„ÅØÂÖÉ„Å´Êàª„Åõ„Åæ„Åõ„Çì„ÄÇ`)) return;
    pastCases = pastCases.filter(c => c.id !== id);
    save();
    renderCaseFilter();
    render();
    showSystemStatus('‰∫ã‰æã„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'success');
}

function getLogsToDisplay() {
    const filterId = document.getElementById('caseFilter').value;
    const keyword = document.getElementById('searchKeyword').value.toLowerCase();
    
    let targetLogs = [];
    if (filterId === 'current') {
        targetLogs = currentCase.logs;
    } else {
        const caseToView = pastCases.find(c => c.id === filterId);
        targetLogs = caseToView ? caseToView.logs : [];
    }

    if (keyword === '') {
        return targetLogs;
    } else {
        return targetLogs.filter(log => 
            log.text.toLowerCase().includes(keyword) || 
            (log.address && log.address.toLowerCase().includes(keyword))
        );
    }
}

function updateStats() {
    const logs = currentCase.logs;
    document.getElementById('totalLogs').textContent = logs.length;
    
    if (logs.length > 1) {
      const [h1, m1, s1] = logs[0].time.split(':');
      const [h2, m2, s2] = logs[logs.length - 1].time.split(':');
      const diff = Math.floor(((h2 * 3600 + m2 * 60 + s2 * 1) - (h1 * 3600 + m1 * 60 + s1 * 1)) / 60);
      document.getElementById('totalTime').textContent = diff + 'ÂàÜ';
    } else {
      document.getElementById('totalTime').textContent = '0ÂàÜ';
    }
    
    document.getElementById('filteredCount').textContent = getLogsToDisplay().length;
}

function clearAll() {
    if (!confirm('ÁèæÂú®„ÅÆ‰∫ã‰æã„Å®ÈÅéÂéª„ÅÆÂÖ®„Å¶„ÅÆ‰∫ã‰æã„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü\nÔºàAPI„Ç≠„Éº„ÅØ‰øùÊåÅ„Åï„Çå„Åæ„ÅôÔºâ')) return;
    currentCase = { id: 'current', startTime: null, logs: [] };
    pastCases = [];
    currentPosition = null;
    save();
    renderCaseFilter();
    render();
    updateStats();
    showSystemStatus('ÂÖ®Ë®òÈå≤„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'success');
    document.getElementById('currentCaseId').textContent = 'Êú™ÈñãÂßã';
}

function copyLogs(addr) {
    const logs = getLogsToDisplay();
    const txt = logs.map(l => {
        let line = `${l.time} ${l.text}`;
        if (addr && l.address) {
            line += ` (${l.address})`;
        }
        return line;
    }).join('\n');
    navigator.clipboard.writeText(txt);
    alert('„Ç≥„Éî„ÉºÂÆå‰∫Ü');
}

// --- Rendering ---

function renderLog(log) {
    const row = document.createElement('div');
    row.className = 'log-row';
    
    const statusText = {
        raw: '',
        processing: 'ü§ñ AIÊï¥ÂΩ¢‰∏≠...',
        corrected: 'AIÊ∏à',
        error: 'AI„Ç®„É©„Éº'
    }[log.status] || '';

    let addressHtml = '';
    if (log.address) {
        addressHtml = `<div class="log-address">${log.address}</div>`;
    }

    row.innerHTML = `
        <div class="log-time">${log.time}</div>
        <div class="log-text">
            ${log.text}
            <span class="log-status ${log.status}">${statusText}</span>
            ${addressHtml}
        </div>
        <div class="log-actions">
            <button onclick="window.openEditModal('${log.id}')">Á∑®ÈõÜ</button>
            <button onclick="deleteLog('${log.id}')">ÂâäÈô§</button>
        </div>
    `;
    return row;
}

function renderCase(caseData) {
    const container = document.createElement('div');
    container.className = 'past-case';
    container.innerHTML = `
        <div class="past-case-title">‰∫ã‰æãID: ${caseData.id}</div>
        <div class="past-case-meta">
            ÈñãÂßã: ${caseData.startTime} / ÁµÇ‰∫Ü: ${caseData.endTime || '‰∏çÊòé'} / Ë®òÈå≤Êï∞: <span class="past-case-log-count">${caseData.logs.length}</span>
        </div>
        <div class="past-case-actions">
            <button onclick="viewCase('${caseData.id}')">„É≠„Ç∞Ë°®Á§∫</button>
            <button class="btn-delete" onclick="deleteCase('${caseData.id}')">ÂâäÈô§</button>
        </div>
    `;
    return container;
}

function renderCaseFilter() {
    const select = document.getElementById('caseFilter');
    // Clear existing options except 'current'
    while (select.options.length > 1) {
        select.remove(1);
    }
    
    // Add past cases
    pastCases.forEach(c => {
        const option = document.createElement('option');
        option.value = c.id;
        option.textContent = `ÈÅéÂéª‰∫ã‰æã: ${c.startTime} (${c.logs.length}‰ª∂)`;
        select.appendChild(option);
    });
}

function render() {
    const container = document.getElementById('logContainer');
    container.innerHTML = '';
    
    const filterId = document.getElementById('caseFilter').value;
    
    if (filterId === 'current') {
        document.getElementById('currentCaseId').textContent = currentCase.startTime || 'Êú™ÈñãÂßã';
        
        const logs = getLogsToDisplay().reverse(); // Êñ∞„Åó„ÅÑ„ÇÇ„ÅÆ„Çí‰∏ä„Å´„Åô„Çã
        logs.forEach(log => {
            container.appendChild(renderLog(log));
        });
        
    } else {
        document.getElementById('currentCaseId').textContent = 'Êú™ÈñãÂßã';
        
        // ÈÅéÂéª‰∫ã‰æã„ÇíË°®Á§∫
        pastCases.forEach(c => {
            if (c.id === filterId) {
                // ÈÅ∏Êäû„Åï„Çå„ÅüÈÅéÂéª‰∫ã‰æã„ÅÆ„É≠„Ç∞„ÇíË°®Á§∫
                const logs = getLogsToDisplay().reverse(); 
                logs.forEach(log => {
                    container.appendChild(renderLog(log));
                });
                // ‰∫ã‰æã„ÅÆÊ¶ÇË¶Å„ÇíË°®Á§∫„Åô„Çã„Åì„Å®„ÇÇÂèØËÉΩ
            } else {
                 container.appendChild(renderCase(c));
            }
        });
        
        // ÈÅéÂéª‰∫ã‰æãÂÖ®‰ª∂Ë°®Á§∫„É¢„Éº„ÉâÔºà„Éï„Ç£„É´„Çø„ÅåÈÅ©Áî®„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥ÂêàÔºâ
        if (filterId === 'past-all') {
            pastCases.forEach(c => {
                container.appendChild(renderCase(c));
            });
        }
    }
}

// --- Edit Modal Handlers ---

window.openEditModal = (id) => {
    editingLogId = id;
    const row = currentCase.logs.find(r => r.id === id) || pastCases.flatMap(c => c.logs).find(r => r.id === id);
    if (row) {
        document.getElementById('editText').value = row.text;
        document.getElementById('editModal').style.display = 'flex';
    }
};

document.getElementById('btnSaveEdit').onclick = () => {
    // ÁèæÂú®„ÅÆ‰∫ã‰æã„ÅãÈÅéÂéª„ÅÆ‰∫ã‰æã„Åã„ÇíÊé¢„Åô
    let row = currentCase.logs.find(r => r.id === editingLogId);
    if (!row) {
        row = pastCases.flatMap(c => c.logs).find(r => r.id === editingLogId);
    }

    if (row) {
        row.text = document.getElementById('editText').value;
        row.status = 'manual'; // ÊâãÂãïÁ∑®ÈõÜ
        save();
        render();
    }
    document.getElementById('editModal').style.display = 'none';
};

document.getElementById('btnCancelEdit').onclick = () => {
    document.getElementById('editModal').style.display = 'none';
};

window.deleteLog = (id) => {
    if (!confirm('„Åì„ÅÆË®òÈå≤„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;
    
    // ÁèæÂú®„ÅÆ‰∫ã‰æã„Åã„ÇâÂâäÈô§
    const initialLength = currentCase.logs.length;
    currentCase.logs = currentCase.logs.filter(l => l.id !== id);
    
    // ÈÅéÂéª„ÅÆ‰∫ã‰æã„Åã„Çâ„ÇÇÂâäÈô§ÔºàÂøµ„ÅÆ„Åü„ÇÅÔºâ
    if(currentCase.logs.length === initialLength) {
        pastCases.forEach(c => {
            c.logs = c.logs.filter(l => l.id !== id);
        });
    }

    save();
    render();
    updateStats();
    showSystemStatus('Ë®òÈå≤„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'success');
};


// --- Speech Recognition ---

let recognition;
let finalTranscript = '';
let inputEl;
let micStatusEl;

if ('webkitSpeechRecognition' in window) {
    recognition = new webkitSpeechRecognition();
    recognition.continuous = true;
    recognition.interimResults = true;
    recognition.lang = 'ja-JP';

    recognition.onstart = function() {
        micStatusEl.textContent = 'Èå≤Èü≥‰∏≠...';
        micStatusEl.style.color = '#e74c3c';
        FeedbackManager.playBeep(660, 100);
    };

    recognition.onerror = function(event) {
        if (event.error === 'no-speech') {
            micStatusEl.textContent = 'ÁÑ°Èü≥';
        } else if (event.error === 'audio-capture') {
            micStatusEl.textContent = '„Éû„Ç§„ÇØ„Ç®„É©„Éº';
        } else if (event.error === 'not-allowed') {
            micStatusEl.textContent = '„Éû„Ç§„ÇØÊãíÂê¶';
        } else {
            micStatusEl.textContent = '„Ç®„É©„Éº';
        }
        console.error('Recognition error:', event.error);
    };

    recognition.onend = function() {
        micStatusEl.textContent = 'ÂæÖÊ©ü‰∏≠';
        micStatusEl.style.color = '#6c757d';
        
        // Ë™çË≠ò„ÅåÁµÇ‰∫Ü„Åó„Åü„ÇâËá™ÂãïÁöÑ„Å´ÂÜç„Çπ„Çø„Éº„Éà„ÇíË©¶„Åø„Çã
        if (finalTranscript.trim() !== '') {
            // finalTranscript„ÅåÊÆã„Å£„Å¶„ÅÑ„Çå„Å∞„ÄÅ„Åù„Çå„ÅØ„Ç®„É©„Éº„Å´„Çà„ÇãÁµÇ‰∫Ü„Å™„ÅÆ„Åß„ÄÅË®òÈå≤„Åõ„Åö„Å´„ÇØ„É™„Ç¢
            finalTranscript = '';
        }
        
        // ÈÄ£Á∂öË™çË≠ò„ÅÆ„Åü„ÇÅ„Å´ÂÜçËµ∑Âãï„ÇíË©¶„Åø„ÇãÔºà„Åü„Å†„Åó„ÄÅ„Ç®„É©„ÉºÂæå„ÅÆ„É´„Éº„Éó„ÇíÈò≤„Åê„Åü„ÇÅÈÅÖÂª∂„Åï„Åõ„ÇãÔºâ
        setTimeout(() => {
            try {
                 recognition.start();
            } catch(e) {
                 console.warn("Recognition restart failed, waiting longer.");
            }
        }, 500);
    };

    recognition.onresult = function(event) {
        let interimTranscript = '';
        
        for (let i = event.resultIndex; i < event.results.length; ++i) {
            const transcript = event.results[i][0].transcript;
            if (event.results[i].isFinal) {
                finalTranscript += transcript;
            } else {
                interimTranscript += transcript;
            }
        }
        
        // Á¢∫ÂÆö„Åó„ÅüÂàÜ„Å®Êú™Á¢∫ÂÆö„ÅÆÂàÜ„ÇíÁµêÂêà„Åó„Å¶Ë°®Á§∫
        inputEl.value = finalTranscript + interimTranscript;
        
        // Á¢∫ÂÆö„Åó„ÅüÈÉ®ÂàÜ„Åå„ÅÇ„Çå„Å∞„É≠„Ç∞„Å´ËøΩÂä†
        if (finalTranscript.trim() !== '') {
            const textToSave = finalTranscript.trim();
            finalTranscript = ''; // „ÇØ„É™„Ç¢„Åó„Å¶Ê¨°„ÅÆË™çË≠ò„Å∏
            inputEl.value = interimTranscript; // Êú™Á¢∫ÂÆöÈÉ®ÂàÜ„Å†„ÅëÊÆã„Åô
            
            addLine(textToSave);
        }
    };
    
} else {
    document.getElementById('mic-status').textContent = 'Èü≥Â£∞Ë™çË≠òÈùûÂØæÂøú';
    document.getElementById('mic-status').style.color = '#e74c3c';
}

// --- Tag Buttons ---

const TAGS = [
    { text: "Ë¶öÁü•", className: "tag-critical" },
    { text: "Âá∫Âãï", className: "" },
    { text: "ÁèæÁùÄ", className: "tag-critical" },
    { text: "Êé•Ëß¶", className: "" },
    { text: "ÂåªÂ∏´Ë¶ÅË´ã", className: "tag-critical" },
    { text: "„Éâ„ÇØ„Çø„Éº„Ç´„Éº", className: "" },
    { text: "„Éò„É™Ë¶ÅË´ã", className: "" },
    { text: "ÁóÖÁùÄ", className: "tag-critical" },
    { text: "ÂºïÁ∂ô„Åé", className: "" },
    { text: "ÁèæÂ†¥Èõ¢ËÑ±", className: "" },
    { text: "Â∏∞ÁΩ≤", className: "" },
];

function renderTagButtons() {
    const container = document.getElementById('tagButtons');
    container.innerHTML = '';
    
    TAGS.forEach(tag => {
        const button = document.createElement('button');
        button.textContent = tag.text;
        button.className = tag.className;
        button.onclick = () => addLine(`${tag.text}„Åó„Åæ„Åó„Åü„ÄÇ`, true);
        container.appendChild(button);
    });
}


// --- Initialization ---

let geminiClient = new GeminiClient();

document.addEventListener('DOMContentLoaded', () => {
    inputEl = document.getElementById('input');
    micStatusEl = document.getElementById('mic-status');
    
    FeedbackManager.init();
    
    load();
    renderTagButtons();
    renderCaseFilter();
    render();
    updateStats();
    
    // UI„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
    document.getElementById('btnEndCase').onclick = endCase;
    document.getElementById('btnGetAddr').onclick = updateCurrentPosition;
    document.getElementById('btnClear').onclick = clearAll;
    document.getElementById('btnCopy').onclick = () => copyLogs(false);
    document.getElementById('btnCopyAddr').onclick = () => copyLogs(true);
    
    document.getElementById('caseFilter').onchange = render;
    document.getElementById('searchKeyword').oninput = render;
    
    // Clock
    function initClock() {
        const clock = document.getElementById('clock');
        const tick = () => {
            clock.textContent = nowHHMMSS();
        };
        tick();
        setInterval(tick, 1000);
    }
    initClock();

    // Èü≥Â£∞Ë™çË≠ò„ÅÆÈñãÂßã
    if (recognition) {
        try {
            recognition.start();
        } catch(e) {
            console.warn("Recognition start failed on load:", e);
        }
    }
});

</script>
</body>
</html>
