<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<title>æ•‘æ€¥è¨˜éŒ² - Emergency Doc</title>
<style>
  /* ====== iPhoneæœ€é©åŒ–è¨­è¨ˆ ====== */
  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: rgba(0,0,0,0); }
  body {
    background: #f8f9fa; min-height: 100vh; color: #212529;
    font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Yu Gothic','Hiragino Sans',sans-serif;
    line-height: 1.4; font-size: 14px; -webkit-text-size-adjust: 100%; touch-action: manipulation; overflow-x: hidden;
  }
  /* ========== ãƒ˜ãƒƒãƒ€ãƒ¼ (è¶…ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆ) ========== */
  header {
    background: #fff; border-bottom: 2px solid #e74c3c; padding: 6px 10px; box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    position: sticky; top: 0; z-index: 100;
  }
  .header-content { display: flex; justify-content: space-between; align-items: center; }
  h1 { font-size: 14px; font-weight: 700; color: #e74c3c; }
  .clock { font-size: 16px; font-weight: 700; color: #2c3e50; font-variant-numeric: tabular-nums; }
  /* ========== ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ ========== */
  .wrap { padding: 6px; }
  .grid { display: flex; flex-direction: column; gap: 6px; }
  /* ========== ã‚«ãƒ¼ãƒ‰ ========== */
  .card { background: #fff; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
  .card h2 { padding: 6px 10px; border-bottom: 2px solid #3498db; font-size: 12px; font-weight: 700; color: #2c3e50; background: #ecf0f1; }
  .card .body { padding: 8px; }
  /* ========== éŸ³å£°èªè­˜ ========== */
  .voice-control {
    display: flex; gap: 8px; align-items: center; padding: 8px; background: #ecf0f1; border-radius: 6px; margin-bottom: 6px;
  }
  .voice-btn {
    flex-shrink: 0; width: 52px; height: 52px; border: none; border-radius: 50%;
    background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    color: #fff; font-size: 22px; box-shadow: 0 2px 6px rgba(231,76,60,0.3);
  }
  .voice-btn:active { transform: scale(0.95); }
  .voice-btn.active { background: linear-gradient(135deg, #27ae60 0%, #229954 100%); animation: pulse-voice 1.5s infinite; }
  @keyframes pulse-voice { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
  .voice-status { flex: 1; min-width: 0; }
  .voice-status-title { font-size: 10px; font-weight: 600; color: #2c3e50; margin-bottom: 2px; }
  .voice-status-text { font-size: 9px; color: #7f8c8d; line-height: 1.2; }
  .voice-interim { margin-top: 4px; padding: 4px 6px; background: #fff; border-radius: 4px; border-left: 2px solid #3498db; font-size: 10px; color: #7f8c8d; font-style: italic; min-height: 16px; }
  /* ========== å…¥åŠ›ã‚¨ãƒªã‚¢ ========== */
  textarea {
    width: 100%; min-height: 50px; border: 2px solid #bdc3c7; border-radius: 6px; padding: 6px;
    font-size: 13px; line-height: 1.4; resize: vertical; font-family: inherit; background: #fff;
  }
  textarea:focus { outline: none; border-color: #3498db; box-shadow: 0 0 0 2px rgba(52,152,219,0.2); }
  /* ========== ã‚µã‚¸ã‚§ã‚¹ãƒˆ ========== */
  .suggestions { margin-top: 4px; padding: 4px; background: #e8f4f8; border-radius: 4px; border-left: 2px solid #3498db; max-height: 100px; overflow-y: auto; }
  .suggestions-title { font-size: 9px; font-weight: 600; color: #2c3e50; margin-bottom: 3px; }
  .suggestion-item {
    display: inline-block; padding: 4px 8px; margin: 2px; background: #fff; border: 1px solid #3498db; border-radius: 10px; font-size: 10px; color: #2c3e50; min-height: 28px; line-height: 1.8;
  }
  .suggestion-item:active { background: #3498db; color: #fff; }
  /* ========== ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« ========== */
  .controls { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 6px; }
  .pill {
    display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; border: 1px solid #bdc3c7; border-radius: 12px;
    background: #ecf0f1; font-size: 10px; color: #2c3e50; font-weight: 500;
  }
  .pill select, .pill input[type="number"] { border: none; background: transparent; font-size: 10px; font-weight: 600; color: #2c3e50; }
  .pill input[type="checkbox"] { width: 14px; height: 14px; }
  /* ========== ãƒœã‚¿ãƒ³ ========== */
  .btn {
    border: none; background: #3498db; color: #fff; border-radius: 6px; padding: 8px 12px; font-weight: 600; font-size: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    min-height: 40px; display: inline-flex; align-items: center; justify-content: center;
  }
  .btn:active { transform: scale(0.97); opacity: 0.9; }
  .btn.success { background: #27ae60; }
  .btn.danger { background: #e74c3c; }
  .btn.warning { background: #f39c12; }
  /* ========== ã‚¿ã‚°ãƒœã‚¿ãƒ³ ========== */
  .tag-buttons {
    display: flex; flex-wrap: wrap; gap: 3px; margin-top: 6px; max-height: 180px; overflow-y: auto; padding: 6px; background: #f8f9fa; border-radius: 6px; -webkit-overflow-scrolling: touch;
  }
  .tag-buttons .btn {
    background: #e8f4f8; color: #2c3e50; font-size: 10px; padding: 5px 8px; border-radius: 10px; border: 1px solid #3498db; min-height: 30px;
  }
  .tag-buttons .btn:active { background: #3498db; color: #fff; }
  /* ========== ãƒ¡ã‚¤ãƒ³ãƒœã‚¿ãƒ³ ========== */
  .main-buttons { margin-top: 8px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; }
  .main-buttons .btn { padding: 10px 8px; font-size: 11px; }
  /* ========== çµ±è¨ˆ ========== */
  .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 8px; }
  .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; padding: 8px; border-radius: 6px; text-align: center; }
  .stat-value { font-size: 18px; font-weight: 700; margin-bottom: 2px; }
  .stat-label { font-size: 9px; opacity: 0.9; }
  /* ========== ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ ========== */
  .timeline { max-height: 35vh; overflow-y: auto; -webkit-overflow-scrolling: touch; }
  ul.log { list-style: none; display: flex; flex-direction: column; gap: 5px; }
  .row {
    padding: 6px; border-left: 3px solid #3498db; border-radius: 5px; background: #f8f9fa; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
  }
  .row:active { background: #fff; }
  .row.selected {
    background: #e8f4f8; border-left-color: #e74c3c; box-shadow: 0 2px 4px rgba(231,76,60,0.15);
  }
  .time { font-size: 10px; color: #3498db; margin-bottom: 3px; font-weight: 700; display: flex; align-items: center; gap: 4px; }
  .elapsed { font-size: 8px; color: #7f8c8d; font-weight: 500; background: #ecf0f1; padding: 1px 5px; border-radius: 6px; }
  .addr { font-size: 10px; color: #2c3e50; margin: 2px 0 4px; padding-left: 4px; border-left: 2px solid #27ae60; background: #eef9f1; border-radius: 3px; }
  .addr.muted { opacity: 0.35; border-left-color: #bdc3c7; background: #f3f4f6; }
  .text { white-space: pre-wrap; word-break: break-word; font-size: 12px; margin-bottom: 3px; color: #2c3e50; line-height: 1.4; }
  .tags { margin-top: 3px; display: flex; flex-wrap: wrap; gap: 3px; }
  .tag { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; border-radius: 8px; padding: 1px 6px; font-size: 8px; font-weight: 600; }
  .row .tools { position: absolute; top: 4px; right: 4px; display: flex; gap: 3px; opacity: 0.8; }
  .row.selected .tools { opacity: 1; }
  .tools .btn { font-size: 9px; padding: 3px 6px; min-height: 28px; }
  .empty-state { text-align: center; padding: 25px 12px; color: #7f8c8d; font-size: 12px; }
  /* ========== ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆä»¥ä¸Š ========== */
  @media (min-width: 768px){
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    textarea { min-height: 90px; }
    .timeline { max-height: 55vh; }
    h1 { font-size: 16px; }
    .clock { font-size: 20px; }
  }
</style>
</head>
<body>
  <!-- ========== ãƒ˜ãƒƒãƒ€ãƒ¼ ========== -->
  <header>
    <div class="header-content">
      <h1>ğŸš‘ æ•‘æ€¥è¨˜éŒ²</h1>
      <div class="clock" id="clock">--:--:--</div>
    </div>
  </header>

  <!-- ========== ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ ========== -->
  <div class="wrap">
    <div class="grid">
      <!-- ========== å…¥åŠ›ãƒ‘ãƒãƒ« ========== -->
      <section class="card">
        <h2>ğŸ“ å…¥åŠ›</h2>
        <div class="body">
          <!-- éŸ³å£°èªè­˜ -->
          <div class="voice-control">
            <button id="voiceBtn" type="button" class="voice-btn">ğŸ¤</button>
            <div class="voice-status">
              <div class="voice-status-title" id="voiceStatusTitle">åœæ­¢ä¸­</div>
              <div class="voice-status-text" id="voiceStatusText">ã‚¿ãƒƒãƒ—ã§é–‹å§‹</div>
              <div class="voice-interim" id="voiceInterim"></div>
            </div>
          </div>

          <textarea id="input" placeholder="éŒ²éŸ³ãƒ‡ãƒ¼ã‚¿ã¯ã“ã“ã«ä¸€æ™‚çš„ã«è¡¨ç¤ºã•ã‚Œã¾ã™"></textarea>

          <!-- ã‚µã‚¸ã‚§ã‚¹ãƒˆ -->
          <div id="suggestions" class="suggestions" style="display:none;">
            <div class="suggestions-title">ğŸ’¡ å€™è£œ</div>
            <div id="suggestionItems"></div>
          </div>

          <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
          <div class="controls">
            <label class="pill">â± <select id="idleSec"></select></label>
            <label class="pill">ğŸ“ <input id="minLen" type="number" min="1" max="20" value="2"></label>
            <label class="pill"><input id="punct" type="checkbox" checked> å¥ç‚¹ã§ç¢ºå®š</label>
            <label class="pill"><input id="gpsHi" type="checkbox" checked> GPS</label>
            <label class="pill">â³ <input id="gpsTimeout" type="number" min="2" max="20" value="6"> ç§’</label>
          </div>

          <!-- ã‚¿ã‚°ãƒœã‚¿ãƒ³ -->
          <div class="tag-buttons" id="tagButtons"></div>

          <!-- ãƒ¡ã‚¤ãƒ³ãƒœã‚¿ãƒ³ -->
          <div class="main-buttons">
            <button id="btnCopy" type="button" class="btn success" title="ä½æ‰€ãªã—ã§ã‚³ãƒ”ãƒ¼">ğŸ“‹ ã‚³ãƒ”ãƒ¼(ä½æ‰€ãªã—)</button>
            <button id="btnCopyAddr" type="button" class="btn success" title="ä½æ‰€ä»˜ãã§ã‚³ãƒ”ãƒ¼">ğŸ“‹ ã‚³ãƒ”ãƒ¼(ä½æ‰€ã‚ã‚Š)</button>
            <button id="btnClear" type="button" class="btn danger">ğŸ—‘ å…¨æ¶ˆå»</button>
          </div>
        </div>
      </section>

      <!-- ========== ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ ========== -->
      <section class="card">
        <h2>â° è¨˜éŒ²</h2>
        <div class="body">
          <div class="stats">
            <div class="stat-card">
              <div class="stat-value" id="totalLogs">0</div>
              <div class="stat-label">ä»¶æ•°</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="totalTime">0åˆ†</div>
              <div class="stat-label">çµŒé</div>
            </div>
          </div>
          <div class="timeline">
            <ul id="log" class="log"></ul>
          </div>
        </div>
      </section>
    </div>
  </div>

<script>
  const STORE_KEY='emergency-doc-v2';
  let logs=[]; let selectedId=null; let startTime=null;

  const TAGS=[
    "æ•‘æ€¥è¦šçŸ¥","æ•‘æ€¥æŒ‡ä»¤","æ•‘æ€¥å‡ºå‹•","æ•‘æ€¥ç¾ç€","æ•‘æ€¥æ¥è§¦","è»Šå†…åå®¹","ç¾ç™º","ç—…ç€",
    "ãƒ˜ãƒªè¦šçŸ¥","ãƒ˜ãƒªæŒ‡ä»¤","ãƒ˜ãƒªå‡ºå‹•","ãƒ˜ãƒªç¾ç€","ãƒ•ãƒ©ã‚¤ãƒˆãƒ‰ã‚¯ã‚¿ãƒ¼æ¥è§¦","ãƒ©ãƒ³ãƒ‡ãƒ–ãƒ¼ãƒã‚¤ãƒ³ãƒˆç€",
    "ã‚«ãƒ¼è¦šçŸ¥","ã‚«ãƒ¼æŒ‡ä»¤","ã‚«ãƒ¼å‡ºå‹•","ã‚«ãƒ¼ç¾ç€","ã‚«ãƒ¼æ¥è§¦","ãƒ‰ãƒƒã‚­ãƒ³ã‚°","åŒ»å¸«æ¥è§¦",
    "ç¾ç—…æ­´","æ—¢å¾€ç—‡","ã‹ã‹ã‚Šã¤ã‘æƒ…å ±",
    "æ°—ç®¡æŒ¿ç®¡","äººå·¥å‘¼å¸","ãƒãƒƒã‚¯ãƒãƒ«ãƒ–ãƒã‚¹ã‚¯æ›æ°—","é…¸ç´ æŠ•ä¸","é…¸ç´ æŠ•ä¸é‡","NPPV",
    "ãƒ«ãƒ¼ãƒˆç¢ºä¿","ç”Ÿé£Ÿç‚¹æ»´","ã‚½ãƒ«ã‚¢ã‚»ãƒˆFç‚¹æ»´","å¤§è…¿å‹•è„ˆ","å¤§è…¿é™è„ˆ","éª¨é«„é‡",
    "è¡€ã‚¬ã‚¹","è¡€ç³–","ç°¡æ˜“è¶…éŸ³æ³¢æ¤œæŸ»",
    "èƒ¸éª¨åœ§è¿«","é–‹èƒ¸","å¿ƒè‡“ãƒãƒƒã‚µãƒ¼ã‚¸",
    "ã‚¢ãƒ‰ãƒ¬ãƒŠãƒªãƒ³","ãƒŸãƒ€ã‚¾ãƒ©ãƒ ","ã‚¸ã‚¢ã‚¼ãƒ‘ãƒ ","ã‚¤ãƒ¼ã‚±ãƒ—ãƒ©","ãƒãƒ«ã‚¢ãƒ‰ãƒ¬ãƒŠãƒªãƒ³","ãƒ¬ãƒšã‚¿ãƒ³"
  ];

  const TERM_NORM={
    "è¦šçŸ¥":"æ•‘æ€¥è¦šçŸ¥","ã‹ãã¡":"æ•‘æ€¥è¦šçŸ¥","è¦šåœ°":"æ•‘æ€¥è¦šçŸ¥",
    "æŒ‡ä»¤":"æ•‘æ€¥æŒ‡ä»¤","ã—ã‚Œã„":"æ•‘æ€¥æŒ‡ä»¤",
    "å‡ºå‹•":"æ•‘æ€¥å‡ºå‹•","ã—ã‚…ã¤ã©ã†":"æ•‘æ€¥å‡ºå‹•",
    "ç¾ç€":"æ•‘æ€¥ç¾ç€","ã’ã‚“ã¡ã‚ƒã":"æ•‘æ€¥ç¾ç€","ã’ã‚“ã¡ã‚ƒã":"æ•‘æ€¥ç¾ç€",
    "æ¥è§¦":"æ•‘æ€¥æ¥è§¦","ã›ã£ã—ã‚‡ã":"æ•‘æ€¥æ¥è§¦",
    "ãƒ˜ãƒªæ¥è§¦":"ãƒ•ãƒ©ã‚¤ãƒˆãƒ‰ã‚¯ã‚¿ãƒ¼æ¥è§¦","ãƒ•ãƒ©ã‚¤ãƒˆãƒ‰ã‚¯ã‚¿ãƒ¼":"ãƒ•ãƒ©ã‚¤ãƒˆãƒ‰ã‚¯ã‚¿ãƒ¼æ¥è§¦",
    "æŒ¿ç®¡":"æ°—ç®¡æŒ¿ç®¡","ãã†ã‹ã‚“":"æ°—ç®¡æŒ¿ç®¡","æ°—ç®¡æŒ¿ç®¡":"æ°—ç®¡æŒ¿ç®¡",
    "äººå·¥å‘¼å¸":"äººå·¥å‘¼å¸","ã˜ã‚“ã“ã†ã“ãã‚…ã†":"äººå·¥å‘¼å¸",
    "ãƒãƒƒã‚¯ãƒãƒ«ãƒ–ãƒã‚¹ã‚¯":"ãƒãƒƒã‚¯ãƒãƒ«ãƒ–ãƒã‚¹ã‚¯æ›æ°—","BVM":"ãƒãƒƒã‚¯ãƒãƒ«ãƒ–ãƒã‚¹ã‚¯æ›æ°—",
    "é…¸ç´ ":"é…¸ç´ æŠ•ä¸","ã•ã‚“ã":"é…¸ç´ æŠ•ä¸","O2":"é…¸ç´ æŠ•ä¸","ã‚ªãƒ¼ãƒ„ãƒ¼":"é…¸ç´ æŠ•ä¸",
    "ãƒ«ãƒ¼ãƒˆ":"ãƒ«ãƒ¼ãƒˆç¢ºä¿","ãƒ©ã‚¤ãƒ³":"ãƒ«ãƒ¼ãƒˆç¢ºä¿","é™è„ˆè·¯":"ãƒ«ãƒ¼ãƒˆç¢ºä¿",
    "ç”Ÿé£Ÿ":"ç”Ÿé£Ÿç‚¹æ»´","ã›ã„ã—ã‚‡ã":"ç”Ÿé£Ÿç‚¹æ»´","ç”Ÿç†é£Ÿå¡©æ°´":"ç”Ÿé£Ÿç‚¹æ»´",
    "éª¨é«„":"éª¨é«„é‡","ã“ã¤ãšã„":"éª¨é«„é‡","IO":"éª¨é«„é‡","ã‚¢ã‚¤ã‚ªãƒ¼":"éª¨é«„é‡",
    "èƒ¸éª¨":"èƒ¸éª¨åœ§è¿«","ãã‚‡ã†ã“ã¤":"èƒ¸éª¨åœ§è¿«","èƒ¸åœ§":"èƒ¸éª¨åœ§è¿«","CPR":"èƒ¸éª¨åœ§è¿«",
    "å¿ƒãƒ":"å¿ƒè‡“ãƒãƒƒã‚µãƒ¼ã‚¸","ã—ã‚“ã¾":"å¿ƒè‡“ãƒãƒƒã‚µãƒ¼ã‚¸",
    "ã‚¢ãƒ‰ãƒ¬ãƒŠãƒªãƒ³":"ã‚¢ãƒ‰ãƒ¬ãƒŠãƒªãƒ³","ãƒœã‚¹ãƒŸãƒ³":"ã‚¢ãƒ‰ãƒ¬ãƒŠãƒªãƒ³","ã‚¨ãƒ”ãƒãƒ•ãƒªãƒ³":"ã‚¢ãƒ‰ãƒ¬ãƒŠãƒªãƒ³",
    "ãƒŸãƒ€ã‚¾ãƒ©ãƒ ":"ãƒŸãƒ€ã‚¾ãƒ©ãƒ ","ãƒ‰ãƒ«ãƒŸã‚«ãƒ ":"ãƒŸãƒ€ã‚¾ãƒ©ãƒ ",
    "ã‚¸ã‚¢ã‚¼ãƒ‘ãƒ ":"ã‚¸ã‚¢ã‚¼ãƒ‘ãƒ ","ã‚»ãƒ«ã‚·ãƒ³":"ã‚¸ã‚¢ã‚¼ãƒ‘ãƒ ","ãƒ›ãƒªã‚¾ãƒ³":"ã‚¸ã‚¢ã‚¼ãƒ‘ãƒ ",
    "ã‚¤ãƒ¼ã‚±ãƒ—ãƒ©":"ã‚¤ãƒ¼ã‚±ãƒ—ãƒ©","ãƒ¬ãƒ™ãƒãƒ©ã‚»ã‚¿ãƒ ":"ã‚¤ãƒ¼ã‚±ãƒ—ãƒ©",
    "ãƒãƒ«ã‚¢ãƒ‰ãƒ¬ãƒŠãƒªãƒ³":"ãƒãƒ«ã‚¢ãƒ‰ãƒ¬ãƒŠãƒªãƒ³","ãƒãƒ«ã‚¨ãƒ”ãƒãƒ•ãƒªãƒ³":"ãƒãƒ«ã‚¢ãƒ‰ãƒ¬ãƒŠãƒªãƒ³",
    "ãƒ¬ãƒšã‚¿ãƒ³":"ãƒ¬ãƒšã‚¿ãƒ³","ãƒ–ãƒ—ãƒ¬ãƒãƒ«ãƒ•ã‚£ãƒ³":"ãƒ¬ãƒšã‚¿ãƒ³",
    "èƒ¸ç—›":"èƒ¸ç—›","ãã‚‡ã†ã¤ã†":"èƒ¸ç—›","ã‚€ã­ã®ã„ãŸã¿":"èƒ¸ç—›",
    "å‘¼å¸å›°é›£":"å‘¼å¸å›°é›£","ã“ãã‚…ã†ã“ã‚“ãªã‚“":"å‘¼å¸å›°é›£","æ¯è‹¦ã—ã„":"å‘¼å¸å›°é›£",
    "æ„è­˜éšœå®³":"æ„è­˜éšœå®³","ã„ã—ãã—ã‚‡ã†ãŒã„":"æ„è­˜éšœå®³",
    "ã‚·ãƒ§ãƒƒã‚¯":"ã‚·ãƒ§ãƒƒã‚¯","ã—ã‚‡ã£ã":"ã‚·ãƒ§ãƒƒã‚¯",
    "ã‘ã„ã‚Œã‚“":"ã‘ã„ã‚Œã‚“","ç—™æ”£":"ã‘ã„ã‚Œã‚“","ã‘ã„ã‚Œã‚“ç™ºä½œ":"ã‘ã„ã‚Œã‚“",
    "å¤±ç¥":"å¤±ç¥","ã—ã£ã—ã‚“":"å¤±ç¥",
    "å˜”å":"å˜”å","ãŠã†ã¨":"å˜”å","åã„ãŸ":"å˜”å",
    "ä¸‹ç—¢":"ä¸‹ç—¢","ã’ã‚Š":"ä¸‹ç—¢",
    "ç™ºç†±":"ç™ºç†±","ã¯ã¤ã­ã¤":"ç™ºç†±","ç†±":"ç™ºç†±",
    "é ­ç—›":"é ­ç—›","ãšã¤ã†":"é ­ç—›","ã‚ãŸã¾ã®ã„ãŸã¿":"é ­ç—›",
    "è…¹ç—›":"è…¹ç—›","ãµãã¤ã†":"è…¹ç—›","ãŠãªã‹ã®ã„ãŸã¿":"è…¹ç—›",
    "ã‚ã¾ã„":"ã‚ã¾ã„","çœ©æšˆ":"ã‚ã¾ã„",
    "å‹•æ‚¸":"å‹•æ‚¸","ã©ã†ã":"å‹•æ‚¸",
    "é ­éƒ¨":"é ­éƒ¨","ã¨ã†ã¶":"é ­éƒ¨",
    "é ¸éƒ¨":"é ¸éƒ¨","ã‘ã„ã¶":"é ¸éƒ¨","é¦–":"é ¸éƒ¨",
    "èƒ¸éƒ¨":"èƒ¸éƒ¨","ãã‚‡ã†ã¶":"èƒ¸éƒ¨","èƒ¸":"èƒ¸éƒ¨",
    "è…¹éƒ¨":"è…¹éƒ¨","ãµãã¶":"è…¹éƒ¨","ãŠè…¹":"è…¹éƒ¨",
    "èƒŒéƒ¨":"èƒŒéƒ¨","ã¯ã„ã¶":"èƒŒéƒ¨","èƒŒä¸­":"èƒŒéƒ¨",
    "ä¸Šè‚¢":"ä¸Šè‚¢","ã˜ã‚‡ã†ã—":"ä¸Šè‚¢","è…•":"ä¸Šè‚¢",
    "ä¸‹è‚¢":"ä¸‹è‚¢","ã‹ã—":"ä¸‹è‚¢","è¶³":"ä¸‹è‚¢",
    "è¡€ã‚¬ã‚¹":"è¡€ã‚¬ã‚¹","ã‘ã¤ãŒã™":"è¡€ã‚¬ã‚¹",
    "è¡€ç³–":"è¡€ç³–","ã‘ã£ã¨ã†":"è¡€ç³–","BS":"è¡€ç³–","ãƒ“ãƒ¼ã‚¨ã‚¹":"è¡€ç³–",
    "ã‚¨ã‚³ãƒ¼":"ç°¡æ˜“è¶…éŸ³æ³¢æ¤œæŸ»","è¶…éŸ³æ³¢":"ç°¡æ˜“è¶…éŸ³æ³¢æ¤œæŸ»",
    "å¿ƒé›»å›³":"å¿ƒé›»å›³","ã—ã‚“ã§ã‚“ãš":"å¿ƒé›»å›³","ECG":"å¿ƒé›»å›³",
    "å¿ƒç­‹æ¢—å¡":"å¿ƒç­‹æ¢—å¡","ã—ã‚“ãã‚“ã“ã†ãã":"å¿ƒç­‹æ¢—å¡","AMI":"å¿ƒç­‹æ¢—å¡",
    "è„³æ¢—å¡":"è„³æ¢—å¡","ã®ã†ã“ã†ãã":"è„³æ¢—å¡",
    "ãã‚‚è†œä¸‹å‡ºè¡€":"ãã‚‚è†œä¸‹å‡ºè¡€","SAH":"ãã‚‚è†œä¸‹å‡ºè¡€",
    "è‚ºå¡æ “":"è‚ºå¡æ “","ã¯ã„ããã›ã‚“":"è‚ºå¡æ “",
    "å¿ƒä¸å…¨":"å¿ƒä¸å…¨","ã—ã‚“ãµãœã‚“":"å¿ƒä¸å…¨",
    "å–˜æ¯":"å–˜æ¯","ãœã‚“ãã":"å–˜æ¯",
    "ã‚¢ãƒŠãƒ•ã‚£ãƒ©ã‚­ã‚·ãƒ¼":"ã‚¢ãƒŠãƒ•ã‚£ãƒ©ã‚­ã‚·ãƒ¼","ã‚ãªãµãƒã‚‰ãã—ãƒ¼":"ã‚¢ãƒŠãƒ•ã‚£ãƒ©ã‚­ã‚·ãƒ¼",
    "CPA":"CPA","å¿ƒè‚ºåœæ­¢":"CPA","ã—ã‚“ã±ã„ã¦ã„ã—":"CPA",
    "ROSC":"ROSC","è‡ªå·±å¿ƒæ‹å†é–‹":"ROSC",
    "é™¤ç´°å‹•":"é™¤ç´°å‹•","ã˜ã‚‡ã•ã„ã©ã†":"é™¤ç´°å‹•",
    "AED":"AED","ã‚¨ãƒ¼ã‚¤ãƒ¼ãƒ‡ã‚£ãƒ¼":"AED"
  };

  /* ====== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ====== */
  function nowHHMMSS(){ const d=new Date(); return d.toLocaleTimeString('ja-JP',{hour12:false}); }
  function getElapsedMinutes(t1,t2){
    const [h1,m1,s1]=t1.split(':').map(Number); const [h2,m2,s2]=t2.split(':').map(Number);
    return Math.floor(Math.abs((h2*3600+m2*60+s2)-(h1*3600+m1*60+s1))/60);
  }
  function formatElapsed(m){ if(m<1)return'é–‹å§‹ç›´å¾Œ'; const h=Math.floor(m/60),mins=m%60; return h>0?`${h}æ™‚é–“${mins}åˆ†`:`${mins}åˆ†`; }

  /* ====== æ°¸ç¶šåŒ– ====== */
  function save(){ localStorage.setItem(STORE_KEY, JSON.stringify({logs,startTime})); }
  function load(){ try{ const d=JSON.parse(localStorage.getItem(STORE_KEY)); if(d){ logs=d.logs||[]; startTime=d.startTime||null; } }catch{ logs=[]; startTime=null; } }

  /* ====== ãƒã‚¤ã‚¿ãƒ«è‡ªå‹•æ•´å½¢ ====== */
  function formatVitalSigns(text) {
    let formatted = text;
    formatted = formatted.replace(/(?:è„ˆæ‹|å¿ƒæ‹|è„ˆ|HR|ã‚¨ã‚¤ãƒã‚¢ãƒ¼ãƒ«)\s*(\d+)/gi, 'HR $1å›/åˆ†');
    formatted = formatted.replace(/(?:è¡€åœ§|BP|ãƒ“ãƒ¼ãƒ”ãƒ¼)\s*(\d+)\s*(?:ã®|\/)\s*(\d+)/gi, 'NIBP $1/$2 mmHg');
    formatted = formatted.replace(/(?:è¡€åœ§|BP|ãƒ“ãƒ¼ãƒ”ãƒ¼)\s*(\d+)(?!\d)/gi, 'NIBP $1/ mmHg');
    formatted = formatted.replace(/(?:ã‚µãƒãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³|ã‚µãƒãƒ¥|SpO2|ã‚¨ã‚¹ãƒ”ãƒ¼ã‚ªãƒ¼ãƒ„ãƒ¼|é…¸ç´ é£½å’Œåº¦)\s*(\d+)/gi, 'SpO2 $1%');
    formatted = formatted.replace(/(?:å‘¼å¸æ•°|å‘¼å¸|RR|ã‚¢ãƒ¼ãƒ«ã‚¢ãƒ¼ãƒ«)\s*(\d+)/gi, 'RR $1å›/åˆ†');
    formatted = formatted.replace(/(?:ä½“æ¸©|BT|ãƒ“ãƒ¼ãƒ†ã‚£ãƒ¼)\s*(\d+\.?\d*)/gi, 'BT $1â„ƒ');
    formatted = formatted.replace(/(?:JCS|ã‚¸ã‚§ãƒ¼ã‚·ãƒ¼ã‚¨ã‚¹)\s*([1-3])(?!\d)/gi, (_m,num)=>`JCS I-${num}`);
    formatted = formatted.replace(/(?:JCS|ã‚¸ã‚§ãƒ¼ã‚·ãƒ¼ã‚¨ã‚¹)\s*([1-3]0)\b/gi, (_m,num)=>`JCS II-${num}`);
    formatted = formatted.replace(/(?:JCS|ã‚¸ã‚§ãƒ¼ã‚·ãƒ¼ã‚¨ã‚¹)\s*([1-3]00)\b/gi, (_m,num)=>`JCS III-${num}`);
    formatted = formatted.replace(/(?:JCS|ã‚¸ã‚§ãƒ¼ã‚·ãƒ¼ã‚¨ã‚¹)\s*(?:ã˜ã‚…ã†|ã‚¸ãƒ¥ã‚¦|å)/gi, 'JCS II-10');
    formatted = formatted.replace(/(?:JCS|ã‚¸ã‚§ãƒ¼ã‚·ãƒ¼ã‚¨ã‚¹)\s*(?:ã«ã˜ã‚…ã†|ãƒ‹ã‚¸ãƒ¥ã‚¦|äºŒå)/gi, 'JCS II-20');
    formatted = formatted.replace(/(?:JCS|ã‚¸ã‚§ãƒ¼ã‚·ãƒ¼ã‚¨ã‚¹)\s*(?:ã•ã‚“ã˜ã‚…ã†|ã‚µãƒ³ã‚¸ãƒ¥ã‚¦|ä¸‰å)/gi, 'JCS II-30');
    formatted = formatted.replace(/(?:JCS|ã‚¸ã‚§ãƒ¼ã‚·ãƒ¼ã‚¨ã‚¹)\s*(?:ã²ã‚ƒã|ãƒ’ãƒ£ã‚¯|ç™¾)/gi, 'JCS III-100');
    formatted = formatted.replace(/(?:JCS|ã‚¸ã‚§ãƒ¼ã‚·ãƒ¼ã‚¨ã‚¹)\s*(?:ã«ã²ã‚ƒã|ãƒ‹ãƒ’ãƒ£ã‚¯|äºŒç™¾)/gi, 'JCS III-200');
    formatted = formatted.replace(/(?:JCS|ã‚¸ã‚§ãƒ¼ã‚·ãƒ¼ã‚¨ã‚¹)\s*(?:ã•ã‚“ã³ã‚ƒã|ã‚µãƒ³ãƒ“ãƒ£ã‚¯|ä¸‰ç™¾)/gi, 'JCS III-300');
    formatted = formatted.replace(/(?:GCS|ã‚¸ãƒ¼ã‚·ãƒ¼ã‚¨ã‚¹)\s*([3-9]|1[0-5])\b/gi, 'GCS $1ç‚¹');
    formatted = formatted.replace(/(?:GCS|ã‚¸ãƒ¼ã‚·ãƒ¼ã‚¨ã‚¹)\s*E\s*([1-4])\s*V\s*([1-5])\s*M\s*([1-6])/gi,
      (_m,e,v,m)=>`GCS E${e}V${v}M${m} (${(+e)+(+v)+(+m)}ç‚¹)`);
    formatted = formatted.replace(/ç³å­”(?:å¾„)?\s*(\d+\.?\d*)\s*(?:ãƒŸãƒª|mm)?/gi, 'ç³å­”å¾„ $1mm');
    formatted = formatted.replace(/å¯¾å…‰åå°„\s*(?:ã‚ã‚Š|é™½æ€§|\+|ãƒ—ãƒ©ã‚¹)/gi, 'å¯¾å…‰åå°„ +');
    formatted = formatted.replace(/å¯¾å…‰åå°„\s*(?:ãªã—|é™°æ€§|\-|ãƒã‚¤ãƒŠã‚¹)/gi, 'å¯¾å…‰åå°„ -');
    formatted = formatted.replace(/(?:è¡€ç³–å€¤?|BS|ãƒ“ãƒ¼ã‚¨ã‚¹)\s*(\d+)/gi, 'è¡€ç³– $1mg/dL');
    formatted = formatted.replace(/é…¸ç´ (?:æŠ•ä¸)?\s*(\d+\.?\d*)\s*(?:ãƒªãƒƒãƒˆãƒ«|L|ãƒªãƒƒã‚¿ãƒ¼)/gi, 'O2 $1L/åˆ†');
    return formatted;
  }

  /* ====== æ­£è¦åŒ– ====== */
  function normalize(t){
    let n=t;
    Object.entries(TERM_NORM).forEach(([v,s])=>{
      const escaped=v.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
      const regex=new RegExp(`\\b${escaped}\\b`, 'gi');
      n=n.replace(regex,s);
    });
    n = formatVitalSigns(n);
    n = n.replace(/(\d+)ã®(\d+)/g,'$1/$2');
    n = n.replace(/(\d+)æ™‚(\d+)åˆ†/g,'$1:$2');
    n = n.replace(/(\d+)\s*ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆ/g,'$1%');
    n = n.replace(/(\d+)\s*(?:ãƒŸãƒªã‚°ãƒ©ãƒ |mg)/g,'$1mg');
    return n;
  }

  /* ====== GPS + é€†ã‚¸ã‚ªï¼ˆç°¡æ˜“ä½æ‰€è¡¨ç¤ºã«æ”¹è‰¯ï¼‰ ====== */
  async function getPosition(opts){
    return new Promise((resolve,reject)=>{
      if(!navigator.geolocation){ reject(new Error('geolocation unsupported')); return; }
      navigator.geolocation.getCurrentPosition(resolve,reject,opts);
    });
  }

  async function reverseGeocode(lat,lon,timeoutMs=6000){
    const ctrl = new AbortController();
    const timer = setTimeout(()=>ctrl.abort(), timeoutMs);
    try{
      const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}&zoom=18&addressdetails=1&accept-language=ja`;
      const res = await fetch(url, {
        headers: {
          'Accept': 'application/json',
          'User-Agent': 'EmergencyDoc/1.0 (iOS Safari)'
        },
        signal: ctrl.signal
      });
      const data = await res.json();
      
      // å¸‚åŒºç”ºæ‘ + ç”ºåãƒ¬ãƒ™ãƒ«ã®ç°¡æ˜“è¡¨ç¤ºã«å¤‰æ›
      if(data && data.address){
        const addr = data.address;
        let result = '';
        
        // å¸‚åŒºç”ºæ‘ã‚’å–å¾—
        if(addr.city) {
          result = addr.city;
        } else if(addr.town) {
          result = addr.town;
        } else if(addr.county) {
          result = addr.county;
        } else if(addr.state) {
          result = addr.state;
        }
        
        // ç”ºåãƒ»åœ°åŒºã‚’è¿½åŠ 
        if(addr.suburb) {
          result += addr.suburb;
        } else if(addr.neighbourhood) {
          result += addr.neighbourhood;
        } else if(addr.quarter) {
          result += addr.quarter;
        } else if(addr.hamlet) {
          result += addr.hamlet;
        }
        
        return result || `${lat.toFixed(5)},${lon.toFixed(5)}`;
      }
      
      return `${lat.toFixed(5)},${lon.toFixed(5)}`;
    }catch(e){
      return '';
    }finally{
      clearTimeout(timer);
    }
  }

  async function fetchAddressFromGPS(){
    try{
      const hi = document.getElementById('gpsHi').checked;
      const to = Math.max(2, Math.min(20, +document.getElementById('gpsTimeout').value || 6));
      const pos = await getPosition({ enableHighAccuracy: hi, timeout: to*1000, maximumAge: 10000 });
      const { latitude, longitude, accuracy } = pos.coords;
      const addr = await reverseGeocode(latitude, longitude, to*1000);
      return addr;
    }catch(e){
      return '';
    }
  }

  /* ====== ãƒ­ã‚° ====== */
  function addLine(text, address=''){
    const minLen = +document.getElementById('minLen').value || 2;
    const t = text.trim();
    if(!t || t.length<minLen) return;
    if(logs.length===0) startTime = nowHHMMSS();
    logs.push({ id:'L'+Date.now(), time:nowHHMMSS(), text:t, address:address||'', tags:[] });
    save(); render(); updateStats();
  }

  /* ====== UIæç”» ====== */
  function render(){
    const list=document.getElementById('log'); list.innerHTML='';
    if(!logs.length){
      const li=document.createElement('li'); li.className='empty-state'; li.textContent='ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“'; list.appendChild(li); return;
    }
    const reversed=[...logs].reverse();
    reversed.forEach(row=>{
      const li=document.createElement('li'); li.className='row'; li.dataset.id=row.id; if(row.id===selectedId) li.classList.add('selected');

      const time=document.createElement('div'); time.className='time'; time.innerHTML=`ğŸ• ${row.time}`;
      // çµŒé
      if(logs[0].time && row.time !== logs[0].time){
        const el = getElapsedMinutes(logs[0].time, row.time);
        const span = document.createElement('span'); span.className='elapsed'; span.textContent = formatElapsed(el);
        time.appendChild(span);
      }

      // ä½æ‰€è¡¨ç¤ºãƒ«ãƒ¼ãƒ«ï¼ˆç›´å‰ãƒ­ã‚°ã¨åŒä¸€ãªã‚‰éè¡¨ç¤º/æ·¡è‰²ï¼‰
      const addrDiv = document.createElement('div'); addrDiv.className='addr';
      const thisIdx = logs.findIndex(x=>x.id===row.id);
      const prevAddr = (thisIdx>0 && logs[thisIdx-1].address) ? logs[thisIdx-1].address : '';
      const showAddr = row.address && row.address !== prevAddr;
      if(row.address){
        addrDiv.textContent = `ğŸ“ ${row.address}`;
        if(!showAddr) addrDiv.classList.add('muted');
      }

      const text=document.createElement('div'); text.className='text'; text.textContent=row.text;

      const tags=document.createElement('div'); tags.className='tags';
      (row.tags||[]).forEach(tag=>{ const span=document.createElement('span'); span.className='tag'; span.textContent=tag; tags.appendChild(span); });

      const tools=document.createElement('div'); tools.className='tools';
      const btnSel=document.createElement('button'); btnSel.type='button'; btnSel.className='btn'; btnSel.textContent = selectedId===row.id?'è§£é™¤':'é¸æŠ';
      btnSel.onclick=()=>{ selectedId = (selectedId===row.id ? null : row.id); render(); };
      const btnDel=document.createElement('button'); btnDel.type='button'; btnDel.className='btn danger'; btnDel.textContent='å‰Šé™¤';
      btnDel.onclick=()=>{ if(confirm('å‰Šé™¤ã—ã¾ã™ã‹?')){ logs = logs.filter(x=>x.id!==row.id); if(selectedId===row.id) selectedId=null; save(); render(); updateStats(); } };
      tools.append(btnSel,btnDel);

      li.append(time);
      if(row.address){ li.append(addrDiv); }
      li.append(text,tags,tools);
      list.appendChild(li);
    });
    list.scrollTop=0;
  }

  function updateStats(){
    document.getElementById('totalLogs').textContent = logs.length;
    if(logs.length>=2){
      const el=getElapsedMinutes(logs[0].time, logs[logs.length-1].time);
      document.getElementById('totalTime').textContent = `${el}åˆ†`;
    }else{
      document.getElementById('totalTime').textContent = '0åˆ†';
    }
  }

  function renderTagButtons(){
    const box=document.getElementById('tagButtons'); box.innerHTML='';
    const cats={
      'ğŸš‘ æ•‘æ€¥':["æ•‘æ€¥è¦šçŸ¥","æ•‘æ€¥æŒ‡ä»¤","æ•‘æ€¥å‡ºå‹•","æ•‘æ€¥ç¾ç€","æ•‘æ€¥æ¥è§¦","è»Šå†…åå®¹","ç¾ç™º","ç—…ç€"],
      'ğŸš ãƒ˜ãƒª':["ãƒ˜ãƒªè¦šçŸ¥","ãƒ˜ãƒªæŒ‡ä»¤","ãƒ˜ãƒªå‡ºå‹•","ãƒ˜ãƒªç¾ç€","ãƒ•ãƒ©ã‚¤ãƒˆãƒ‰ã‚¯ã‚¿ãƒ¼æ¥è§¦","ãƒ©ãƒ³ãƒ‡ãƒ–ãƒ¼ãƒã‚¤ãƒ³ãƒˆç€"],
      'ğŸš™ ã‚«ãƒ¼':["ã‚«ãƒ¼è¦šçŸ¥","ã‚«ãƒ¼æŒ‡ä»¤","ã‚«ãƒ¼å‡ºå‹•","ã‚«ãƒ¼ç¾ç€","ã‚«ãƒ¼æ¥è§¦","ãƒ‰ãƒƒã‚­ãƒ³ã‚°","åŒ»å¸«æ¥è§¦"],
      'ğŸ“‹ æƒ…å ±':["ç¾ç—…æ­´","æ—¢å¾€ç—‡","ã‹ã‹ã‚Šã¤ã‘æƒ…å ±"],
      'ğŸ« å‘¼å¸':["æ°—ç®¡æŒ¿ç®¡","äººå·¥å‘¼å¸","ãƒãƒƒã‚¯ãƒãƒ«ãƒ–ãƒã‚¹ã‚¯æ›æ°—","é…¸ç´ æŠ•ä¸","é…¸ç´ æŠ•ä¸é‡","NPPV"],
      'ğŸ’‰ å¾ªç’°':["ãƒ«ãƒ¼ãƒˆç¢ºä¿","ç”Ÿé£Ÿç‚¹æ»´","ã‚½ãƒ«ã‚¢ã‚»ãƒˆFç‚¹æ»´","å¤§è…¿å‹•è„ˆ","å¤§è…¿é™è„ˆ","éª¨é«„é‡"],
      'ğŸ”¬ æ¤œæŸ»':["è¡€ã‚¬ã‚¹","è¡€ç³–","ç°¡æ˜“è¶…éŸ³æ³¢æ¤œæŸ»"],
      'â¤ï¸ è˜‡ç”Ÿ':["èƒ¸éª¨åœ§è¿«","é–‹èƒ¸","å¿ƒè‡“ãƒãƒƒã‚µãƒ¼ã‚¸"],
      'ğŸ’Š è–¬å‰¤':["ã‚¢ãƒ‰ãƒ¬ãƒŠãƒªãƒ³","ãƒŸãƒ€ã‚¾ãƒ©ãƒ ","ã‚¸ã‚¢ã‚¼ãƒ‘ãƒ ","ã‚¤ãƒ¼ã‚±ãƒ—ãƒ©","ãƒãƒ«ã‚¢ãƒ‰ãƒ¬ãƒŠãƒªãƒ³","ãƒ¬ãƒšã‚¿ãƒ³"]
    };
    Object.entries(cats).forEach(([cat,tags])=>{
      const h=document.createElement('div');
      h.style.cssText='width:100%; font-weight:700; font-size:10px; color:#2c3e50; margin:6px 0 3px 0; padding:3px 6px; border-left:3px solid #3498db; background:#ecf0f1;';
      h.textContent=cat; box.appendChild(h);
      tags.forEach(tag=>{
        const b=document.createElement('button'); b.type='button'; b.className='btn'; b.textContent=tag;
        b.onclick=async ()=>{
        // ğŸ¯ ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’æŠ¼ã—ãŸç¬é–“ã«å³ãƒ­ã‚°è¿½åŠ 
        const addr = await fetchAddressFromGPS();
        addLine(tag, addr);
      };
      box.appendChild(b);
      });
    });
  }

  function showSuggestions(txt){
    const sug=document.getElementById('suggestions'); const items=document.getElementById('suggestionItems');
    const matches=new Set();
    TAGS.forEach(tag=>{ if(!txt.includes(tag)&&tag.length>=2&&txt.includes(tag.substring(0,1))) matches.add(tag); });
    const arr=Array.from(matches);
    if(arr.length>0){
      sug.style.display='block'; items.innerHTML='';
      arr.slice(0,10).forEach(term=>{
        const span=document.createElement('span'); span.className='suggestion-item'; span.textContent=term;
        span.onclick=()=>{ const input=document.getElementById('input'); input.value+=term+' '; input.focus(); sug.style.display='none'; };
        items.appendChild(span);
      });
    }else{ sug.style.display='none'; }
  }

  /* ====== å…¥åŠ›ç›£è¦– ====== */
  class BeatLog{
    constructor(el){ this.el=el; this._idle=null; this._punctRe=/[ã€‚.ã€‚!?!?]\s*$/; this._onInput=this._onInput.bind(this); this._onBlur=this._onBlur.bind(this); }
    start(){ this.el.addEventListener('input',this._onInput); this.el.addEventListener('blur',this._onBlur); }
    _onInput(){
      const raw=this.el.value; showSuggestions(raw);
      if(document.getElementById('punct').checked && (this._punctRe.test(raw)||raw.endsWith('\n'))){ this.commitNow(); return; }
      clearTimeout(this._idle);
      const sec=parseFloat(document.getElementById('idleSec').value)||1.2; const ms=Math.max(300,sec*1000);
      this._idle=setTimeout(()=>{ if(this.el.value.trim()) this.commitNow(); }, ms);
    }
    _onBlur(){ if(this.el.value.trim()) this.commitNow(); clearTimeout(this._idle); }
    commitNow(){
      const raw=this.el.value.replace(/\s+/g,' ').trim(); if(!raw) return;
      this.el.value=''; clearTimeout(this._idle); document.getElementById('suggestions').style.display='none';
      addLine(normalize(raw), '');
    }
  }

  /* ====== éŸ³å£°èªè­˜ï¼ˆãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ç¶™ç¶šå¯¾å¿œï¼‰ ====== */
  class VoiceRec{
    constructor(){
      this.rec=null; this.isRec=false; this.interim='';
      this.wakeLock=null; this.restartTimer=null; this.lastSoundTime=Date.now();
      try{
        if('webkitSpeechRecognition' in window) this.rec=new webkitSpeechRecognition();
        else if('SpeechRecognition' in window) this.rec=new SpeechRecognition();
      }catch(e){ this.rec=null; }
      if(this.rec) this.setup();
      this.setupVisibilityHandler();
      this.setupWakeLock();
    }
    
    async setupWakeLock(){
      if('wakeLock' in navigator){
        try{
          document.addEventListener('visibilitychange', async ()=>{
            if(this.isRec && document.visibilityState === 'visible' && !this.wakeLock){
              await this.requestWakeLock();
            }
          });
        }catch(e){ console.log('Wake Lockæœªå¯¾å¿œ'); }
      }
    }
    
    async requestWakeLock(){
      if('wakeLock' in navigator && this.isRec){
        try{
          this.wakeLock = await navigator.wakeLock.request('screen');
          console.log('Wake Lockæœ‰åŠ¹åŒ–');
          this.wakeLock.addEventListener('release', ()=>{ console.log('Wake Lockè§£æ”¾'); this.wakeLock=null; });
        }catch(e){ console.log('Wake Lockå–å¾—å¤±æ•—:', e); }
      }
    }
    
    async releaseWakeLock(){
      if(this.wakeLock){
        try{ await this.wakeLock.release(); this.wakeLock=null; }catch{}
      }
    }
    
    setupVisibilityHandler(){
      document.addEventListener('visibilitychange', ()=>{
        if(this.isRec){
          if(document.hidden){
            console.log('ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ç§»è¡Œ - éŒ²éŸ³ç¶™ç¶š');
            this.ensureRecording();
          }else{
            console.log('ãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å¾©å¸°');
            this.ensureRecording();
          }
        }
      });
    }
    
    ensureRecording(){
      if(!this.isRec) return;
      clearTimeout(this.restartTimer);
      this.restartTimer = setTimeout(()=>{
        if(this.isRec){
          const timeSinceLastSound = Date.now() - this.lastSoundTime;
          if(timeSinceLastSound > 15000){
            console.log('é•·æ™‚é–“ç„¡éŸ³ - èªè­˜ã‚’å†èµ·å‹•');
            this.forceRestart();
          }else{
            this.ensureRecording();
          }
        }
      }, 10000);
    }
    
    forceRestart(){
      if(!this.rec || !this.isRec) return;
      console.log('éŸ³å£°èªè­˜ã‚’å¼·åˆ¶å†èµ·å‹•');
      try{ this.rec.stop(); }catch{}
      setTimeout(()=>{
        if(this.isRec){
          try{ this.rec.start(); this.lastSoundTime=Date.now(); }catch(e){ console.error('å†èµ·å‹•å¤±æ•—:', e); }
        }
      }, 100);
    }
    
    setup(){
      try{ this.rec.lang='ja-JP'; this.rec.continuous=true; this.rec.interimResults=true; this.rec.maxAlternatives=5; }catch(e){}
      this.rec.onresult=async (e)=>{
        this.lastSoundTime = Date.now();
        let interim='', final='';
        for(let i=e.resultIndex;i<e.results.length;i++){
          const t=e.results[i][0].transcript;
          if(e.results[i].isFinal) final+=t; else interim+=t;
        }
        if(interim){ this.interim=interim; document.getElementById('voiceInterim').textContent=`èªè­˜ä¸­: ${interim}`; }
        if(final){
          const norm = normalize(final);
          document.getElementById('voiceStatusText').textContent = 'ğŸ“¡ ä½ç½®æƒ…å ±å–å¾—ä¸­...';
          const addr = await fetchAddressFromGPS();
          addLine(norm, addr);
          this.interim=''; document.getElementById('voiceInterim').textContent='';
          document.getElementById('voiceStatusText').textContent='å¾…æ©Ÿä¸­...';
          if(final!==norm){ console.log(`éŸ³å£°èªè­˜è£œæ­£: "${final}" â†’ "${norm}"`); }
        }
      };
      this.rec.onstart=()=>{ 
        this.isRec=true; 
        this.lastSoundTime=Date.now();
        this.updateUI(); 
        this.ensureRecording();
        console.log('éŸ³å£°èªè­˜é–‹å§‹');
      };
      this.rec.onend=()=>{ 
        console.log('éŸ³å£°èªè­˜çµ‚äº†ã‚¤ãƒ™ãƒ³ãƒˆ');
        if(this.isRec){ 
          console.log('éŒ²éŸ³ç¶™ç¶šã®ãŸã‚è‡ªå‹•å†èµ·å‹•');
          setTimeout(()=>{
            if(this.isRec){
              try{ this.rec.start(); }catch(e){ 
                console.error('å†èµ·å‹•å¤±æ•—:', e);
                setTimeout(()=>{ if(this.isRec){ try{ this.rec.start(); }catch{} } }, 1000);
              }
            }
          }, 100);
        } else { 
          this.updateUI(); 
          clearTimeout(this.restartTimer);
        }
      };
      this.rec.onerror=(e)=>{
        console.error('éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼:', e.error);
        const st=document.getElementById('voiceStatusText');
        if(e.error==='no-speech'){ 
          this.lastSoundTime=Date.now();
          return;
        }
        if(e.error==='audio-capture'){ st.textContent='âŒ ãƒã‚¤ã‚¯ãªã—'; this.stop(); }
        else if(e.error==='not-allowed'){ st.textContent='âŒ è¨±å¯ãªã—'; this.stop(); }
        else if(e.error==='network'){ 
          st.textContent='âš ï¸ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼'; 
          setTimeout(()=>{ if(this.isRec) this.forceRestart(); }, 2000);
        }
        else if(e.error==='aborted'){
          if(this.isRec){
            setTimeout(()=>{ if(this.isRec) this.forceRestart(); }, 500);
          }
        }
      };
      this.rec.onsoundstart=()=>{ 
        this.lastSoundTime=Date.now();
        document.getElementById('voiceStatusText').textContent='ğŸ¤ éŸ³å£°æ¤œå‡ºä¸­...'; 
      };
      this.rec.onsoundend = ()=>{ 
        this.lastSoundTime=Date.now();
        if(this.isRec && !this.interim){ document.getElementById('voiceStatusText').textContent='å¾…æ©Ÿä¸­...'; } 
      };
      this.rec.onspeechstart=()=>{ 
        this.lastSoundTime=Date.now();
        document.getElementById('voiceStatusText').textContent='ğŸ—£ï¸ èªè­˜ä¸­...'; 
      };
      this.rec.onspeechend =()=>{ 
        this.lastSoundTime=Date.now();
        if(this.isRec){ document.getElementById('voiceStatusText').textContent='å¾…æ©Ÿä¸­...'; } 
      };
    }
    async start(){
      if(!this.rec){ alert('éŸ³å£°èªè­˜æœªå¯¾å¿œ'); return; }
      if(this.isRec) return;
      try{
        this.isRec=true; 
        this.lastSoundTime=Date.now();
        this.rec.start();
        await this.requestWakeLock();
        document.getElementById('voiceStatusText').textContent='ğŸ¤ è©±ã—ã¦ãã ã•ã„';
        this.updateUI();
        console.log('éŒ²éŸ³é–‹å§‹ - ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ã‚‚ç¶™ç¶š');
      }catch(e){ 
        this.isRec=false; 
        console.error('é–‹å§‹å¤±æ•—:', e);
        alert('é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ'); 
      }
    }
    stop(){
      if(!this.rec || !this.isRec) return;
      this.isRec=false; 
      clearTimeout(this.restartTimer);
      this.releaseWakeLock();
      try{ this.rec.stop(); }catch{}
      this.interim=''; 
      document.getElementById('voiceInterim').textContent=''; 
      document.getElementById('voiceStatusText').textContent='ã‚¿ãƒƒãƒ—ã§é–‹å§‹';
      this.updateUI();
      console.log('éŒ²éŸ³åœæ­¢');
    }
    toggle(){ if(this.isRec) this.stop(); else this.start(); }
    updateUI(){
      const btn=document.getElementById('voiceBtn'); 
      const title=document.getElementById('voiceStatusTitle');
      if(this.isRec){ 
        btn.classList.add('active'); 
        title.textContent='ğŸ”´ éŒ²éŸ³ä¸­'; 
      } else { 
        btn.classList.remove('active'); 
        title.textContent='åœæ­¢ä¸­'; 
      }
    }
  }

  /* ====== ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½ ====== */
  document.getElementById('btnCopy').onclick=async()=>{
    if(!logs.length){ alert('ã‚³ãƒ”ãƒ¼ã™ã‚‹ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
    const txt=logs.map(e=>`${e.time} ${e.text}${e.tags.length?' ['+e.tags.join(',')+']':''}`).join('\n');
    try{ await navigator.clipboard.writeText(txt); alert('âœ… ã‚³ãƒ”ãƒ¼å®Œäº†'); }catch{ alert('âŒ ã‚³ãƒ”ãƒ¼å¤±æ•—'); }
  };
  document.getElementById('btnCopyAddr').onclick=async()=>{
    if(!logs.length){ alert('ã‚³ãƒ”ãƒ¼ã™ã‚‹ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
    const txt=logs.map((e,i)=>{
      const prev = i>0 ? logs[i-1] : null;
      const showAddr = e.address && (!prev || e.address !== prev.address);
      return `${e.time}${showAddr?` [${e.address}]`:''} ${e.text}${e.tags.length?' ['+e.tags.join(',')+']':''}`;
    }).join('\n');
    try{ await navigator.clipboard.writeText(txt); alert('âœ… ã‚³ãƒ”ãƒ¼å®Œäº†'); }catch{ alert('âŒ ã‚³ãƒ”ãƒ¼å¤±æ•—'); }
  };

  /* ====== å…¨æ¶ˆå» ====== */
  document.getElementById('btnClear').onclick=()=>{
    if(!logs.length){ alert('æ¶ˆå»ã™ã‚‹ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
    if(confirm('âš ï¸ å…¨å‰Šé™¤ã—ã¾ã™ã‹?')){ logs=[]; selectedId=null; startTime=null; save(); render(); updateStats(); }
  };

  /* ====== è£œåŠ© ====== */
  function showSuggestionsHook(v){ showSuggestions(v); }
  function updateClock(){ document.getElementById('clock').textContent = nowHHMMSS(); }

  /* ====== åˆæœŸåŒ– ====== */
  function init(){
    load(); render(); updateStats(); renderTagButtons();
    const sel=document.getElementById('idleSec');
    for(let i=0.5;i<=10;i+=0.5){ const opt=document.createElement('option'); opt.value=i.toFixed(1); opt.textContent=`${i.toFixed(1)}ç§’`; if(Math.abs(i-1.2)<0.01) opt.selected=true; sel.appendChild(opt); }
    new BeatLog(document.getElementById('input')).start();
    const voice=new VoiceRec(); document.getElementById('voiceBtn').onclick=()=>voice.toggle();
    updateClock(); setInterval(updateClock,1000);
    console.log('ğŸš‘ èµ·å‹•å®Œäº†');
  }
  init();
</script>
</body>
</html>
