<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
<title>æ•‘æ€¥è¨˜éŒ² - AI Ultimate v2.8.1 (iPhoneæœ€é©åŒ–ç‰ˆ)</title>
<style>
  /* v2.8.1: iPhoneæœ€é©åŒ–å¼·åŒ– */
  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: rgba(0,0,0,0); }
  
  /* ğŸ“Œ iPhone Safe Areaå¯¾å¿œ */
  :root {
    --safe-top: env(safe-area-inset-top, 0px);
    --safe-bottom: env(safe-area-inset-bottom, 0px);
    --safe-left: env(safe-area-inset-left, 0px);
    --safe-right: env(safe-area-inset-right, 0px);
  }
  
  html {
    /* ã‚ªãƒ¼ãƒãƒ¼ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã®ãƒã‚¦ãƒ³ã‚¹ç„¡åŠ¹åŒ– */
    overscroll-behavior: none;
  }
  
  body {
    background: #f8f9fa; min-height: 100vh; min-height: -webkit-fill-available; color: #212529;
    font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Yu Gothic','Hiragino Sans',sans-serif;
    line-height: 1.4; font-size: 15px; -webkit-text-size-adjust: 100%; touch-action: manipulation; 
    overflow-x: hidden;
    /* Safe Areaå¯¾å¿œ */
    padding-left: var(--safe-left);
    padding-right: var(--safe-right);
    padding-bottom: var(--safe-bottom);
  }
  
  header {
    background: #fff; border-bottom: 2px solid #e74c3c; 
    padding: 8px 12px;
    padding-top: calc(8px + var(--safe-top)); /* ãƒãƒƒãƒ/Dynamic Islandå¯¾å¿œ */
    box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    position: sticky; top: 0; z-index: 100;
  }
  .header-content { display: flex; justify-content: space-between; align-items: center; }
  h1 { font-size: 14px; font-weight: 700; color: #e74c3c; }
  .version { font-size: 9px; color: #9b59b6; margin-left: 6px; }
  .clock { font-size: 18px; font-weight: 700; color: #2c3e50; font-variant-numeric: tabular-nums; }
  .wrap { padding: 10px; }
  .grid { display: flex; flex-direction: column; gap: 8px; }
  .card { background: #fff; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.08); }
  .card h2 { padding: 10px 12px; border-bottom: 2px solid #3498db; font-size: 14px; font-weight: 700; color: #2c3e50; background: #ecf0f1; }
  .card .body { padding: 12px; }
  
  /* ğŸ“Œ å°å‹éŒ²éŸ³ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ (å³ä¸Šå›ºå®š) */
  .recording-indicator {
    display: none; position: fixed; top: 60px; right: 10px; 
    background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
    color: #fff; padding: 8px 12px; border-radius: 20px; z-index: 99;
    box-shadow: 0 2px 8px rgba(39, 174, 96, 0.4);
    animation: indicator-pulse 2s infinite;
    font-size: 11px; font-weight: 700;
    pointer-events: none;
  }
  .recording-indicator.show { display: flex; align-items: center; gap: 6px; }
  .recording-indicator .icon { font-size: 16px; animation: blink 1s infinite; }
  .recording-indicator .time { font-variant-numeric: tabular-nums; }
  @keyframes indicator-pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.9; } }
  @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
  
  /* ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ */
  .system-status {
    font-size: 9px; padding: 4px 8px; background: #e8f4f8; border-radius: 4px;
    color: #2c3e50; margin-top: 4px; border-left: 2px solid #3498db;
  }
  .system-status.warning { background: #fff3cd; border-left-color: #f39c12; color: #856404; }
  .system-status.error { background: #f8d7da; border-left-color: #e74c3c; color: #721c24; }
  .system-status.success { background: #d4edda; border-left-color: #27ae60; color: #155724; }
  
  /* æ¨©é™ã‚¢ãƒ©ãƒ¼ãƒˆ */
  .permission-alert {
    display: none; background: #fff3cd; border: 2px solid #f39c12; border-radius: 8px;
    padding: 12px; margin-bottom: 8px;
  }
  .permission-alert.show { display: block; }
  .permission-alert-title { font-size: 13px; font-weight: 700; color: #856404; margin-bottom: 6px; }
  .permission-alert-text { font-size: 11px; color: #856404; line-height: 1.5; margin-bottom: 8px; }
  .permission-alert-buttons { display: flex; gap: 6px; }
  
  /* ğŸ“Œ ã‚±ãƒ¼ã‚¹ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
  .case-section {
    background: #e8f4f8; border: 2px solid #3498db; border-radius: 8px; padding: 12px; margin-bottom: 10px;
  }
  .case-header {
    display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;
  }
  .case-title {
    font-size: 14px; font-weight: 700; color: #2c3e50;
  }
  .case-controls {
    display: flex; gap: 6px;
  }
  .case-info {
    font-size: 12px; color: #7f8c8d; margin-bottom: 8px; padding: 10px;
    background: #fff; border-radius: 6px; border-left: 3px solid #3498db;
  }
  .case-list {
    max-height: 140px; overflow-y: auto; background: #fff; border-radius: 6px; padding: 6px;
    margin-top: 8px; -webkit-overflow-scrolling: touch;
    overscroll-behavior: contain;
  }
  .case-item {
    padding: 12px 10px; margin: 4px 0; border-radius: 6px; background: #f8f9fa;
    border-left: 3px solid #3498db; font-size: 12px; cursor: pointer;
    display: flex; justify-content: space-between; align-items: center;
    min-height: 48px;
  }
  .case-item.active { background: #d4edda; border-left-color: #27ae60; font-weight: 600; }
  .case-item:active { background: #ecf0f1; }
  .case-item .name { flex: 1; }
  .case-item .count { color: #7f8c8d; font-size: 11px; }
  .case-item .delete { color: #e74c3c; font-weight: 700; padding: 0 10px; font-size: 16px; }
  
  /* ğŸ“Œ AIå‡¦ç†åˆ¶å¾¡ */
  .ai-control-section {
    background: #f3e5f5; border: 2px solid #9b59b6; border-radius: 8px; padding: 12px; margin-bottom: 10px;
  }
  .ai-control-title {
    font-size: 13px; font-weight: 700; color: #6a1b9a; margin-bottom: 8px;
    display: flex; align-items: center; gap: 6px;
  }
  .ai-queue-info {
    font-size: 11px; color: #6a1b9a; padding: 8px 10px; background: #fff; border-radius: 6px;
    margin-bottom: 8px; border-left: 3px solid #9b59b6;
  }
  
  /* ğŸ“Œ NEW v2.8.0: é‡è¦ãƒ­ã‚°æŠ½å‡ºã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
  .critical-section {
    background: linear-gradient(135deg, #fff5f5 0%, #ffe8e8 100%);
    border: 2px solid #e74c3c; border-radius: 8px; padding: 12px; margin-bottom: 10px;
  }
  .critical-title {
    font-size: 14px; font-weight: 700; color: #c0392b; margin-bottom: 10px;
    display: flex; align-items: center; gap: 8px;
  }
  .critical-title .badge {
    background: #e74c3c; color: #fff; font-size: 11px; padding: 4px 10px; border-radius: 12px;
  }
  .filter-buttons {
    display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 10px;
  }
  .filter-btn {
    border: none; padding: 10px 14px; border-radius: 18px; font-size: 12px; font-weight: 600;
    cursor: pointer; transition: all 0.2s;
    min-height: 44px; /* Appleæ¨å¥¨ã‚¿ãƒƒãƒã‚¿ãƒ¼ã‚²ãƒƒãƒˆ */
    display: inline-flex; align-items: center; justify-content: center;
    -webkit-touch-callout: none;
    user-select: none;
  }
  .filter-btn.all { background: #ecf0f1; color: #2c3e50; border: 1px solid #bdc3c7; }
  .filter-btn.all.active { background: #2c3e50; color: #fff; }
  .filter-btn.starred { background: #fff3cd; color: #856404; border: 1px solid #f39c12; }
  .filter-btn.starred.active { background: #f39c12; color: #fff; }
  .filter-btn.airway { background: #e3f2fd; color: #1565c0; border: 1px solid #42a5f5; }
  .filter-btn.airway.active { background: #1565c0; color: #fff; }
  .filter-btn.circulation { background: #ffebee; color: #c62828; border: 1px solid #ef5350; }
  .filter-btn.circulation.active { background: #c62828; color: #fff; }
  .filter-btn.medication { background: #f3e5f5; color: #6a1b9a; border: 1px solid #ab47bc; }
  .filter-btn.medication.active { background: #6a1b9a; color: #fff; }
  .filter-btn.procedure { background: #e8f5e9; color: #2e7d32; border: 1px solid #66bb6a; }
  .filter-btn.procedure.active { background: #2e7d32; color: #fff; }
  .filter-btn.defib { background: #fff8e1; color: #f57f17; border: 1px solid #ffca28; }
  .filter-btn.defib.active { background: #f57f17; color: #fff; }
  
  .critical-stats {
    display: flex; flex-wrap: wrap; gap: 8px; font-size: 11px; color: #7f8c8d; padding: 8px 10px;
    background: #fff; border-radius: 6px; margin-bottom: 10px;
  }
  .critical-stats span { display: flex; align-items: center; gap: 3px; }
  
  .critical-output-btn {
    width: 100%; padding: 14px; background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    color: #fff; border: none; border-radius: 8px; font-size: 14px; font-weight: 700;
    display: flex; align-items: center; justify-content: center; gap: 8px;
    min-height: 50px;
    -webkit-touch-callout: none; user-select: none;
  }
  .critical-output-btn:active { transform: scale(0.98); opacity: 0.9; }
  
  /* ãƒœã‚¤ã‚¹ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */
  .voice-control { display: flex; gap: 12px; align-items: center; padding: 12px; background: #ecf0f1; border-radius: 8px; margin-bottom: 8px; }
  .voice-btn {
    flex-shrink: 0; width: 60px; height: 60px; border: none; border-radius: 50%;
    background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    color: #fff; font-size: 26px; box-shadow: 0 2px 8px rgba(231,76,60,0.3);
    -webkit-touch-callout: none; user-select: none;
  }
  .voice-btn:active { transform: scale(0.95); }
  .voice-btn.active { 
    background: linear-gradient(135deg, #27ae60 0%, #229954 100%); 
    animation: pulse-voice 1.5s infinite;
    box-shadow: 0 0 20px rgba(39, 174, 96, 0.6);
  }
  .voice-btn.standby {
    background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
    animation: pulse-standby 2s infinite;
    box-shadow: 0 0 15px rgba(243, 156, 18, 0.5);
  }
  .voice-btn:disabled { background: #95a5a6; opacity: 0.6; cursor: not-allowed; }
  @keyframes pulse-voice { 
    0%, 100% { transform: scale(1); box-shadow: 0 0 20px rgba(39, 174, 96, 0.6); } 
    50% { transform: scale(1.08); box-shadow: 0 0 30px rgba(39, 174, 96, 0.8); } 
  }
  @keyframes pulse-standby {
    0%, 100% { transform: scale(1); box-shadow: 0 0 15px rgba(243, 156, 18, 0.5); }
    50% { transform: scale(1.05); box-shadow: 0 0 25px rgba(243, 156, 18, 0.7); }
  }
  .voice-status { flex: 1; min-width: 0; }
  .voice-status-title { font-size: 13px; font-weight: 600; color: #2c3e50; margin-bottom: 4px; }
  .voice-status-text { font-size: 11px; color: #7f8c8d; line-height: 1.3; }
  .voice-interim { margin-top: 6px; padding: 8px 10px; background: #fff; border-radius: 6px; border-left: 3px solid #3498db; font-size: 12px; color: #7f8c8d; font-style: italic; min-height: 20px; }
  
  /* è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
  .settings-section {
    background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 12px; margin-bottom: 10px;
  }
  .settings-title {
    font-size: 13px; font-weight: 700; color: #856404; margin-bottom: 8px;
    display: flex; align-items: center; gap: 6px;
  }
  .setting-row {
    display: flex; align-items: center; gap: 10px; margin: 8px 0; padding: 10px;
    background: #fff; border-radius: 6px; min-height: 50px;
  }
  .setting-row label { flex: 1; font-size: 13px; color: #2c3e50; font-weight: 500; }
  .setting-row input[type="checkbox"] { 
    width: 24px; height: 24px; cursor: pointer; 
    /* iOSç”¨ã®ã‚¿ãƒƒãƒé ˜åŸŸæ‹¡å¤§ */
    min-width: 44px; min-height: 44px;
    margin: 0; padding: 10px;
  }
  .setting-row input[type="number"] { width: 70px; padding: 8px; border: 1px solid #bdc3c7; border-radius: 6px; font-size: 14px; }
  .setting-row input[type="password"] { flex:2; padding: 10px; border:1px solid #bdc3c7; border-radius:6px; font-size:14px; }

  /* å…¥åŠ›ãƒ»ãƒœã‚¿ãƒ³é¡ - ğŸ“Œ ã‚¿ãƒƒãƒã‚¿ãƒ¼ã‚²ãƒƒãƒˆ44pxä»¥ä¸Šç¢ºä¿ */
  textarea {
    width: 100%; min-height: 60px; border: 2px solid #bdc3c7; border-radius: 8px; padding: 10px;
    font-size: 16px; line-height: 1.5; resize: vertical; font-family: inherit; background: #fff;
    /* iOSå…¥åŠ›æ™‚ã®ã‚ºãƒ¼ãƒ é˜²æ­¢ */
    font-size: 16px !important;
  }
  textarea:focus { outline: none; border-color: #3498db; box-shadow: 0 0 0 3px rgba(52,152,219,0.2); }
  .controls { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
  .pill {
    display: inline-flex; align-items: center; gap: 4px; padding: 6px 10px; border: 1px solid #bdc3c7; border-radius: 14px;
    background: #ecf0f1; font-size: 11px; color: #2c3e50; font-weight: 500;
  }
  .btn {
    border: none; background: #3498db; color: #fff; border-radius: 8px; padding: 12px 16px; 
    font-weight: 600; font-size: 14px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    min-height: 44px; /* Appleæ¨å¥¨ã®æœ€å°ã‚¿ãƒƒãƒã‚¿ãƒ¼ã‚²ãƒƒãƒˆ */
    min-width: 44px;
    display: inline-flex; align-items: center; justify-content: center;
    -webkit-touch-callout: none; /* é•·æŠ¼ã—ãƒ¡ãƒ‹ãƒ¥ãƒ¼é˜²æ­¢ */
    user-select: none;
  }
  .btn:active { transform: scale(0.97); opacity: 0.9; }
  .btn.success { background: #27ae60; }
  .btn.danger { background: #e74c3c; }
  .btn.warning { background: #f39c12; }
  .btn.secondary { background: #95a5a6; }
  .btn.mini { font-size: 12px; padding: 8px 12px; min-height: 36px; }
  .tag-buttons {
    display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; max-height: 200px; overflow-y: auto; 
    padding: 8px; background: #f8f9fa; border-radius: 8px; 
    -webkit-overflow-scrolling: touch;
    overscroll-behavior: contain; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é€£é–é˜²æ­¢ */
  }
  .tag-buttons .btn {
    background: #e8f4f8; color: #2c3e50; font-size: 12px; padding: 10px 14px; 
    border-radius: 12px; border: 1px solid #3498db; min-height: 44px;
  }
  .tag-buttons .btn:active { background: #3498db; color: #fff; }
  .main-buttons { margin-top: 10px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
  
  /* çµ±è¨ˆãƒ»ãƒ­ã‚° */
  .stats { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 8px; margin-bottom: 10px; }
  .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; padding: 10px; border-radius: 8px; text-align: center; }
  .stat-value { font-size: 18px; font-weight: 700; margin-bottom: 2px; }
  .stat-label { font-size: 9px; opacity: 0.9; }
  .timeline { 
    max-height: 40vh; overflow-y: auto; 
    -webkit-overflow-scrolling: touch;
    overscroll-behavior: contain;
  }
  ul.log { list-style: none; display: flex; flex-direction: column; gap: 6px; }
  
  /* ãƒ­ã‚°è¡Œã®ã‚¹ã‚¿ã‚¤ãƒ« */
  .row {
    padding: 10px; border-left: 4px solid #3498db; border-radius: 6px; background: #f8f9fa; position: relative; box-shadow: 0 1px 3px rgba(0,0,0,0.05);
  }
  .row.selected { background: #e8f4f8; border-left-color: #e74c3c; }
  .row.ai-processing { border-left-color: #bdc3c7; background: #fff; opacity: 0.8; }
  .row.ai-processing .text::after { content: ' ğŸ¤– AIæ•´å½¢ä¸­...'; font-size: 11px; color: #9b59b6; animation: blink 1.5s infinite; }
  .row.ai-done { border-left-color: #9b59b6; }
  .row.ai-done .text::after { content: ' âœ¨'; font-size: 11px; }
  .row.ai-error { border-left-color: #e74c3c; background: #f8d7da; }
  .row.ai-error .text::after { content: ' âŒ AIã‚¨ãƒ©ãƒ¼'; font-size: 11px; color: #e74c3c; font-weight: 700; }
  
  /* ğŸ“Œ NEW v2.8.0: é‡è¦ãƒ­ã‚°ã®ã‚¹ã‚¿ã‚¤ãƒ« */
  .row.critical { background: linear-gradient(135deg, #fff5f5 0%, #ffe8e8 100%); }
  .row.starred { border-left-color: #f39c12; }
  .row.starred .star-btn { color: #f39c12; }
  .row.cat-airway { border-left-color: #1565c0; }
  .row.cat-circulation { border-left-color: #c62828; }
  .row.cat-medication { border-left-color: #6a1b9a; }
  .row.cat-procedure { border-left-color: #2e7d32; }
  .row.cat-defib { border-left-color: #f57f17; }
  
  .row .category-badge {
    display: inline-block; font-size: 10px; padding: 3px 6px; border-radius: 8px;
    margin-left: 6px; font-weight: 600;
  }
  .row .category-badge.airway { background: #e3f2fd; color: #1565c0; }
  .row .category-badge.circulation { background: #ffebee; color: #c62828; }
  .row .category-badge.medication { background: #f3e5f5; color: #6a1b9a; }
  .row .category-badge.procedure { background: #e8f5e9; color: #2e7d32; }
  .row .category-badge.defib { background: #fff8e1; color: #f57f17; }
  
  .time { font-size: 11px; font-weight: 700; color: #e74c3c; margin-right: 8px; }
  .text { font-size: 14px; color: #2c3e50; line-height: 1.4; }
  .addr { font-size: 10px; color: #7f8c8d; margin-top: 4px; }
  .actions { margin-top: 6px; display: flex; gap: 8px; align-items: center; }
  .actions button { 
    font-size: 12px; padding: 8px 12px; border: none; background: #ecf0f1; color: #2c3e50; 
    border-radius: 6px; min-height: 36px; min-width: 44px;
    -webkit-touch-callout: none; user-select: none;
  }
  .actions button:active { background: #bdc3c7; }
  .actions .star-btn { 
    font-size: 20px; background: transparent; color: #bdc3c7; 
    padding: 4px 8px; min-height: 44px; min-width: 44px;
    display: flex; align-items: center; justify-content: center;
  }
  .actions .star-btn:active { transform: scale(1.2); }
  
  /* Modal */
  .modal {
    display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 200;
    align-items: center; justify-content: center; padding: 20px;
  }
  .modal.show { display: flex; }
  .modal-content {
    background: #fff; border-radius: 12px; max-width: 500px; width: 100%; max-height: 80vh; overflow-y: auto;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
  }
  .modal-header { padding: 12px 16px; border-bottom: 2px solid #3498db; background: #ecf0f1; }
  .modal-header h3 { font-size: 14px; font-weight: 700; color: #2c3e50; }
  .modal-body { padding: 16px; }
  .modal-footer { padding: 12px 16px; border-top: 1px solid #ecf0f1; display: flex; gap: 8px; justify-content: flex-end; }
</style>
</head>
<body>

<header>
  <div class="header-content">
    <div><h1>ğŸš æ•‘æ€¥è¨˜éŒ²<span class="version">v2.8.0</span></h1></div>
    <div class="clock" id="clock">00:00:00</div>
  </div>
</header>

<div class="recording-indicator" id="recordingIndicator">
  <span class="icon">ğŸ¤</span>
  <span class="time" id="recordingTime">00:00</span>
</div>

<div class="wrap">
  <div class="grid">
    
    <div class="permission-alert" id="permissionAlert">
      <div class="permission-alert-title">âš ï¸ ãƒã‚¤ã‚¯æ¨©é™ãŒå¿…è¦ã§ã™</div>
      <div class="permission-alert-text">éŸ³å£°å…¥åŠ›ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒã‚¤ã‚¯æ¨©é™ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚è¨­å®š â†’ Safari â†’ ã‚«ãƒ¡ãƒ©ã¨ãƒã‚¤ã‚¯ ã‹ã‚‰è¨±å¯ã§ãã¾ã™ã€‚</div>
      <div class="permission-alert-buttons">
        <button class="btn mini secondary" onclick="document.getElementById('permissionAlert').classList.remove('show')">é–‰ã˜ã‚‹</button>
      </div>
    </div>
    
    <div class="case-section">
      <div class="case-header">
        <div class="case-title">ğŸ“ ã‚±ãƒ¼ã‚¹ç®¡ç†</div>
        <div class="case-controls">
          <button class="btn mini success" onclick="createNewCase()">æ–°è¦ä½œæˆ</button>
          <button class="btn mini" onclick="toggleCaseList()">ä¸€è¦§</button>
        </div>
      </div>
      <div class="case-info" id="caseInfo">
        ç¾åœ¨ã®ã‚±ãƒ¼ã‚¹: <strong id="currentCaseName">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ</strong> (<span id="currentCaseCount">0</span>ä»¶)
      </div>
      <div class="case-list" id="caseList" style="display:none;"></div>
    </div>
    
    <!-- ğŸ“Œ NEW v2.8.0: é‡è¦ãƒ­ã‚°æŠ½å‡ºã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="critical-section">
      <div class="critical-title">
        ğŸ¯ é‡è¦ãƒ­ã‚°æŠ½å‡º
        <span class="badge" id="criticalCount">0ä»¶</span>
      </div>
      <div class="filter-buttons">
        <button class="filter-btn all active" data-filter="all" onclick="setFilter('all')">å…¨ã¦</button>
        <button class="filter-btn starred" data-filter="starred" onclick="setFilter('starred')">â­ æ‰‹å‹•</button>
        <button class="filter-btn airway" data-filter="airway" onclick="setFilter('airway')">ğŸ« æ°—é“</button>
        <button class="filter-btn circulation" data-filter="circulation" onclick="setFilter('circulation')">ğŸ©¸ å¾ªç’°</button>
        <button class="filter-btn medication" data-filter="medication" onclick="setFilter('medication')">ğŸ’Š è–¬å‰¤</button>
        <button class="filter-btn procedure" data-filter="procedure" onclick="setFilter('procedure')">ğŸ”§ å‡¦ç½®</button>
        <button class="filter-btn defib" data-filter="defib" onclick="setFilter('defib')">âš¡ é™¤ç´°å‹•</button>
      </div>
      <div class="critical-stats" id="criticalStats">
        <span>ğŸ« æ°—é“: <strong>0</strong></span>
        <span>ğŸ©¸ å¾ªç’°: <strong>0</strong></span>
        <span>ğŸ’Š è–¬å‰¤: <strong>0</strong></span>
        <span>ğŸ”§ å‡¦ç½®: <strong>0</strong></span>
        <span>âš¡ é™¤ç´°å‹•: <strong>0</strong></span>
      </div>
      <button class="critical-output-btn" onclick="exportCriticalLogs()">
        ğŸ“‹ é‡è¦ãƒ­ã‚°ã‚’æŠ½å‡ºå‡ºåŠ›
      </button>
    </div>
    
    <div class="ai-control-section">
      <div class="ai-control-title">ğŸ¤– AIå‡¦ç†åˆ¶å¾¡ (RPMåˆ¶é™: 8ä»¶/åˆ†)</div>
      <div class="ai-queue-info" id="aiQueueInfo">
        ã‚­ãƒ¥ãƒ¼: 0ä»¶ | å‡¦ç†æ¸ˆ: 0ä»¶ | åˆ¶é™: 8ä»¶/åˆ†ã¾ã§
      </div>
      <button class="btn mini warning" style="width:100%" onclick="processAllLogsInCase()">ğŸ“ ç¾åœ¨ã®ã‚±ãƒ¼ã‚¹å…¨ä½“ã‚’AIå‡¦ç†</button>
    </div>

    <div class="card">
      <div class="voice-control">
        <button class="voice-btn" id="voiceBtn">ğŸ¤</button>
        <div class="voice-status">
          <div class="voice-status-title" id="voiceStatusTitle">åœæ­¢ä¸­</div>
          <div class="voice-status-text" id="voiceStatusText">ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦éŒ²éŸ³é–‹å§‹</div>
          <div class="voice-interim" id="voiceInterim"></div>
        </div>
      </div>
      <div id="systemStatus" class="system-status" style="display:none;"></div>
    </div>

    <div class="card">
      <h2>ğŸ“ è¨˜éŒ²ãƒ­ã‚°</h2>
      <div class="body">
        <div class="timeline"><ul class="log" id="logList"></ul></div>
        <div class="main-buttons">
          <button class="btn" id="btnCopy">ğŸ“¤ å‡ºåŠ›</button>
          <button class="btn" id="btnCopyAddr">ğŸ“ ä½æ‰€ä»˜ãå‡ºåŠ›</button>
          <button class="btn danger" id="btnClear">ğŸ—‘ï¸ å…¨æ¶ˆå»</button>
        </div>
      </div>
    </div>

    <div class="settings-section">
      <div class="settings-title">âš™ï¸ è¨­å®š</div>
      <div class="setting-row">
        <label>AIæ•´å½¢æ©Ÿèƒ½</label>
        <input type="checkbox" id="useAI" checked/>
      </div>
      <div class="setting-row">
        <label>ç”»é¢ã‚¹ãƒªãƒ¼ãƒ—é˜²æ­¢</label>
        <input type="checkbox" id="keepScreenOn" checked/>
      </div>
      <div class="setting-row">
        <label>Gemini API Key</label>
        <input type="password" id="apiKeyInput" placeholder="AIxxxxxx..."/>
        <button class="btn mini" id="btnSaveKey">ä¿å­˜</button>
      </div>
    </div>

    <div class="card">
      <h2>ğŸ·ï¸ ãƒ—ãƒªã‚»ãƒƒãƒˆ</h2>
      <div class="body">
        <div class="tag-buttons" id="tagButtons"></div>
      </div>
    </div>

    <div class="stats">
      <div class="stat-card">
        <div class="stat-value" id="totalLogs">0</div>
        <div class="stat-label">è¨˜éŒ²æ•°</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="totalTime">0åˆ†</div>
        <div class="stat-label">çµŒéæ™‚é–“</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="aiProcessed">0</div>
        <div class="stat-label">AIå‡¦ç†æ¸ˆ</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="aiPending">0</div>
        <div class="stat-label">AIå¾…æ©Ÿä¸­</div>
      </div>
    </div>

  </div>
</div>

<div class="modal" id="editModal">
  <div class="modal-content">
    <div class="modal-header"><h3>ğŸ“ è¨˜éŒ²ã‚’ç·¨é›†</h3></div>
    <div class="modal-body">
      <textarea id="editText" style="min-height:100px;"></textarea>
    </div>
    <div class="modal-footer">
      <button class="btn secondary" id="btnCancelEdit">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn success" id="btnSaveEdit">ä¿å­˜</button>
    </div>
  </div>
</div>

<script>
  /* --- Global State --- */
  let currentCaseId = 'default';
  let cases = {};
  let editingLogId = null;
  let gpsPosition = null;
  let aiStats = { processed: 0, pending: 0 };
  let currentFilter = 'all'; // ğŸ“Œ NEW v2.8.0: ãƒ•ã‚£ãƒ«ã‚¿çŠ¶æ…‹
  const AI_MODEL_NAME = 'gemini-2.0-flash-lite';
  const VERSION = 'v2.8.1';

  document.querySelector('.version').textContent = VERSION;
  document.title = `æ•‘æ€¥è¨˜éŒ² - AI Ultimate ${VERSION} (iPhoneæœ€é©åŒ–ç‰ˆ)`;

  /* --- ğŸ“Œ NEW v2.8.0: é‡è¦ãƒ­ã‚°æ¤œå‡ºç”¨ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å®šç¾© --- */
  const CRITICAL_KEYWORDS = {
    airway: {
      name: 'æ°—é“ç®¡ç†',
      icon: 'ğŸ«',
      keywords: [
        // æ°—ç®¡æŒ¿ç®¡é–¢é€£
        'æ°—ç®¡æŒ¿ç®¡', 'æŒ¿ç®¡', 'ãƒãƒ¥ãƒ¼ãƒ–', 'ETT', 'ã‚¨ã‚¢ã‚¦ã‚§ã‚¤', 'ã‚¨ã‚¢ã‚¦ã‚¨ã‚¤',
        'RSI', 'è¿…é€Ÿå°å…¥', 'ãƒ©ãƒ”ãƒƒãƒ‰ã‚·ãƒ¼ã‚±ãƒ³ã‚¹',
        // å£°é–€ä¸Šå™¨å…·
        'LMA', 'ãƒ©ãƒªãƒ³ã‚²ã‚¢ãƒ«ãƒã‚¹ã‚¯', 'ã‚¢ã‚¤ã‚¸ã‚§ãƒ«', 'i-gel', 'å£°é–€ä¸Š',
        // å¤–ç§‘çš„æ°—é“
        'è¼ªçŠ¶ç”²çŠ¶', 'æ°—ç®¡åˆ‡é–‹', 'ãƒˆãƒ©ã‚­ã‚ª', 'ã‚µãƒ¼ã‚¸ã‚«ãƒ«ã‚¨ã‚¢ã‚¦ã‚§ã‚¤', 'å¤–ç§‘çš„æ°—é“',
        // ãƒ“ãƒ‡ã‚ªå–‰é ­é¡
        'ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¹', 'McGRATH', 'ã‚¨ã‚¢ã‚¦ã‚§ã‚¤ã‚¹ã‚³ãƒ¼ãƒ—', 'AWS', 'ãƒ“ãƒ‡ã‚ªå–‰é ­é¡',
        // ãã®ä»–
        'æŠœç®¡', 'BURP', 'ã‚¯ãƒªã‚³ã‚¤ãƒ‰', 'ã‚»ãƒªãƒƒã‚¯', 'çµŒé¼»ã‚¨ã‚¢ã‚¦ã‚§ã‚¤', 'çµŒå£ã‚¨ã‚¢ã‚¦ã‚§ã‚¤'
      ]
    },
    circulation: {
      name: 'å¾ªç’°ãƒ»è¼¸è¡€',
      icon: 'ğŸ©¸',
      keywords: [
        // è¼¸è¡€é–¢é€£
        'è¼¸è¡€', 'RBC', 'RCC', 'èµ¤è¡€çƒ', 'FFP', 'è¡€æ¼¿', 'PC', 'è¡€å°æ¿',
        'ã‚¯ãƒ­ã‚¹ãƒãƒƒãƒ', 'ã‚¿ã‚¤ãƒ—&ã‚¹ã‚¯ãƒªãƒ¼ãƒ³', 'Oå‹', 'Oãƒã‚¬', 'O-',
        'MTP', 'å¤§é‡è¼¸è¡€', 'ç·Šæ€¥è¼¸è¡€',
        // ãƒ«ãƒ¼ãƒˆãƒ»ã‚¢ã‚¯ã‚»ã‚¹
        'ä¸­å¿ƒé™è„ˆ', 'CV', 'CVC', 'éª¨é«„', 'IO', 'éª¨é«„è·¯', 'PICC',
        'å‹•è„ˆãƒ©ã‚¤ãƒ³', 'Aãƒ©ã‚¤ãƒ³', 'æœ«æ¢¢ãƒ«ãƒ¼ãƒˆ', '18G', '16G', '14G',
        // å¾ªç’°è£œåŠ©
        'PCPS', 'ECMO', 'IABP', 'Impella',
        // è¼¸æ¶²
        'æ€¥é€Ÿè¼¸æ¶²', 'ãƒœãƒ¼ãƒ©ã‚¹', 'ãƒœãƒ«ãƒ™ãƒ³', 'ãƒ•ã‚£ã‚¸ã‚ª', 'ä¹³é…¸ãƒªãƒ³ã‚²ãƒ«', 'ç”Ÿé£Ÿ',
        // å¿ƒåœæ­¢ãƒ»è˜‡ç”Ÿ
        'CPR', 'å¿ƒè‡“ãƒãƒƒã‚µãƒ¼ã‚¸', 'èƒ¸éª¨åœ§è¿«', 'ROSC', 'å¿ƒæ‹å†é–‹', 'è‡ªå·±å¿ƒæ‹',
        // ãã®ä»–
        'æ˜‡åœ§å‰¤', 'ã‚«ãƒ†ã‚³ãƒ©ãƒŸãƒ³', 'é–‹èƒ¸', 'å¿ƒè‡“ãƒãƒƒã‚µãƒ¼ã‚¸'
      ]
    },
    medication: {
      name: 'è–¬å‰¤æŠ•ä¸',
      icon: 'ğŸ’Š',
      keywords: [
        // ã‚«ãƒ†ã‚³ãƒ©ãƒŸãƒ³
        'ã‚¢ãƒ‰ãƒ¬ãƒŠãƒªãƒ³', 'ãƒœã‚¹ãƒŸãƒ³', 'ã‚¨ãƒ”ãƒãƒ•ãƒªãƒ³', 'ã‚¨ãƒ”',
        'ãƒãƒ«ã‚¢ãƒ‰ãƒ¬ãƒŠãƒªãƒ³', 'ãƒãƒ«ã‚¢ãƒ‰', 'ãƒãƒ«ã‚¨ãƒ”',
        'ãƒ‰ãƒ‘ãƒŸãƒ³', 'ãƒ‰ãƒ–ã‚¿ãƒŸãƒ³', 'ãƒ‰ãƒ–ãƒˆãƒ¬ãƒƒã‚¯ã‚¹',
        // é®é™ãƒ»é®ç—›
        'ãƒ—ãƒ­ãƒãƒ•ã‚©ãƒ¼ãƒ«', 'ãƒ‡ã‚£ãƒ—ãƒªãƒãƒ³', 'ãƒŸãƒ€ã‚¾ãƒ©ãƒ ', 'ãƒ‰ãƒ«ãƒŸã‚«ãƒ ',
        'ãƒ•ã‚§ãƒ³ã‚¿ãƒ‹ãƒ«', 'ã‚±ã‚¿ãƒŸãƒ³', 'ã‚±ã‚¿ãƒ©ãƒ¼ãƒ«',
        'ãƒ­ã‚¯ãƒ­ãƒ‹ã‚¦ãƒ ', 'ã‚¨ã‚¹ãƒ©ãƒƒã‚¯ã‚¹', 'ã‚¹ã‚­ã‚µãƒ¡ãƒˆãƒ‹ã‚¦ãƒ ', 'ã‚µã‚¯ã‚·ãƒ³',
        // æŠ—ä¸æ•´è„ˆ
        'ã‚¢ãƒŸã‚ªãƒ€ãƒ­ãƒ³', 'ã‚¢ãƒ³ã‚«ãƒ­ãƒ³', 'ãƒªãƒ‰ã‚«ã‚¤ãƒ³', 'ã‚­ã‚·ãƒ­ã‚«ã‚¤ãƒ³',
        'ã‚¢ãƒˆãƒ­ãƒ”ãƒ³', 'ã‚¤ã‚½ãƒ—ãƒ­ãƒ†ãƒ¬ãƒãƒ¼ãƒ«',
        // æ˜‡åœ§ãƒ»é™åœ§
        'ãƒã‚½ãƒ—ãƒ¬ã‚·ãƒ³', 'ãƒ‹ã‚«ãƒ«ã‚¸ãƒ”ãƒ³', 'ãƒšãƒ«ã‚¸ãƒ”ãƒ³', 'ãƒ‹ãƒˆãƒ­ã‚°ãƒªã‚»ãƒªãƒ³', 'ãƒ‹ãƒˆãƒ­',
        // æŠ—å‡å›º
        'ãƒ˜ãƒ‘ãƒªãƒ³', 'ãƒ—ãƒ­ã‚¿ãƒŸãƒ³', 'ãƒˆãƒ©ãƒã‚­ã‚µãƒ é…¸', 'ãƒˆãƒ©ãƒ³ã‚µãƒŸãƒ³',
        // é›»è§£è³ªãƒ»ãã®ä»–
        'ã‚«ãƒ«ãƒã‚³ãƒ¼ãƒ«', 'ã‚°ãƒ«ã‚³ãƒ³é…¸ã‚«ãƒ«ã‚·ã‚¦ãƒ ', 'ãƒ¡ã‚¤ãƒ­ãƒ³', 'é‡æ›¹',
        'ãƒ–ãƒ‰ã‚¦ç³–', 'ã‚°ãƒ«ã‚³ãƒ¼ã‚¹', 'ã‚¤ãƒ³ã‚¹ãƒªãƒ³',
        'ãƒã‚°ãƒã‚·ã‚¦ãƒ ', 'ã‚«ãƒªã‚¦ãƒ ',
        // è§£æ¯’ãƒ»æ‹®æŠ—
        'ãƒŠãƒ­ã‚­ã‚½ãƒ³', 'ãƒ•ãƒ«ãƒã‚¼ãƒ‹ãƒ«', 'ã‚¢ãƒã‚­ã‚»ãƒ¼ãƒˆ', 'ã‚¤ãƒ³ãƒˆãƒ©ãƒªãƒã‚¹', 'è„‚è‚ªä¹³å‰¤',
        // æŠ—ç”Ÿå‰¤
        'æŠ—èŒè–¬', 'æŠ—ç”Ÿå‰¤', 'æŠ—ç”Ÿç‰©è³ª'
      ]
    },
    procedure: {
      name: 'å‡¦ç½®',
      icon: 'ğŸ”§',
      keywords: [
        // èƒ¸è…”é–¢é€£
        'èƒ¸è…”ãƒ‰ãƒ¬ãƒ¼ãƒ³', 'èƒ¸è…”ç©¿åˆº', 'ãƒ‰ãƒ¬ãƒŠãƒ¼ã‚¸', 'ãƒˆãƒ­ãƒƒã‚«ãƒ¼', 'è„±æ°—',
        'ç·Šå¼µæ€§æ°—èƒ¸', 'é–‹æ”¾æ€§æ°—èƒ¸', 'è¡€èƒ¸',
        // REBOAãƒ»æ­¢è¡€
        'REBOA', 'ãƒ¬ãƒœã‚¢', 'å¤§å‹•è„ˆé®æ–­', 'ã‚¾ãƒ¼ãƒ³',
        'æ­¢è¡€', 'ãƒ‘ãƒƒã‚­ãƒ³ã‚°', 'ã‚¿ãƒ¼ãƒ‹ã‚±ãƒƒãƒˆ',
        // é–‹èƒ¸ãƒ»é–‹è…¹
        'é–‹èƒ¸', 'ç·Šæ€¥é–‹èƒ¸', 'ã‚¯ãƒ©ãƒ ã‚·ã‚§ãƒ«', 'EDé–‹èƒ¸',
        'é–‹è…¹', 'ç·Šæ€¥é–‹è…¹', 'ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«', 'DCS',
        // éª¨æŠ˜ãƒ»å›ºå®š
        'éª¨ç›¤å›ºå®š', 'ã‚·ãƒ¼ãƒ„ãƒ©ãƒƒãƒ”ãƒ³ã‚°', 'ã‚µãƒ ã‚¹ãƒªãƒ³ã‚°', 'Tãƒãƒƒãƒ‰',
        'è„Šæ¤å›ºå®š', 'ãƒãƒƒã‚¯ãƒœãƒ¼ãƒ‰', 'é ¸æ¤ã‚«ãƒ©ãƒ¼',
        // å‰µå‚·å‡¦ç½®
        'ç¸«åˆ', 'å‰µé–‰é–', 'ãƒ‡ãƒ–ãƒª', 'ãƒ‡ãƒ–ãƒªãƒ¼ãƒ‰ãƒãƒ³',
        // æ¸›åœ§
        'é–‹é ­', 'ç©¿é ­', 'è„³å®¤ãƒ‰ãƒ¬ãƒŠãƒ¼ã‚¸', 'æ¸›åœ§',
        // ãã®ä»–
        'çµŒçš®çš„', 'ãƒšãƒ¼ã‚·ãƒ³ã‚°', 'ãƒšãƒ¼ã‚¹ãƒ¡ãƒ¼ã‚«ãƒ¼', 'PM'
      ]
    },
    defib: {
      name: 'é™¤ç´°å‹•',
      icon: 'âš¡',
      keywords: [
        // é™¤ç´°å‹•
        'é™¤ç´°å‹•', 'DC', 'ã‚·ãƒ§ãƒƒã‚¯', 'ãƒ‡ã‚£ãƒ•ã‚£ãƒ–',
        'AED', 'è‡ªå‹•ä½“å¤–å¼', 'ãƒ‘ãƒƒãƒ‰',
        // ãƒªã‚ºãƒ 
        'VF', 'å¿ƒå®¤ç´°å‹•', 'pVT', 'ç„¡è„ˆæ€§VT', 'ç„¡è„ˆæ€§å¿ƒå®¤é »æ‹',
        'PEA', 'ç„¡è„ˆæ€§é›»æ°—æ´»å‹•', 'ã‚¢ã‚·ã‚¹ãƒˆãƒªãƒ¼', 'Asystole',
        // é›»æ°—çš„æ²»ç™‚
        'ã‚«ãƒ«ãƒ‡ã‚£ã‚ªãƒãƒ¼ã‚¸ãƒ§ãƒ³', 'åŒæœŸ',
        // ãã®ä»–
        'ã‚¸ãƒ¥ãƒ¼ãƒ«', 'J', 'äºŒç›¸æ€§', 'å˜ç›¸æ€§'
      ]
    }
  };

  /* --- ğŸ“Œ NEW v2.8.0: ãƒ­ã‚°ã®ã‚«ãƒ†ã‚´ãƒªè‡ªå‹•æ¤œå‡º --- */
  function detectCategory(text) {
    const lowerText = text.toLowerCase();
    const detected = [];
    
    for (const [category, data] of Object.entries(CRITICAL_KEYWORDS)) {
      for (const keyword of data.keywords) {
        if (text.includes(keyword) || lowerText.includes(keyword.toLowerCase())) {
          detected.push(category);
          break; // åŒã˜ã‚«ãƒ†ã‚´ãƒªã§è¤‡æ•°ãƒãƒƒãƒã—ã¦ã‚‚1å›ã ã‘
        }
      }
    }
    
    return detected;
  }
  
  /* --- ğŸ“Œ NEW v2.8.0: é‡è¦ãƒ­ã‚°ã‹ã©ã†ã‹åˆ¤å®š --- */
  function isCritical(log) {
    return log.starred || (log.categories && log.categories.length > 0);
  }
  
  /* --- ğŸ“Œ NEW v2.8.0: ãƒ•ã‚£ãƒ«ã‚¿åˆ‡ã‚Šæ›¿ãˆ --- */
  function setFilter(filter) {
    currentFilter = filter;
    
    // ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.filter === filter);
    });
    
    render();
  }
  
  /* --- ğŸ“Œ NEW v2.8.0: é‡è¦ãƒ­ã‚°ã®çµ±è¨ˆã‚’æ›´æ–° --- */
  function updateCriticalStats() {
    const logs = getLogs();
    const stats = {
      airway: 0,
      circulation: 0,
      medication: 0,
      procedure: 0,
      defib: 0,
      starred: 0
    };
    
    logs.forEach(log => {
      if (log.starred) stats.starred++;
      if (log.categories) {
        log.categories.forEach(cat => {
          if (stats[cat] !== undefined) stats[cat]++;
        });
      }
    });
    
    const totalCritical = logs.filter(log => isCritical(log)).length;
    document.getElementById('criticalCount').textContent = `${totalCritical}ä»¶`;
    
    document.getElementById('criticalStats').innerHTML = `
      <span>â­ æ‰‹å‹•: <strong>${stats.starred}</strong></span>
      <span>ğŸ« æ°—é“: <strong>${stats.airway}</strong></span>
      <span>ğŸ©¸ å¾ªç’°: <strong>${stats.circulation}</strong></span>
      <span>ğŸ’Š è–¬å‰¤: <strong>${stats.medication}</strong></span>
      <span>ğŸ”§ å‡¦ç½®: <strong>${stats.procedure}</strong></span>
      <span>âš¡ é™¤ç´°å‹•: <strong>${stats.defib}</strong></span>
    `;
  }
  
  /* --- ğŸ“Œ NEW v2.8.0: â­ãƒˆã‚°ãƒ« --- */
  window.toggleStar = (id) => {
    const log = getLogs().find(r => r.id === id);
    if (log) {
      log.starred = !log.starred;
      save();
      render();
      updateCriticalStats();
    }
  };
  
  /* --- ğŸ“Œ NEW v2.8.0: é‡è¦ãƒ­ã‚°æŠ½å‡ºå‡ºåŠ› --- */
  function exportCriticalLogs() {
    const logs = getLogs();
    let filteredLogs;
    
    if (currentFilter === 'all') {
      filteredLogs = logs.filter(log => isCritical(log));
    } else if (currentFilter === 'starred') {
      filteredLogs = logs.filter(log => log.starred);
    } else {
      filteredLogs = logs.filter(log => log.categories && log.categories.includes(currentFilter));
    }
    
    if (filteredLogs.length === 0) {
      alert('æŠ½å‡ºå¯¾è±¡ã®ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“');
      return;
    }
    
    const currentCase = cases[currentCaseId];
    const filterName = currentFilter === 'all' ? 'é‡è¦ãƒ­ã‚°' : 
                       currentFilter === 'starred' ? 'æ‰‹å‹•ãƒãƒ¼ã‚¯' :
                       CRITICAL_KEYWORDS[currentFilter]?.name || currentFilter;
    
    // ãƒ˜ãƒƒãƒ€ãƒ¼ä½œæˆ
    let txt = `=== ${currentCase.name} ===\n`;
    txt += `æŠ½å‡ºæ¡ä»¶: ${filterName}\n`;
    txt += `æŠ½å‡ºä»¶æ•°: ${filteredLogs.length}ä»¶\n`;
    txt += `å‡ºåŠ›æ—¥æ™‚: ${new Date().toLocaleString('ja-JP')}\n`;
    txt += `${'='.repeat(30)}\n\n`;
    
    // ãƒ­ã‚°æœ¬æ–‡
    filteredLogs.forEach(log => {
      let line = `${log.time}`;
      if (log.starred) line += ' â­';
      if (log.categories && log.categories.length > 0) {
        const catIcons = log.categories.map(c => CRITICAL_KEYWORDS[c]?.icon || '').join('');
        line += ` ${catIcons}`;
      }
      line += `\n  ${log.text}`;
      if (log.address) line += `\n  ğŸ“ ${log.address}`;
      txt += line + '\n\n';
    });
    
    const fileName = `${currentCase.name}_${filterName}.txt`;
    
    // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    const blob = new Blob([txt], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = fileName;
    a.style.display = 'none';
    document.body.appendChild(a);
    a.click();
    setTimeout(() => {
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }, 100);
    
    showSystemStatus(`${filteredLogs.length}ä»¶ã®é‡è¦ãƒ­ã‚°ã‚’å‡ºåŠ›ã—ã¾ã—ãŸ`, 'success');
  }


  /* --- AI Rate Limiter (8 requests per minute) --- */
  class AIRateLimiter {
    constructor(maxRequests = 8, windowMs = 60000) {
      this.maxRequests = maxRequests;
      this.windowMs = windowMs;
      this.queue = [];
      this.processing = false;
      this.requestTimes = [];
    }
    
    async enqueue(logId, text) {
      if (this.queue.some(item => item.logId === logId)) return;
      
      this.queue.push({ logId, text, timestamp: Date.now() });
      aiStats.pending = this.queue.length;
      updateStats();
      updateAIQueueInfo();
      
      if (!this.processing) {
        this.processQueue();
      }
    }
    
    async processQueue() {
      if (this.queue.length === 0) {
        this.processing = false;
        return;
      }
      
      this.processing = true;
      const now = Date.now();
      
      this.requestTimes = this.requestTimes.filter(t => now - t < this.windowMs);
      
      if (this.requestTimes.length >= this.maxRequests) {
        const oldestRequest = this.requestTimes[0];
        const waitTime = this.windowMs - (now - oldestRequest);
        showSystemStatus(`AIåˆ¶é™ä¸­: ${Math.ceil(waitTime/1000)}ç§’å¾…æ©Ÿ (RPMãƒªã‚»ãƒƒãƒˆå¾…ã¡)`, 'warning');
        setTimeout(() => this.processQueue(), waitTime + 100);
        return;
      }
      
      const item = this.queue.shift();
      aiStats.pending = this.queue.length;
      updateStats();
      updateAIQueueInfo();
      
      this.requestTimes.push(Date.now());
      await gemini.correct(item.logId, item.text);
      
      setTimeout(() => this.processQueue(), 500);
    }
    
    getStatus() {
      const now = Date.now();
      this.requestTimes = this.requestTimes.filter(t => now - t < this.windowMs);
      return {
        queueLength: this.queue.length,
        recentRequests: this.requestTimes.length,
        maxRequests: this.maxRequests
      };
    }
  }
  const aiLimiter = new AIRateLimiter(8, 60000);

  /* --- Utils --- */
  function nowHHMMSS(){
    const d=new Date(); return [d.getHours(),d.getMinutes(),d.getSeconds()].map(v=>v.toString().padStart(2,'0')).join(':');
  }
  function nowDate(){ const d=new Date(); return `${d.getFullYear()}${(d.getMonth()+1).toString().padStart(2,'0')}${d.getDate().toString().padStart(2,'0')}`; }
  function nowTime(){ const d=new Date(); return `${d.getHours().toString().padStart(2,'0')}${d.getMinutes().toString().padStart(2,'0')}`; }

  /* --- Case Management --- */
  function initCases() {
    const saved = localStorage.getItem('beatlog_cases');
    if (saved) {
      cases = JSON.parse(saved);
    } else {
      cases = {
        'default': {
          name: 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ',
          logs: [],
          createdAt: new Date().toISOString()
        }
      };
    }
    currentCaseId = localStorage.getItem('beatlog_current_case') || 'default';
  }
  
  function saveCases() {
    localStorage.setItem('beatlog_cases', JSON.stringify(cases));
    localStorage.setItem('beatlog_current_case', currentCaseId);
  }
  
  function createNewCase() {
    const caseName = prompt('äº‹æ¡ˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', 'äº‹æ¡ˆ');
    if (!caseName) return;
    
    const date = nowDate();
    const time = nowTime();
    const caseId = `case_${Date.now()}`;
    const fullName = `${caseName}-${date}-${time}`;
    
    cases[caseId] = {
      name: fullName,
      logs: [],
      createdAt: new Date().toISOString()
    };
    
    currentCaseId = caseId;
    saveCases();
    updateCaseInfo();
    renderCaseList();
    render();
    showSystemStatus(`æ–°è¦ã‚±ãƒ¼ã‚¹ä½œæˆ: ${fullName}`, 'success');
  }
  
  function switchCase(caseId) {
    if (!cases[caseId]) return;
    currentCaseId = caseId;
    saveCases();
    updateCaseInfo();
    render();
    updateCriticalStats();
    showSystemStatus(`ã‚±ãƒ¼ã‚¹åˆ‡æ›¿: ${cases[caseId].name}`, 'success');
  }
  
  function deleteCase(caseId) {
    if (caseId === 'default') {
      alert('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚±ãƒ¼ã‚¹ã¯å‰Šé™¤ã§ãã¾ã›ã‚“');
      return;
    }
    if (!confirm(`ã‚±ãƒ¼ã‚¹ã€Œ${cases[caseId].name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹?`)) return;
    
    delete cases[caseId];
    if (currentCaseId === caseId) {
      currentCaseId = 'default';
    }
    saveCases();
    updateCaseInfo();
    renderCaseList();
    render();
    showSystemStatus('ã‚±ãƒ¼ã‚¹å‰Šé™¤å®Œäº†', 'success');
  }
  
  function updateCaseInfo() {
    const currentCase = cases[currentCaseId];
    document.getElementById('currentCaseName').textContent = currentCase.name;
    document.getElementById('currentCaseCount').textContent = currentCase.logs.length;
  }
  
  function toggleCaseList() {
    const list = document.getElementById('caseList');
    if (list.style.display === 'none') {
      renderCaseList();
      list.style.display = 'block';
    } else {
      list.style.display = 'none';
    }
  }
  
  function renderCaseList() {
    const list = document.getElementById('caseList');
    list.innerHTML = '';
    
    Object.entries(cases).forEach(([caseId, caseData]) => {
      const item = document.createElement('div');
      item.className = 'case-item' + (caseId === currentCaseId ? ' active' : '');
      item.innerHTML = `
        <span class="name">${caseData.name}</span>
        <span class="count">${caseData.logs.length}ä»¶</span>
        ${caseId !== 'default' ? '<span class="delete" onclick="event.stopPropagation(); deleteCase(\''+caseId+'\')">ğŸ—‘ï¸</span>' : ''}
      `;
      item.onclick = () => {
        switchCase(caseId);
        toggleCaseList();
      };
      list.appendChild(item);
    });
  }
  
  /* --- Process All Logs in Current Case --- */
  async function processAllLogsInCase() {
    const currentCase = cases[currentCaseId];
    const unprocessedLogs = currentCase.logs.filter(log => !log.aiProcessed && !log.aiProcessing && !log.aiError);
    
    if (unprocessedLogs.length === 0) {
      alert('AIå‡¦ç†ãŒå¿…è¦ãªãƒ­ã‚°ã¯ã‚ã‚Šã¾ã›ã‚“');
      return;
    }
    
    if (!confirm(`${unprocessedLogs.length}ä»¶ã®ãƒ­ã‚°ã‚’AIå‡¦ç†ã—ã¾ã™ã‹?\nRPMåˆ¶é™ã«ã‚ˆã‚Šæ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚`)) {
      return;
    }
    
    showSystemStatus(`${unprocessedLogs.length}ä»¶ã®ãƒ­ã‚°ã‚’ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ ä¸­...`, 'warning');
    
    for (const log of unprocessedLogs) {
      log.aiProcessed = false;
      log.aiError = false;
      await aiLimiter.enqueue(log.id, log.text);
    }
    
    showSystemStatus(`${unprocessedLogs.length}ä»¶ã‚’ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ å®Œäº†`, 'success');
    render();
  }
  
  /* --- Update AI Queue Info --- */
  function updateAIQueueInfo() {
    const status = aiLimiter.getStatus();
    document.getElementById('aiQueueInfo').innerHTML = `
      ã‚­ãƒ¥ãƒ¼: <strong>${status.queueLength}</strong>ä»¶ | 
      å‡¦ç†æ¸ˆ: <strong>${aiStats.processed}</strong>ä»¶ | 
      ç¾åœ¨ã®åˆ†é–“ãƒªã‚¯ã‚¨ã‚¹ãƒˆ: <strong>${status.recentRequests}/${status.maxRequests}</strong>ä»¶
    `;
  }

  /* --- Data Management --- */
  function save() { saveCases(); }
  function load() { initCases(); updateCaseInfo(); }
  
  function getLogs() {
    return cases[currentCaseId].logs;
  }
  
  function addLine(text, address, useAI) {
    if (!text || !text.trim()) {
      return;
    }
    
    const id = Date.now() + Math.random();
    
    // ğŸ“Œ NEW v2.8.0: ã‚«ãƒ†ã‚´ãƒªè‡ªå‹•æ¤œå‡º
    const categories = detectCategory(text);
    
    const log = { 
      id, 
      time: nowHHMMSS(), 
      text, 
      address, 
      aiProcessed: false, 
      aiError: false, 
      aiProcessing: false,
      starred: false, // ğŸ“Œ NEW v2.8.0
      categories: categories // ğŸ“Œ NEW v2.8.0
    };
    cases[currentCaseId].logs.push(log);
    save();
    render();
    updateStats();
    updateCriticalStats();
    
    if (useAI && text.trim()) {
      aiLimiter.enqueue(id, text);
    }
  }

  /* --- Gemini AI --- */
  const gemini = {
    key: localStorage.getItem('gemini_key') || '',
    setKey(k) { this.key = k; localStorage.setItem('gemini_key', k); showSystemStatus('API Keyä¿å­˜å®Œäº†', 'success'); },
    async correct(logId, text) {
      if (!this.key) {
        showSystemStatus('ã‚¨ãƒ©ãƒ¼: API KeyãŒæœªè¨­å®šã§ã™', 'error');
        return;
      }
      
      const row = getLogs().find(r => r.id === logId);
      if (!row) return;
      
      row.aiProcessing = true;
      row.aiError = false;
      render();
      
      try {
        const prompt = `ä»¥ä¸‹ã®æ•‘æ€¥ç¾å ´ã®éŸ³å£°å…¥åŠ›æ–‡ã‚’ã€åŒ»å­¦çš„ã«æ­£ç¢ºãªè¨˜éŒ²ã«æ•´å½¢ã—ã¦ãã ã•ã„ã€‚

**æŒ‡ç¤º:**
1.  **æ•´å½¢ã¯ã€å…¥åŠ›ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã®å†…å®¹ã‚’åŸºã«å®Ÿæ–½ã—ã¦ãã ã•ã„ã€‚**
2.  **å…¥åŠ›ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã«æ˜è¨˜ã•ã‚Œã¦ã„ãªã„äº‹å®Ÿæƒ…å ±ï¼ˆå¹´é½¢ã€ãƒã‚¤ã‚¿ãƒ«ã‚µã‚¤ãƒ³ã€è©³ç´°ãªç—…æ­´ãªã©ï¼‰ã¯ã€çµ¶å¯¾ã«æ¨æ¸¬ã—ã¦è¿½åŠ ã—ãªã„ã§ãã ã•ã„ã€‚**
3.  ä¼šè©±å†…å®¹ã‚’8å‰²ç¨‹åº¦ç¶­æŒã—ã€å¤§å¹…ãªå‰Šé™¤ã¯è¡Œã‚ãªã„ã§ãã ã•ã„ã€‚
4.  æ„è­˜ãƒ¬ãƒ™ãƒ«ã«ã¤ã„ã¦ã¯ã€**GCS (ã‚°ãƒ©ã‚¹ã‚´ãƒ¼ãƒ»ã‚³ãƒ¼ãƒãƒ»ã‚¹ã‚±ãƒ¼ãƒ«)** ã®å ´åˆã¯ **Eâ—‹Vâ—‹Mâ—‹** ã®å½¢å¼ï¼ˆä¾‹: GCS E3V4M6ï¼‰ã«æ•´å½¢ã—ã€**JCS (ã‚¸ãƒ£ãƒ‘ãƒ³ãƒ»ã‚³ãƒ¼ãƒãƒ»ã‚¹ã‚±ãƒ¼ãƒ«)** ã¨èª¤èªè­˜ã—ãªã„ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚ï¼ˆä¾‹ï¼šã€Œ114ã€â†’ã€ŒGCS E1V1M4ã€ï¼‰
5.  ãƒã‚¤ã‚¿ãƒ«ã‚µã‚¤ãƒ³ã¯ç¾è¡Œã®æ•°å­—ã¨å˜ä½ã‚’ä¿æŒã—ã€é©åˆ‡ãªå½¢å¼ã«æ•´å½¢ã—ã¦ãã ã•ã„ã€‚
6.  åŒ»å­¦ç”¨èªã¯é©åˆ‡ã«ä¿®æ­£ã—ã€ä¸è¦ãªå£èªè¡¨ç¾ã¯å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚
7.  æ•´å½¢ã•ã‚ŒãŸ**è¨˜éŒ²æ–‡ã®ã¿**ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚ä¸€åˆ‡ã®èª¬æ˜ã‚„è§£èª¬ã‚’å«ã‚ãªã„ã§ãã ã•ã„ã€‚
8.  å…¥åŠ›ãŒçŸ­ã™ãã‚‹å ´åˆã‚„å…·ä½“çš„ãªæƒ…å ±ã‚’å«ã¾ãªã„å ´åˆã§ã‚‚ã€**æ¶ç©ºã®äº‹å®Ÿæƒ…å ±ã‚’ä½œæˆã™ã‚‹ä»£ã‚ã‚Šã«ã€å…¥åŠ›ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã‚’ãã®ã¾ã¾æ•´å½¢ã—ãŸçµæœã‚’è¿”ã—ã¦ãã ã•ã„ã€‚**

å…¥åŠ›: ${text}`;
        
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${AI_MODEL_NAME}:generateContent?key=${this.key}`;
        
        const res = await fetch(apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }],
            generationConfig: { temperature: 0.3, maxOutputTokens: 512 } 
          })
        });
        
        if (!res.ok) {
          const errorBody = await res.text();
          throw new Error(`HTTP Error: ${res.status} ${res.statusText || res.status} - ${errorBody.substring(0, 50)}...`);
        }
        
        const data = await res.json();
        const corrected = data.candidates?.[0]?.content?.parts?.[0]?.text?.trim();
        
        if (corrected) {
          row.text = corrected;
          row.aiProcessed = true;
          aiStats.processed++;
          
          // ğŸ“Œ NEW v2.8.0: AIæ•´å½¢å¾Œã«ã‚«ãƒ†ã‚´ãƒªã‚’å†æ¤œå‡º
          row.categories = detectCategory(corrected);
        }
      } catch (e) {
        console.error('AI Error:', e);
        row.aiError = true;
        
        let errorMsg = e.message;
        if (errorMsg.includes('400')) errorMsg = '400 Bad Request (ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¾ãŸã¯APIã‚­ãƒ¼ã‚¨ãƒ©ãƒ¼)';
        if (errorMsg.includes('403')) errorMsg = '403 Forbidden (APIã‚­ãƒ¼ã®æ¨©é™ä¸è¶³)';
        if (errorMsg.includes('404')) errorMsg = '404 Not Found (ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¾ãŸã¯ãƒ¢ãƒ‡ãƒ«åã‚¨ãƒ©ãƒ¼)';
        if (errorMsg.includes('429')) errorMsg = '429 Too Many Requests (ãƒ¬ãƒ¼ãƒˆåˆ¶é™è¶…é)';
        if (errorMsg.includes('500')) errorMsg = '500 Server Error (Geminiã‚µãƒ¼ãƒãƒ¼å´ã®å•é¡Œ)';
        
        showSystemStatus(`AIå‡¦ç†å¤±æ•—: ${errorMsg}`, 'error');
      } finally {
        row.aiProcessing = false;
        save();
        render();
        updateStats();
        updateCriticalStats();
      }
    }
  };

  /* --- Audio Feedback --- */
  const feedback = {
    ctx: null,
    getCtx() { if (!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)(); return this.ctx; },
    playBeep(freq, dur) {
      if (!document.getElementById('useAI').checked) return;
      const ctx = this.getCtx();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.frequency.value = freq;
      gain.gain.setValueAtTime(0.1, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + dur / 1000);
      osc.start();
      osc.stop(ctx.currentTime + dur / 1000);
    }
  };

  /* --- GPS --- */
  async function fetchAddressFromGPS() {
    if (!gpsPosition) return '';
    const { latitude, longitude } = gpsPosition.coords;
    try {
      const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&accept-language=ja`);
      const data = await res.json();
      return data.display_name || '';
    } catch (e) {
      return `${latitude.toFixed(5)}, ${longitude.toFixed(5)}`;
    }
  }
  
  if (navigator.geolocation) {
    navigator.geolocation.watchPosition(pos => { gpsPosition = pos; }, (error) => {
        // GPS errors silently handled
    }, { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 });
  }

  /* --- Render --- */
  function render() {
    const logs = getLogs();
    const ul = document.getElementById('logList');
    ul.innerHTML = '';
    
    // ğŸ“Œ NEW v2.8.0: ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨
    let filteredLogs = logs;
    if (currentFilter !== 'all') {
      if (currentFilter === 'starred') {
        filteredLogs = logs.filter(log => log.starred);
      } else {
        filteredLogs = logs.filter(log => log.categories && log.categories.includes(currentFilter));
      }
    }
    
    if (!filteredLogs.length) {
      const msg = currentFilter === 'all' ? 'è¨˜éŒ²ãªã—' : `ã€Œ${currentFilter === 'starred' ? 'æ‰‹å‹•ãƒãƒ¼ã‚¯' : CRITICAL_KEYWORDS[currentFilter]?.name || currentFilter}ã€ã«è©²å½“ã™ã‚‹ãƒ­ã‚°ãªã—`;
      ul.innerHTML = `<li class="row" style="text-align:center;color:#7f8c8d;">${msg}</li>`;
      return;
    }
    
    [...filteredLogs].reverse().forEach(row => {
      const li = document.createElement('li');
      
      // ã‚¯ãƒ©ã‚¹æ§‹ç¯‰
      let classes = ['row'];
      if (row.selected) classes.push('selected');
      if (row.aiProcessing) classes.push('ai-processing');
      if (row.aiProcessed) classes.push('ai-done');
      if (row.aiError) classes.push('ai-error');
      if (row.starred) classes.push('starred');
      if (isCritical(row)) classes.push('critical');
      if (row.categories && row.categories.length > 0) {
        classes.push(`cat-${row.categories[0]}`); // æœ€åˆã®ã‚«ãƒ†ã‚´ãƒªã®è‰²ã‚’ä½¿ç”¨
      }
      
      li.className = classes.join(' ');
      
      // ã‚«ãƒ†ã‚´ãƒªãƒãƒƒã‚¸ç”Ÿæˆ
      let categoryBadges = '';
      if (row.categories && row.categories.length > 0) {
        categoryBadges = row.categories.map(cat => {
          const catData = CRITICAL_KEYWORDS[cat];
          return `<span class="category-badge ${cat}">${catData?.icon || ''} ${catData?.name || cat}</span>`;
        }).join('');
      }
      
      li.innerHTML = `
        <div>
          <span class="time">${row.time}</span>
          <span class="text">${row.text}</span>
          ${categoryBadges}
        </div>
        ${row.address ? `<div class="addr">ğŸ“ ${row.address}</div>` : ''}
        <div class="actions">
          <button class="star-btn" onclick="toggleStar(${row.id})">${row.starred ? 'â­' : 'â˜†'}</button>
          <button onclick="openEditModal(${row.id})">ç·¨é›†</button>
          <button onclick="deleteLog(${row.id})">å‰Šé™¤</button>
        </div>
      `;
      ul.appendChild(li);
    });
    
    updateCaseInfo();
  }

  window.deleteLog = (id) => {
    const logs = getLogs();
    const idx = logs.findIndex(r => r.id === id);
    if (idx !== -1) {
      logs.splice(idx, 1);
      save();
      render();
      updateStats();
      updateCriticalStats();
    }
  };

  /* --- Tag Buttons --- */
  function renderTagButtons() {
    const box = document.getElementById('tagButtons');
    box.innerHTML = '';
    const cats = {
      'ğŸš‘ å…ˆè¡Œæ•‘æ€¥éšŠ': ["å…ˆè¡Œæ•‘æ€¥éšŠç¾ç€", "å…ˆè¡Œæ•‘æ€¥éšŠæ¥è§¦", "å…ˆè¡Œæ•‘æ€¥éšŠè»Šå†…åå®¹", "å…ˆè¡Œæ•‘æ€¥éšŠç¾ç™º", "å…ˆè¡Œæ•‘æ€¥éšŠç—…ç€"],
      'ğŸš ãƒ˜ãƒª': ["ãƒ˜ãƒªå‡ºå‹•", "ãƒ˜ãƒªç¾ç€", "ãƒ˜ãƒªDræ¥è§¦", "ãƒ˜ãƒªRPç€"],
      'ğŸš— Dr Car': ["Dr Carå‡ºå‹•", "Dr Carç¾ç€", "Dr Caræ¥è§¦", "Dr Carç¾ç™º", "Dr Carç—…ç€"]
    };
    Object.entries(cats).forEach(([cat, tags]) => {
      const h = document.createElement('div');
      h.style.cssText = 'width:100%;font-weight:700;font-size:10px;margin:6px 0 2px;border-left:3px solid #3498db;padding-left:4px;';
      h.textContent = cat;
      box.appendChild(h);
      tags.forEach(tag => {
        const b = document.createElement('button');
        b.className = 'btn';
        b.textContent = tag;
        b.onclick = async () => {
          const addr = await fetchAddressFromGPS();
          addLine(tag, addr, false);
        };
        box.appendChild(b);
      });
    });
  }

  /* --- Wake Lock --- */
  class EnhancedWakeLock {
    constructor() {
      this.wakeLock = null;
      this.noSleepVideo = null;
      this.silentAudioCtx = null;
      this.setupNoSleepVideo();
    }
    setupNoSleepVideo() {
      this.noSleepVideo = document.createElement('video');
      this.noSleepVideo.setAttribute('playsinline', '');
      this.noSleepVideo.setAttribute('muted', '');
      this.noSleepVideo.setAttribute('loop', '');
      this.noSleepVideo.src = 'data:video/mp4;base64,AAAAIGZ0eXBpc29tAAACAGlzb21pc28yYXZjMW1wNDEAAAAIZnJlZQAAAAhtZGF0AAAA1m1vb3YAAABsbXZoZAAAAAAAAAAAAAAAAAAAA+gAAAAAAAEAAAEAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIAAABidWR0YQAAAFptZXRhAAAAAAAAACFoZGxyAAAAAAAAAABtZGlyYXBwbAAAAAAAAAAAAAAAAC1pbHN0AAAAJal0b28AAAAdZGF0YQAAAAEAAAAATGF2ZjU2LjQwLjEwMQ==';
      this.noSleepVideo.style.cssText = 'position:fixed;top:0;left:0;width:1px;height:1px;opacity:0;';
      document.body.appendChild(this.noSleepVideo);
    }
    startSilentAudio() {
      if (!this.silentAudioCtx) this.silentAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
      if (this.silentAudioCtx.state === 'suspended') this.silentAudioCtx.resume();
      const osc = this.silentAudioCtx.createOscillator();
      const g = this.silentAudioCtx.createGain();
      osc.connect(g);
      g.connect(this.silentAudioCtx.destination);
      osc.frequency.value = 440;
      g.gain.value = 0.001;
      osc.start();
    }
    async request() {
      if (!document.getElementById('keepScreenOn').checked) return;
      if ('wakeLock' in navigator) {
        try {
          this.wakeLock = await navigator.wakeLock.request('screen');
        } catch (e) { console.error('WakeLock API failed:', e); }
      }
      try {
        await this.noSleepVideo.play();
      } catch (e) { console.warn('Video play for NoSleep failed:', e); }
      try {
        this.startSilentAudio();
      } catch (e) { console.warn('Silent audio for NoSleep failed:', e); }
    }
    async release() {
      if (this.wakeLock) {
        try { this.wakeLock.release(); } catch (e) {}
        this.wakeLock = null;
      }
      this.noSleepVideo.pause();
      if (this.silentAudioCtx) {
        try { this.silentAudioCtx.close(); } catch (e) {}
        this.silentAudioCtx = null;
      }
    }
  }
  const enhancedWakeLock = new EnhancedWakeLock();

  /* --- Voice Recognition --- */
  class VoiceRec {
    constructor() {
      this.rec = null;
      this.isRec = false;
      this.timer = null;
    }
    async start() {
      try {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
             throw new Error('getUserMedia not supported in this browser.');
        }
        await navigator.mediaDevices.getUserMedia({ audio: true });
        
        const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!Speech) throw new Error('Speech Recognition API not available.');
        
        if (this.rec) {
            try { this.rec.stop(); } catch(e) {}
        }
        
        this.rec = new Speech();
        this.rec.lang = 'ja-JP';
        this.rec.continuous = true;
        this.rec.interimResults = true;
        this.rec.endSilenceTimeout = 2.0;
        this.rec.maxAlternatives = 1;

        this.rec.onresult = (e) => {
          let interim = '';
          for (let i = e.resultIndex; i < e.results.length; i++) {
            if (e.results[i].isFinal) {
              const t = e.results[i][0].transcript;
              const useAI = document.getElementById('useAI').checked;
              addLine(t, '', useAI);
              document.getElementById('voiceStatusText').textContent = 'ç¢ºå®š: ' + t.substring(0, 8) + '...';
              feedback.playBeep(600, 50);
            } else {
              interim += e.results[i][0].transcript;
            }
          }
          document.getElementById('voiceInterim').textContent = interim;
        };
        this.rec.onend = () => {
          if (this.isRec) {
            this.rec.start();
          }
        };
        this.rec.onerror = (e) => {
             console.error('Speech Recognition Error:', e);
             if (e.error === 'not-allowed') {
                this.stop();
                document.getElementById('permissionAlert').classList.add('show');
             } else if (e.error !== 'no-speech') {
                 this.stop();
                 if (this.isRec) this.start();
             }
        };
        
        this.rec.start();
        this.isRec = true;
        enhancedWakeLock.request();
        document.getElementById('voiceBtn').classList.add('active');
        document.getElementById('voiceStatusTitle').textContent = 'éŒ²éŸ³ä¸­';
        document.getElementById('voiceStatusText').textContent = 'éŸ³å£°ã‚’èªè­˜ã—ã¦ã„ã¾ã™...';
        document.getElementById('recordingIndicator').classList.add('show');
        this.startTimer();
        feedback.playBeep(1000, 100);
        document.getElementById('permissionAlert').classList.remove('show');
      } catch (e) {
        showSystemStatus('ãƒã‚¤ã‚¯èµ·å‹•ã‚¨ãƒ©ãƒ¼: ' + e.message.substring(0, 50) + '...', 'error');
        if (e.message.includes('permission')) {
            document.getElementById('permissionAlert').classList.add('show');
        }
        this.stop();
      }
    }
    stop() {
      this.isRec = false;
      if (this.rec) {
        try {
          this.rec.onend = null;
          this.rec.stop();
        } catch(e) {}
      }
      enhancedWakeLock.release();
      document.getElementById('voiceBtn').classList.remove('active');
      document.getElementById('voiceStatusTitle').textContent = 'åœæ­¢ä¸­';
      document.getElementById('voiceStatusText').textContent = 'ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦éŒ²éŸ³é–‹å§‹';
      document.getElementById('voiceInterim').textContent = '';
      document.getElementById('recordingIndicator').classList.remove('show');
      clearInterval(this.timer);
    }
    toggle() {
      if (this.isRec) this.stop();
      else this.start();
    }
    startTimer() {
      const el = document.getElementById('recordingTime');
      let s = 0;
      this.timer = setInterval(() => {
        s++;
        el.textContent = `${Math.floor(s / 60).toString().padStart(2, '0')}:${(s % 60).toString().padStart(2, '0')}`;
        updateAIQueueInfo();
      }, 1000);
    }
  }
  const voiceRec = new VoiceRec();

  /* --- Utils --- */
  function showSystemStatus(msg, type) {
    const el = document.getElementById('systemStatus');
    el.textContent = msg;
    el.className = 'system-status ' + type;
    el.style.display = 'block';
    const duration = (type === 'error' || type === 'warning') ? 5000 : 3000;
    setTimeout(() => el.style.display = 'none', duration);
  }
  
  function updateStats() {
    const logs = getLogs();
    document.getElementById('totalLogs').textContent = logs.length;
    document.getElementById('aiProcessed').textContent = aiStats.processed;
    document.getElementById('aiPending').textContent = aiLimiter.queue.length;
    
    if (logs.length > 1) {
      const timeStrs = logs.map(l => l.time).sort();
      const [h1, m1, s1] = timeStrs[0].split(':').map(Number);
      const [h2, m2, s2] = timeStrs[timeStrs.length - 1].split(':').map(Number);
      
      const totalSeconds1 = h1 * 3600 + m1 * 60 + s1;
      const totalSeconds2 = h2 * 3600 + m2 * 60 + s2;
      
      let diff = totalSeconds2 - totalSeconds1;
      if (diff < 0) {
          diff += 24 * 3600; 
      }
      
      const minutes = Math.floor(diff / 60);
      document.getElementById('totalTime').textContent = minutes + 'åˆ†';
    } else {
      document.getElementById('totalTime').textContent = '0åˆ†';
    }
  }
  
  function shareLogs(addr) {
    const logs = getLogs();
    if (logs.length === 0) {
      alert('è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“');
      return;
    }
    
    const currentCase = cases[currentCaseId];
    const txt = logs.map(l => {
        let line = `${l.time} ${l.text}`;
        if (addr && l.address) {
            line += ` (ğŸ“ ${l.address})`;
        }
        if (l.aiError) {
            line += ` (âŒ AIå‡¦ç†å¤±æ•—)`;
        }
        return line;
    }).join('\n');
    
    const fileName = `${currentCase.name}.txt`;
    
    const blob = new Blob([txt], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = fileName;
    a.style.display = 'none';
    document.body.appendChild(a);
    
    a.click();
    
    setTimeout(() => {
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }, 100);
    
    showSystemStatus('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚ã€Œãƒ•ã‚¡ã‚¤ãƒ«ã€ã‚¢ãƒ—ãƒªã‹ã‚‰å…±æœ‰ã§ãã¾ã™', 'success');
  }
  
  // Edit Modal
  window.openEditModal = (id) => {
    editingLogId = id;
    const row = getLogs().find(r => r.id === id);
    if (row) {
      document.getElementById('editText').value = row.text;
      document.getElementById('editModal').classList.add('show');
    }
  };
  
  document.getElementById('btnSaveEdit').onclick = () => {
    const row = getLogs().find(r => r.id === editingLogId);
    if (row) {
      const newText = document.getElementById('editText').value;
      if (row.text !== newText) {
          row.text = newText;
          row.aiProcessed = false;
          row.aiError = false;
          // ğŸ“Œ NEW v2.8.0: ç·¨é›†å¾Œã«ã‚«ãƒ†ã‚´ãƒªã‚’å†æ¤œå‡º
          row.categories = detectCategory(newText);
          aiLimiter.enqueue(row.id, row.text);
      }
      save();
      render();
      updateCriticalStats();
    }
    document.getElementById('editModal').classList.remove('show');
  };
  
  document.getElementById('btnCancelEdit').onclick = () => document.getElementById('editModal').classList.remove('show');

  /* --- Init --- */
  document.getElementById('voiceBtn').onclick = () => voiceRec.toggle();
  document.getElementById('btnSaveKey').onclick = () => {
    gemini.setKey(document.getElementById('apiKeyInput').value);
  };
  document.getElementById('btnCopy').onclick = () => shareLogs(false);
  document.getElementById('btnCopyAddr').onclick = () => shareLogs(true);
  document.getElementById('btnClear').onclick = () => {
    if (confirm('ç¾åœ¨ã®ã‚±ãƒ¼ã‚¹ã®å…¨ãƒ­ã‚°ã‚’æ¶ˆå»ã—ã¾ã™ã‹?')) {
      cases[currentCaseId].logs = [];
      aiStats.processed = 0;
      aiLimiter.queue = [];
      save();
      render();
      updateStats();
      updateAIQueueInfo();
      updateCriticalStats();
    }
  };

  window.onload = () => {
    load();
    render();
    renderTagButtons();
    document.getElementById('apiKeyInput').value = gemini.key;
    
    updateAIQueueInfo();
    updateStats();
    updateCriticalStats();
    
    setInterval(() => document.getElementById('clock').textContent = nowHHMMSS(), 1000);
  };
</script>
</body>
</html>
